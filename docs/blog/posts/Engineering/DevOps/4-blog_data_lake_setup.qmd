---
title: "Azure VM에 Poetry로 Agent 프로젝트 디펜던시 관리하기"
subtitle: "Python Agent 개발을 위한 Poetry 기반 가상환경 및 패키지 설치"
description: |
  Poetry를 활용하여 Agent 프로젝트의 가상환경을 생성하고 디펜던시를 관리하는 방법을 다룬다.
  프로젝트 초기화부터 pyproject.toml 설정, 그리고 LangChain, FastAPI 등 
  Agent 개발에 필요한 핵심 패키지 설치까지 전 과정을 단계별로 설명한다.
categories:
  - Engineering
  - DevOps
  - Python
  - Poetry
  - Agent
  - Cloud
  - Azure
author: Kwangmin Kim
date: 11/26/2025
format: 
  html:
    code-fold: true
    toc: true
    number-sections: true
draft: False
---
---
title: 01-Data Lake Storage
jupyter: python3
categories:
  - Azure Cloud
---

# 스토리지 계정 생성

Azure Portal에서 Storage Account를 생성합니다.

## 기본 설정

### 프로젝트 세부 정보

![image](./images/01-Data_Lake_Storage/1.png)

**구독(Subscription)**
- 설명: 사용할 Azure 구독을 선택합니다.
- 입력 값: `swlab-test-subs`

**리소스 그룹(Resource Group)**
- 설명: 스토리지 계정을 포함할 리소스 그룹을 선택하거나 새로 만듭니다.
- 입력 값: `rg-aipoc-test-krc-001`

### 인스턴스 세부 정보

**스토리지 계정 이름**
- 설명: 전역적으로 고유한 스토리지 계정 이름을 입력합니다 (3-24자, 소문자와 숫자만 사용 가능).
- 입력 값: `saaipoctestkrc001`

**지역(Region)**
- 설명: 스토리지 계정이 생성될 Azure 데이터 센터 위치를 선택합니다.
- 입력 값: `(Asia Pacific) Korea Central`

**기본 스토리지 유형**
- 설명: 사용할 스토리지 서비스 유형을 선택합니다.
- 입력 값: `Azure Blob Storage 또는 Azure Data Lake Storage Gen 2`
- 참고: 관련 지침을 제공하는 데 도움이 됩니다. 스토리지를 이 리스크 유형으로 제한하지 않습니다.

**기본 워크로드**
- 설명: 빅 데이터 분석을 위해 데이터 레이크를 호스트하는 데 가장 적합한 워크로드와 가장 일치하는 항목을 선택하여 모범 사례를 기반으로 구축된 권장 구성을 가져옵니다. 안제든지 이 구성을 변경할 수 있습니다.
- 입력 값: `빅 데이터 분석`
- 참고: 📊 빅 데이터 분석을 위해 데이터 레이크를 호스트하는 데 가장 적합

**성능(Performance)**
- 설명: 스토리지 계정의 성능 계층을 선택합니다.
  - **표준**: 대부분 시나리오에 권장됨 (범용 v2 계정)
  - **프리미엄**: 짧은 대기 시간이 필요한 경우에 권장됨
- 선택 값: `표준: 대부분 시나리오에 권장됨(범용 v2 계정)`
- 참고: 📊 표준 성능 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.

**중복도(Redundancy)**
- 설명: 데이터 내구성을 위한 복제 전략을 선택합니다.
  - **LRS**: 로컬 중복 스토리지
  - **ZRS**: 영역 중복 스토리지
  - **GRS**: 지역 중복 스토리지
  - **RA-GRS**: 읽기 액세스 지역 중복 스토리지
- 선택 값: `LRS(로컬 중복 스토리지)`
- 참고: 📊 ZRS 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.

## 고급 설정

![image](./images/01-Data_Lake_Storage/2.png)

### 보안

**REST API 작업을 위한 보안 전송 필요**
- 설명: HTTPS를 통한 보안 연결만 허용합니다.
- 선택 값: ☑ 체크됨

**개별 컨테이너에 대한 익명 액세스 허용**
- 설명: 익명 Blob 액세스를 컨테이너 수준에서 허용할지 여부를 설정합니다.
- 선택 값: ☐ 체크 안 됨

**스토리지 계정 키 액세스 사용**
- 설명: 공유 키를 통한 스토리지 계정 액세스를 허용합니다.
- 선택 값: ☑ 체크됨

**Azure Portal에서 Microsoft Entra 인증 기본값 사용**
- 설명: Azure Portal 액세스 시 Microsoft Entra ID를 기본 인증 방법으로 사용합니다.
- 선택 값: ☐ 체크 안 됨

**최소 TLS 버전**
- 설명: 클라이언트에서 요청하는 최소 TLS(전송 계층 보안) 버전을 설정합니다.
- 선택 값: `버전 1.2`

**복사 작업에 대해 허용된 범위(미리 보기)**
- 설명: 데이터 복사 작업의 허용 범위를 지정합니다.
- 선택 값: `모든 스토리지 계정에서`

### 계층 구조 네임스페이스

Data Lake Storage Gen2 엔드포인트로 보안되는 계층 구조 네임스페이스는 파일 및 디렉터리 의미 체계를 사용하고, 빅 데이터 분석 워크로드를 가속화하고, ACL(액세스 제어 목록)을 사용합니다.

**계층 구조 네임스페이스 사용**
- 설명: Data Lake Storage Gen2 엔드포인트를 보안되는 계층 구조 네임스페이스입니다. 파일 및 디렉터리 의미 체계를 사용하고, ACL(액세스 제어 목록)을 사용합니다.
- 선택 값: ☑ 체크됨
- 참고: 📊 계층 구조 네임스페이스 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.

### 액세스 프로토콜

BLOB 및 Data Lake Gen2 엔드포인트는 기본적으로 프로토비전됨

**SFTP 사용**
- 설명: SFTP 프로토콜을 통한 파일 전송을 활성화합니다.
- 선택 값: ☑ 체크됨
- 참고: ℹ️ 로컬 사용자 기능은 SFTP로 활성화됩니다. 스토리지 계정을 만든 후 SFTP 끝점에 액세스할 로컬 사용자 ID를 만듭니다.

**네트워크 파일 시스템 v3 사용**
- 설명: NFS v3 프로토콜을 사용하여 파일 시스템을 마운트합니다.
- 선택 값: ☑ 체크됨

### Blob Storage

**테넌트 간 복제 허용**
- 설명: 다른 Azure AD 테넌트 간 Blob 복제를 허용합니다.
- 선택 값: ☐ 체크 안 됨
- 참고: ℹ️ 테넌트 간 복제 및 계층 구조 네임스페이스를 동시에 사용하도록 설정할 수 없습니다.

**액세스 계층**
- 설명: 데이터 액세스 빈도에 따른 기본 저장소 계층을 선택합니다.
  - **핫**: 자주 액세스하는 데이터 및 일상적인 사용 시나리오에 최적화됨
  - **쿨**: 자주 액세스하지 않는 데이터 및 백업 시나리오에 최적화됨
  - **콜드**: 거의 액세스하지 않는 데이터 및 백업 시나리오에 최적화됨
- 선택 값: `핫`
- 참고: 📊 핫 Blob 액세스 계층 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.

### Azure Files

**큰 파일 공유 사용**
- 설명: 최대 100TiB 용량의 대용량 파일 공유를 지원합니다.
- 선택 값: ☑ 체크됨 (비활성화됨)

## 네트워킹 설정

![image](./images/01-Data_Lake_Storage/3.png)

### 공용 액세스

공용 네트워크를 통해 어디서나 리소스에 액세스합니다.

참고: 공용 네트워크를 통해 리소스에 액세스할 수 있게 되면 보안 위험이 증가합니다.

**공용 네트워크 액세스**
- 설명: 공용 인터넷에서 스토리지 계정에 대한 액세스 권한을 설정합니다.
- 선택 값: `사용`
  - 이 리소스에 대한 리스크 액세스 구성을 사용하여 선택 인바운드 엔드포인트를 제한하는 옵션을 사용하며 인바운드 및 아웃바운드 엔드포인트를 허용합니다.
- 옵션:
  - ⭕ **사용**: 이 리소스에 대한 리스크 액세스 구성을 사용하여 선택 인바운드 엔드포인트를 제한하는 옵션을 사용하며 인바운드 및 아웃바운드 엔드포인트를 허용합니다.
  - ⚪ **사용 안 함**: 아웃바운드 엔드포인트를 허용하면서 인바운드 엔드포인트를 제한합니다.
  - ⚪ **경계로 보호(가장 제한됨)**: 네트워크 보안 경계를 사용하여 인바운드 및 아웃바운드 엔드포인트를 제한합니다. 경계로 보호는 리소스를 보호하기 위해 가장 높은 수준의 인바운드 및 아웃바운드 제한을 제공합니다.

**공용 네트워크 액세스 범위**
- 설명: 공용 네트워크를 통해 액세스할 수 있는 리소스의 범위를 지정합니다.
- 선택 값: `선택한 가상 네트워크 및 IP 주소에서 사용`
- 옵션:
  - ⚪ **모든 네트워크에서 사용**
  - ⭕ **선택한 가상 네트워크 및 IP 주소에서 사용**

### 가상 네트워크

선택한 네트워크만 이 스토리지 계정에 액세스할 수 있습니다.

**가상 네트워크 구독**
- 설명: 가상 네트워크가 속한 Azure 구독을 선택합니다.
- 입력 값: `swlab-test-subs`

**가상 네트워크**
- 설명: 스토리지 계정에 액세스할 수 있는 가상 네트워크를 선택합니다.
- 입력 값: `vnet-aipoc-test-krc-insilico-001`
- 링크: [가상 네트워크 만들기] / [선택한 가상 네트워크 관리]

**서브넷**
- 설명: 가상 네트워크 내에서 액세스를 허용할 서브넷을 선택합니다.
- 입력 값: `subnet-aipoc-test-krc-insilico-001(172.16.0.0/24)`

### IPv4 Addresses

Allow select public internet IP addresses to access your resource.

**허용된 IP 주소**
- 설명: 스토리지 계정에 액세스할 수 있는 공용 IP 주소를 지정합니다.
- 입력 값: `61.74.175.54`

::: {.callout-warning}
## ⚠️ 중요

이 값을 **자신의 로컬 PC Public IP**로 설정을 해 주어야지만, 추후 **Azure Portal을 통해 파일 업로드가 가능**합니다.
::: 

### 프라이빗 엔드포인트

**프라이빗 엔드포인트**
- 설명: 프라이빗 엔드포인트를 만들어 이 리소스에 대한 프라이빗 연결을 허용합니다. 추가 프라이빗 엔드포인트 연결은 스토리지 계정 또는 프라이빗 링크 센터 내에서 만들 수 있습니다.
- 선택 값: [+ 프라이빗 엔드포인트 추가] 클릭 가능
- 상태: 프라이빗 엔드포인트를 만들려면 (추가를 클릭합니다)

### 네트워크 라우팅

트래픽이 원본에서 Azure 엔드포인트로 이동하는 과정에서 트래픽을 라우팅할 방법을 결정하세요. 대부분의 고객의 경우 Microsoft 네트워크 라우팅이 권장됩니다.

**라우팅 기본 설정**
- 설명: 트래픽이 원본에서 Azure 엔드포인트로 이동하는 과정에서 트래픽을 라우팅할 방법을 결정합니다.
- 선택 값: `Microsoft 네트워크 라우팅`
- 옵션:
  - ⭕ **Microsoft 네트워크 라우팅**
  - ⚪ **인터넷 라우팅**

## 데이터 보호 설정

![image](./images/01-Data_Lake_Storage/4.png)

### 복구
- 전부 디폴트 설정으로 진행

**Blob에 일시 삭제 사용**
- 설명: 일시 삭제를 사용하면 덮어쓴 Blob을 포함하여 이전에 삭제로 표시되었던 Blob을 복구할 수 있습니다.
- 선택 값: ☑ 체크됨
- **삭제된 Blob 보존 기간(일)**: `7`

**컨테이너에 일시 삭제 사용**
- 설명: 일시 삭제를 사용하면 이전에 삭제로 표시된 컨테이너를 복구할 수 있습니다.
- 선택 값: ☑ 체크됨
- **삭제된 컨테이너 보존 기간(일)**: `7`
- 참고: 자주 덮어쓰는 데이터에 대해 일시 삭제를 사용하도록 설정하면 스토리지 비용이 증가할 수 있습니다.

**파일 공유에 일시 삭제 사용**
- 설명: 일시 삭제를 사용하면 이전에 삭제로 표시된 파일 공유를 복구할 수 있습니다.
- 선택 값: ☑ 체크됨
- **삭제된 파일 공유 보존 기간(일)**: `7`

### 추적

**Blob에 버전 관리 사용**
- 설명: 버전 관리를 사용하여 Blob의 이전 버전을 자동으로 유지합니다.
- 선택 값: ☐ 체크 안 됨
- 참고: 워크로드, 생성된 버전 수에 미치는 영향, 결과 비용을 고려하세요. 데이터 수명 주기를 자동으로 관리하여 비용을 최적화합니다.

**Blob 변경 피드 사용**
- 설명: 계정의 Blob에 대한 만들기, 수정 및 삭제 변경 내용을 추적합니다.
- 선택 값: ☐ 체크 안 됨

### 액세스 제어

**버전 수준 불변성 지원 사용**
- 설명: 모든 Blob 버전에 적용할 계정 수준에서 시간 기반 보존 정책을 설정할 수 있습니다.
- 선택 값: ☐ 체크 안 됨
- 참고: 계정 수준에서 기본 정책을 설정하려면 이 기능을 사용하여 도록 설정합니다. 이 기능을 사용하지 않고도 컨테이너 수준에서 기본 정책을 설정하거나 특정 Blob 버전에 대한 정책을 설정할 수 있습니다. 이 속성을 사용하려면 버전 관리를 필요합니다.


# 컨테이너 생성 & Blob 파일 업로드

## Azure Portal에서 컨테이너를 생성합니다.
bc-aipoc-test-krc001 이름의 컨테이너가 이미 존재하여 생성되지 않지만 아래와 같은 방법으로 컨테이너를 생성할 수 있습니다.
![image](./images/01-Data_Lake_Storage/5.png)

## 디렉터리 추가 
컨테이너 내부로 접속하여 디렉터리를 추가할 수 있습니다.
::: {.callout-important}
## ⚠️ 주의사항

네트워크 설정 중 **Public network access**가 **Enabled from selected networks**로 설정되어 있어야 합니다.

`Disable` 또는 `Secured by perimeter(Most restricted)`로 설정되어 있으면 **컨테이너 내부로 접속할 수 없습니다**.
:::

폴더 구조는 아래와 같은 구조로 되어있습니다. 
```
rag-container
 ├─ code
 │   ├─ moduleA
 │   ├─ moduleB
 │   └─ moduleC
 └─ docs
     ├─ moduleA
     ├─ moduleB
     └─ moduleC
```
## Blob 파일을 업로드합니다.

![image](./images/01-Data_Lake_Storage/6.png)
업로드 버튼을 이용해서 미리 다운로드 받은 코드 파일을 업로드합니다.

# VM 내부에서 Blob 파일 접근


vm 내부에 접속 후 아래와 같은 작업을 통해 영구적으로 Blob 파일에 마운트를 할 수 있습니다.

Azure nfs 패키지를 설치합니다.
```
sudo apt-get update
sudo apt-get install nfs-common
```


fstab 파일에 아래와 같이 추가합니다.
```
sudo vi /etc/fstab

saaipoctestkrc001.blob.core.windows.net:/saaipoctestkrc001/bc-aipoc-test-krc001 /mnt/bc-aipoc-test-krc001 aznfs defaults,sec=sys,vers=3,nolock,proto=tcp,nofail,_netdev    0 0
```
saaipoctestkrc001 : Storage Account 이름
bc-aipoc-test-krc001 : Container 이름
/mnt/bc-aipoc-test-krc001 : 마운트 폴더
aznfs : Azure NFS 패키지
defaults,sec=sys,vers=3,nolock,proto=tcp,nofail,_netdev : NFS 패키지 설정
0 0 : 마운트 설정

마운트를 합니다.
```
sudo mount -a
```