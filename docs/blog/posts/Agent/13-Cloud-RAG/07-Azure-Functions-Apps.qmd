---
title: "Azure Functions Apps"
subtitle: ì„œë²„ë¦¬ìŠ¤ RAG ë°°í¬
description: |
  Azure Functionsë¥¼ í™œìš©í•œ RAG ì‹œìŠ¤í…œ ì„œë²„ë¦¬ìŠ¤ ë°°í¬ ë° HTTP API êµ¬í˜„ ë°©ë²•ì„ ë‹¤ë£¬ë‹¤.
categories:
  - AI
  - RAG
  - Azure
author: Kwangmin Kim
date: 11/08/2025
format: 
  html:
    page-layout: full
    code-fold: true
    toc: true
    number-sections: true
draft: False
execute:
    eval: false
---

## Azure Functionsë€?

Azure FunctionsëŠ” ì„œë²„ë¦¬ìŠ¤ ì»´í“¨íŒ… í”Œë«í¼ìœ¼ë¡œ, ì¸í”„ë¼ ê´€ë¦¬ ì—†ì´ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

**ì„œë²„ë¦¬ìŠ¤ ì¥ì :**
- ì¸í”„ë¼ ê´€ë¦¬ ë¶ˆí•„ìš”
- ìë™ ìŠ¤ì¼€ì¼ë§
- ì‚¬ìš©í•œ ë§Œí¼ë§Œ ê³¼ê¸ˆ
- ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹¤í–‰

**RAG ì‹œìŠ¤í…œ ë°°í¬ì— ì í•©í•œ ê²½ìš°:**
- ê°„í—ì ì¸ ìš”ì²­ (ì¼ 100~1000ê±´)
- íŠ¸ë˜í”½ ë³€ë™ì´ í¼
- ë¹ ë¥¸ ë°°í¬ í•„ìš”
- ë¹„ìš© ìµœì í™” ì¤‘ìš”

## Azure Functions vs Container Apps

| í•­ëª© | Azure Functions | Container Apps |
|------|----------------|----------------|
| **ì•„í‚¤í…ì²˜** | ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ | ì»¨í…Œì´ë„ˆ ê¸°ë°˜ |
| **í™•ì¥** | ìë™ (ì´ˆ ë‹¨ìœ„) | ìë™ (ë¶„ ë‹¨ìœ„) |
| **Cold Start** | ìˆìŒ (3-5ì´ˆ) | ìˆìŒ (1-2ì´ˆ) |
| **ìµœëŒ€ ì‹¤í–‰ ì‹œê°„** | 10ë¶„ | ë¬´ì œí•œ |
| **ë¹„ìš©** | ì‹¤í–‰ ì‹œê°„ ê¸°ë°˜ | vCPU/ë©”ëª¨ë¦¬ ê¸°ë°˜ |
| **ê¶Œì¥ ì‚¬ìš©** | ê°„í—ì  ìš”ì²­ | ì§€ì†ì  ì„œë¹„ìŠ¤ |

**Azure Functions ê¶Œì¥**: íŠ¸ë˜í”½ì´ ì ê±°ë‚˜ ë¶ˆê·œì¹™í•œ ê²½ìš°
**Container Apps ê¶Œì¥**: ì§€ì†ì ì¸ íŠ¸ë˜í”½, WebSocket í•„ìš”

## í™˜ê²½ ì„¤ì •

### Azure Functions Core Tools ì„¤ì¹˜

**Windows (PowerShell):**
```powershell
# Chocolateyë¡œ ì„¤ì¹˜
choco install azure-functions-core-tools-4

# ë˜ëŠ” npmìœ¼ë¡œ ì„¤ì¹˜
npm install -g azure-functions-core-tools@4
```

**macOS:**
```bash
brew tap azure/functions
brew install azure-functions-core-tools@4
```

**Linux:**
```bash
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install azure-functions-core-tools-4
```

### Python í™˜ê²½

```bash
# Python 3.9, 3.10, 3.11 ì§€ì›
python --version

# ê°€ìƒí™˜ê²½ ìƒì„±
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
.venv\Scripts\activate     # Windows

# í•„ìˆ˜ íŒ¨í‚¤ì§€
pip install azure-functions
pip install langchain-openai
pip install langchain-community
pip install azure-search-documents
pip install python-dotenv
```

## Functions í”„ë¡œì íŠ¸ ìƒì„±

### í”„ë¡œì íŠ¸ ì´ˆê¸°í™”

```bash
# ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
func init rag-function-app --python

cd rag-function-app

# HTTP íŠ¸ë¦¬ê±° í•¨ìˆ˜ ìƒì„±
func new --name rag-query --template "HTTP trigger" --authlevel "function"
```

**ìƒì„±ëœ êµ¬ì¡°:**
```
rag-function-app/
â”œâ”€â”€ rag-query/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ function.json
â”œâ”€â”€ host.json
â”œâ”€â”€ local.settings.json
â””â”€â”€ requirements.txt
```

### requirements.txt

```txt
azure-functions
langchain-openai
langchain-community
azure-search-documents
python-dotenv
tiktoken
```

### local.settings.json

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "",
    "FUNCTIONS_WORKER_RUNTIME": "python",
    "AZURE_OPENAI_ENDPOINT": "https://openai-rag-prod.openai.azure.com/",
    "AZURE_OPENAI_API_KEY": "your-key",
    "AZURE_OPENAI_DEPLOYMENT": "gpt-4o",
    "AZURE_OPENAI_API_VERSION": "2024-02-01",
    "AZURE_SEARCH_ENDPOINT": "https://search-rag-prod.search.windows.net",
    "AZURE_SEARCH_API_KEY": "your-key",
    "AZURE_SEARCH_INDEX_NAME": "rag-documents"
  }
}
```

## RAG í•¨ìˆ˜ êµ¬í˜„

### rag-query/__init__.py

```python
import azure.functions as func
import logging
import json
import os
from langchain_openai import AzureOpenAIEmbeddings, AzureChatOpenAI
from langchain_community.vectorstores.azuresearch import AzureSearch
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
AZURE_OPENAI_ENDPOINT = os.getenv("AZURE_OPENAI_ENDPOINT")
AZURE_OPENAI_API_KEY = os.getenv("AZURE_OPENAI_API_KEY")
AZURE_OPENAI_DEPLOYMENT = os.getenv("AZURE_OPENAI_DEPLOYMENT")
AZURE_OPENAI_API_VERSION = os.getenv("AZURE_OPENAI_API_VERSION")
AZURE_SEARCH_ENDPOINT = os.getenv("AZURE_SEARCH_ENDPOINT")
AZURE_SEARCH_API_KEY = os.getenv("AZURE_SEARCH_API_KEY")
AZURE_SEARCH_INDEX_NAME = os.getenv("AZURE_SEARCH_INDEX_NAME")

# ì „ì—­ ì´ˆê¸°í™” (Cold Start ìµœì í™”)
embeddings = None
vector_store = None
llm = None
rag_chain = None

def init_rag_components():
    """RAG ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ì‹¤í–‰)"""
    global embeddings, vector_store, llm, rag_chain
    
    if rag_chain is not None:
        return  # ì´ë¯¸ ì´ˆê¸°í™”ë¨
    
    logging.info("RAG ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì¤‘...")
    
    # Embeddings
    embeddings = AzureOpenAIEmbeddings(
        azure_deployment="text-embedding-3-small",
        openai_api_version=AZURE_OPENAI_API_VERSION,
        azure_endpoint=AZURE_OPENAI_ENDPOINT,
        api_key=AZURE_OPENAI_API_KEY
    )
    
    # Vector Store
    vector_store = AzureSearch(
        azure_search_endpoint=AZURE_SEARCH_ENDPOINT,
        azure_search_key=AZURE_SEARCH_API_KEY,
        index_name=AZURE_SEARCH_INDEX_NAME,
        embedding_function=embeddings.embed_query
    )
    
    # LLM
    llm = AzureChatOpenAI(
        azure_deployment=AZURE_OPENAI_DEPLOYMENT,
        openai_api_version=AZURE_OPENAI_API_VERSION,
        azure_endpoint=AZURE_OPENAI_ENDPOINT,
        api_key=AZURE_OPENAI_API_KEY,
        temperature=0
    )
    
    # Retriever
    retriever = vector_store.as_retriever(search_kwargs={"k": 3})
    
    # Prompt
    prompt = ChatPromptTemplate.from_template(
        """ë‹¤ìŒ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”.

ì»¨í…ìŠ¤íŠ¸:
{context}

ì§ˆë¬¸: {question}

ë‹µë³€:"""
    )
    
    # RAG Chain
    def format_docs(docs):
        return "\n\n".join([doc.page_content for doc in docs])
    
    rag_chain = (
        {"context": retriever | format_docs, "question": RunnablePassthrough()}
        | prompt
        | llm
        | StrOutputParser()
    )
    
    logging.info("RAG ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ")

def main(req: func.HttpRequest) -> func.HttpResponse:
    """HTTP íŠ¸ë¦¬ê±° í•¨ìˆ˜"""
    logging.info('RAG ì¿¼ë¦¬ ìš”ì²­ ìˆ˜ì‹ ')
    
    try:
        # RAG ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
        init_rag_components()
        
        # ìš”ì²­ íŒŒì‹±
        try:
            req_body = req.get_json()
            question = req_body.get('question')
        except ValueError:
            question = req.params.get('question')
        
        if not question:
            return func.HttpResponse(
                json.dumps({"error": "ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"}),
                mimetype="application/json",
                status_code=400
            )
        
        # RAG ì‹¤í–‰
        logging.info(f"ì§ˆë¬¸: {question}")
        answer = rag_chain.invoke(question)
        
        # ì‘ë‹µ ë°˜í™˜
        response = {
            "question": question,
            "answer": answer,
            "status": "success"
        }
        
        return func.HttpResponse(
            json.dumps(response, ensure_ascii=False),
            mimetype="application/json",
            status_code=200
        )
    
    except Exception as e:
        logging.error(f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return func.HttpResponse(
            json.dumps({"error": str(e)}),
            mimetype="application/json",
            status_code=500
        )
```

### function.json

```json
{
  "scriptFile": "__init__.py",
  "bindings": [
    {
      "authLevel": "function",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": [
        "get",
        "post"
      ]
    },
    {
      "type": "http",
      "direction": "out",
      "name": "$return"
    }
  ]
}
```

## ë¡œì»¬ í…ŒìŠ¤íŠ¸

### ë¡œì»¬ ì‹¤í–‰

```bash
# Functions ì•± ì‹œì‘
func start
```

ì¶œë ¥:
```
Functions:
        rag-query: [GET,POST] http://localhost:7071/api/rag-query
```

### cURL í…ŒìŠ¤íŠ¸

```bash
# POST ìš”ì²­
curl -X POST http://localhost:7071/api/rag-query \
  -H "Content-Type: application/json" \
  -d '{"question": "Azure AI Searchë€ ë¬´ì—‡ì¸ê°€?"}'

# GET ìš”ì²­
curl "http://localhost:7071/api/rag-query?question=Azure+AI+Searchë€+ë¬´ì—‡ì¸ê°€?"
```

### Pythonìœ¼ë¡œ í…ŒìŠ¤íŠ¸

```python
import requests
import json

url = "http://localhost:7071/api/rag-query"
data = {"question": "Azure AI Searchë€ ë¬´ì—‡ì¸ê°€?"}

response = requests.post(url, json=data)
result = response.json()

print(f"ì§ˆë¬¸: {result['question']}")
print(f"ë‹µë³€: {result['answer']}")
```

## Azure ë°°í¬

### Function App ë¦¬ì†ŒìŠ¤ ìƒì„±

```bash
# ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„±
az group create --name rg-rag-prod --location koreacentral

# Storage Account ìƒì„± (Functions í•„ìˆ˜)
az storage account create \
  --name stragprod \
  --resource-group rg-rag-prod \
  --location koreacentral \
  --sku Standard_LRS

# Function App ìƒì„± (Python 3.11)
az functionapp create \
  --resource-group rg-rag-prod \
  --consumption-plan-location koreacentral \
  --runtime python \
  --runtime-version 3.11 \
  --functions-version 4 \
  --name func-rag-prod \
  --storage-account stragprod \
  --os-type Linux
```

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```bash
# Application Settings ì„¤ì •
az functionapp config appsettings set \
  --name func-rag-prod \
  --resource-group rg-rag-prod \
  --settings \
    AZURE_OPENAI_ENDPOINT="https://openai-rag-prod.openai.azure.com/" \
    AZURE_OPENAI_API_KEY="your-key" \
    AZURE_OPENAI_DEPLOYMENT="gpt-4o" \
    AZURE_OPENAI_API_VERSION="2024-02-01" \
    AZURE_SEARCH_ENDPOINT="https://search-rag-prod.search.windows.net" \
    AZURE_SEARCH_API_KEY="your-key" \
    AZURE_SEARCH_INDEX_NAME="rag-documents"
```

### ë°°í¬

```bash
# Azureì— ë°°í¬
func azure functionapp publish func-rag-prod

# ë°°í¬ ì™„ë£Œ í›„ URL í™•ì¸
# https://func-rag-prod.azurewebsites.net/api/rag-query
```

### ë°°í¬ í…ŒìŠ¤íŠ¸

```bash
# Function Key ì¡°íšŒ
FUNCTION_KEY=$(az functionapp keys list \
  --name func-rag-prod \
  --resource-group rg-rag-prod \
  --query "functionKeys.default" -o tsv)

# API í˜¸ì¶œ
curl -X POST https://func-rag-prod.azurewebsites.net/api/rag-query?code=$FUNCTION_KEY \
  -H "Content-Type: application/json" \
  -d '{"question": "Azure AI Searchë€?"}'
```

## Cold Start ìµœì í™”

### Premium Plan

Consumption Planì˜ Cold Startë¥¼ ê°œì„ í•˜ë ¤ë©´ Premium Planìœ¼ë¡œ ë³€ê²½í•œë‹¤.

```bash
# Premium Plan ìƒì„±
az functionapp plan create \
  --resource-group rg-rag-prod \
  --name plan-rag-premium \
  --location koreacentral \
  --sku EP1 \
  --is-linux

# Function Appì„ Premium Planìœ¼ë¡œ ë³€ê²½
az functionapp update \
  --name func-rag-prod \
  --resource-group rg-rag-prod \
  --plan plan-rag-premium
```

**Premium Plan ì¥ì :**
- Always-on (Cold Start ì—†ìŒ)
- VNET í†µí•©
- ë” ë§ì€ ë©”ëª¨ë¦¬/CPU

**ë¹„ìš©**: ~$146/ì›” (EP1)

### ì»´í¬ë„ŒíŠ¸ ì¬ì‚¬ìš©

ì „ì—­ ë³€ìˆ˜ë¡œ ì»´í¬ë„ŒíŠ¸ë¥¼ ìºì‹±í•˜ì—¬ ì¬ì´ˆê¸°í™”ë¥¼ ë°©ì§€í•œë‹¤.

```python
# ì „ì—­ ì´ˆê¸°í™” (í•¨ìˆ˜ ì™¸ë¶€)
embeddings = None
vector_store = None

def init_components():
    global embeddings, vector_store
    if embeddings is None:
        embeddings = AzureOpenAIEmbeddings(...)
        vector_store = AzureSearch(...)
```

## ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ

Azure FunctionsëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë°ì„ ì§€ì›í•˜ì§€ ì•Šì§€ë§Œ, Server-Sent Events (SSE)ë¡œ êµ¬í˜„ ê°€ëŠ¥í•˜ë‹¤.

### SSE í•¨ìˆ˜

```python
import asyncio

async def main(req: func.HttpRequest) -> func.HttpResponse:
    """ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ"""
    question = req.get_json().get('question')
    
    async def generate():
        yield "data: " + json.dumps({"type": "start"}) + "\n\n"
        
        # ìŠ¤íŠ¸ë¦¬ë° ì‹¤í–‰
        async for chunk in streaming_llm.astream(question):
            yield "data: " + json.dumps({
                "type": "chunk",
                "content": chunk.content
            }) + "\n\n"
        
        yield "data: " + json.dumps({"type": "end"}) + "\n\n"
    
    return func.HttpResponse(
        generate(),
        mimetype="text/event-stream"
    )
```

## ëª¨ë‹ˆí„°ë§

### Application Insights

Application InsightsëŠ” ìë™ìœ¼ë¡œ í™œì„±í™”ëœë‹¤.

**ë¡œê·¸ í™•ì¸:**
```bash
# Azure Portalì—ì„œ í™•ì¸
# Function App â†’ Application Insights â†’ Logs

# ì˜ˆì‹œ ì¿¼ë¦¬
traces
| where message contains "RAG"
| order by timestamp desc
| take 100
```

### ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­

```python
from applicationinsights import TelemetryClient

tc = TelemetryClient(os.getenv("APPINSIGHTS_INSTRUMENTATIONKEY"))

def main(req: func.HttpRequest) -> func.HttpResponse:
    start_time = time.time()
    
    # RAG ì‹¤í–‰
    answer = rag_chain.invoke(question)
    
    # ë©”íŠ¸ë¦­ ì „ì†¡
    duration = time.time() - start_time
    tc.track_metric("RAGQueryDuration", duration)
    tc.track_event("RAGQuery", {"question_length": len(question)})
    tc.flush()
    
    return func.HttpResponse(...)
```

## CORS ì„¤ì •

ì›¹ ì•±ì—ì„œ APIë¥¼ í˜¸ì¶œí•˜ë ¤ë©´ CORS ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.

```bash
# CORS í—ˆìš©
az functionapp cors add \
  --name func-rag-prod \
  --resource-group rg-rag-prod \
  --allowed-origins "https://your-app.com"

# ëª¨ë“  ì˜¤ë¦¬ì§„ í—ˆìš© (ê°œë°œ í™˜ê²½)
az functionapp cors add \
  --name func-rag-prod \
  --resource-group rg-rag-prod \
  --allowed-origins "*"
```

## ë³´ì•ˆ

### Managed Identity

API í‚¤ ëŒ€ì‹  Managed Identityë¥¼ ì‚¬ìš©í•œë‹¤.

```bash
# Managed Identity í™œì„±í™”
az functionapp identity assign \
  --name func-rag-prod \
  --resource-group rg-rag-prod

# Azure OpenAIì— ê¶Œí•œ ë¶€ì—¬
az role assignment create \
  --assignee <managed-identity-principal-id> \
  --role "Cognitive Services OpenAI User" \
  --scope <azure-openai-resource-id>
```

### Key Vault í†µí•©

```bash
# Key Vault ìƒì„±
az keyvault create \
  --name kv-rag-prod \
  --resource-group rg-rag-prod \
  --location koreacentral

# ë¹„ë°€ ì €ì¥
az keyvault secret set \
  --vault-name kv-rag-prod \
  --name "AzureOpenAIKey" \
  --value "your-key"

# Function Appì—ì„œ ì°¸ì¡°
az functionapp config appsettings set \
  --name func-rag-prod \
  --resource-group rg-rag-prod \
  --settings \
    AZURE_OPENAI_API_KEY="@Microsoft.KeyVault(SecretUri=https://kv-rag-prod.vault.azure.net/secrets/AzureOpenAIKey/)"
```

## ë¹„ìš© ìµœì í™”

### Consumption Plan ë¹„ìš©

**ê³„ì‚°ì‹:**
- ì‹¤í–‰ ì‹œê°„: $0.000016/GB-ì´ˆ
- ìš”ì²­: $0.20/100ë§Œ ìš”ì²­

**ì˜ˆì‹œ** (ì›” 10,000 ìš”ì²­, ê° 5ì´ˆ, 1.5GB ë©”ëª¨ë¦¬):
- ì‹¤í–‰ ë¹„ìš©: 10,000 Ã— 5ì´ˆ Ã— 1.5GB Ã— $0.000016 = $1.20
- ìš”ì²­ ë¹„ìš©: 10,000 / 1,000,000 Ã— $0.20 = $0.002
- **ì´ ë¹„ìš©**: ~$1.20/ì›”

**ë¬´ë£Œ í• ë‹¹ëŸ‰:**
- ë§¤ì›” 400,000 GB-ì´ˆ ë¬´ë£Œ
- ë§¤ì›” 1,000,000 ìš”ì²­ ë¬´ë£Œ

## ì°¸ê³  ìë£Œ

### ê³µì‹ ë¬¸ì„œ
- [Azure Functions Python](https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-python)
- [Functions ê°€ê²©](https://azure.microsoft.com/en-us/pricing/details/functions/)

## ë‹¤ìŒ ë‹¨ê³„

ì„œë²„ë¦¬ìŠ¤ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´, ì´ì œ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ë°°í¬ë¥¼ ì‚´í´ë³´ì:

ğŸ‘‰ [08-Azure-Container-Apps.qmd](./08-Azure-Container-Apps.qmd) - Azure Container Appsë¥¼ í™œìš©í•œ ì»¨í…Œì´ë„ˆ ë°°í¬