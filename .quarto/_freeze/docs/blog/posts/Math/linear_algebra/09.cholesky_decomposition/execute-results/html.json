{
  "hash": "01ce86a8491b7235f522f4766951b5a2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Multivariate Normal Distribution & Cholesky Decomposition\"\nsubtitle: ' '\ndescription: |\n  zsd.\ncategories:\n  - Mathematics\nauthor: Kwangmin Kim\ndate: 06/02/2023\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\nexecute:\n  warning: false\n  meassage: false\ndraft: False\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mosaic)\nlibrary(mvtnorm)\n```\n:::\n\n\n# Sampling from Multivariate Normal Distribution\n\nmvtnorm packcage의 rmvnnorm() 이용하는데 rmvnnorm()는 mean vector와 covariance matrix를 arguments로 받는다\n\n$$\n\\mu =\\begin{bmatrix} 1 // 3// 3 \\end{bmatrix} \\quadd \\Sigma =\\begin{bmatrix} 4 & -2 & 1 \\\\ -2 & 3 & -1 \\\\ 1 & -1 & 2 \\end{bmatrix}\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_vector <- c(1,3,2)\ncov_matrix <- matrix(c(4,-2,1,-2,3,-1,1,-1,2),ncol=3,byrow=TRUE)\nmvt_samples <-rmvnorm(n=1000, mean=mean_vector, sigma= cov_matrix)\nhead(mvt_samples)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           [,1]     [,2]       [,3]\n[1,]  4.4869658 3.030159 4.67816437\n[2,]  0.5592161 3.463043 0.07191552\n[3,]  2.9050201 1.574084 2.76467551\n[4,]  1.0514904 2.453634 3.42095769\n[5,]  2.6797795 2.563215 1.30291275\n[6,] -1.0575519 2.818377 2.78552320\n```\n\n\n:::\n\n```{.r .cell-code}\n# mean vector와 variance vector 확인하는 시각화\nmvt_samples[,1]%>%hist()\n```\n\n::: {.cell-output-display}\n![](09.cholesky_decomposition_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\nmvt_samples[,2]%>%hist()\n```\n\n::: {.cell-output-display}\n![](09.cholesky_decomposition_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n\n```{.r .cell-code}\nmvt_samples[,3]%>%hist()\n```\n\n::: {.cell-output-display}\n![](09.cholesky_decomposition_files/figure-html/unnamed-chunk-2-3.png){width=672}\n:::\n\n```{.r .cell-code}\necdf(mvt_samples[,1])%>%plot() #empirical cdf\ny<-pnorm(seq(-5,7,by=0.01),mean=1, sd=2) # get cdf  points\npoints(seq(-5,7,by=0.01),y,col='red') # marginal cdf\n```\n\n::: {.cell-output-display}\n![](09.cholesky_decomposition_files/figure-html/unnamed-chunk-2-4.png){width=672}\n:::\n:::\n\n\n## 첫째로 표본 공분산 행렬, cov(mvt_samples) 추정\n\n$$\nS=\\frac{1}{n-1} \\tilde{X}^T\\tilde{X}\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# covariance matrix 확인하는 시각화\n## 첫째로 표본 공분산 행렬, cov(mvt_samples) 추정\ncentered_X <- scale(mvt_samples, center =T, scale =F)\n1/(1000-1) * t(centered_X) %*% centered_X\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]      [,2]      [,3]\n[1,]  4.045013 -1.954612  1.066679\n[2,] -1.954612  3.085236 -1.001373\n[3,]  1.066679 -1.001373  2.065063\n```\n\n\n:::\n\n```{.r .cell-code}\ncov(mvt_samples)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]      [,2]      [,3]\n[1,]  4.045013 -1.954612  1.066679\n[2,] -1.954612  3.085236 -1.001373\n[3,]  1.066679 -1.001373  2.065063\n```\n\n\n:::\n:::\n\n\n## 난수 발생 원리\n\n### Cholesky Decomposition\n\ncholesky decomposition 또는 촐레스키 인수분해는 선형대수학에서 사용되는 중요한 알고리즘 중 하나로 이는 양의 정부호 행렬을 lower triangular matrix와 그 행렬의 전치 행렬의 곱으로 분해하는 방법이다. 양의 정부호 대칭 행렬 $\\mathbf{A}$ 에 대하여 촐레스키 분해는 다음과 같이 정의 된다. 수의 제곱근을 구하는 개념에 대응시켜서 이해하면 편하다.\n\n$$\n\\mathbf{A} = LL^T\n$$\n\n여기서 L은 하삼각행렬을 나타낸다. 촐레스키 분해는 행렬 A가 양의 정부호 임을 전제로 한다. 촐레스키 분해로 A를 하삼각행렬의 곱으로 정보를 압축할 수 있다.\n촐레스키 분해는 통계학, 수치해석학, 머신러닝 등에서 사용되는데 가장 대표적인 예가 다변수 정규분포의 표본을 생성하는 것이다. system of linear equation의 해를 구할 때도 사용된다. \n\n### 촐레스키 분해 구현\n\n`chol()` 함수를 이용해 촐레스키 분해를 수행할 수 있다. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# define a positive matrix\ncov_matrix\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     [,1] [,2] [,3]\n[1,]    4   -2    1\n[2,]   -2    3   -1\n[3,]    1   -1    2\n```\n\n\n:::\n\n```{.r .cell-code}\nupper_triangular_matrix<-chol(cov_matrix)\nlower_triangular_matrix<-t(upper_triangular_matrix)\n\n# verify the decomposition\nlower_triangular_matrix%*%t(lower_triangular_matrix)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     [,1] [,2] [,3]\n[1,]    4   -2    1\n[2,]   -2    3   -1\n[3,]    1   -1    2\n```\n\n\n:::\n:::\n\n\n모든 공분산 행렬은 positive semi definite인데 `cov_matrix`의 모든 대각원소가 양수이기 때문에 positive definite matrix가 된다.\n\n촐레스키 분해는 multivariate normal distribution에서 sampling하여 난수를 발생시키는 원리를 이해하는데 도움이 된다.\n\n### 촐레스키 분해를 사용한 표본 생성\n\n목표로 하는 다변수 정규분포의 공분산  행렬에 대해 촐레스키 분해를 수행하고, 표준 정규분포로부터 뽑은 표본에 분해된 행렬을 사용하여 선형변환을 하는 방식이다. random vector가 $\\mathbf{x}$ 가 iid이고 표준 정규 분포를 따른 다고 했을 때 \nrandom vector, $\\mathbf{y} \\sim N(\\begin{bmatrix}1//3//2\\end{bmatrix},\\begin{bmatrix}4&-2&1//-2&3&-1//1&-1&2\\end{bmatrix})$ 라고 한다면\n\n$$\n\\begin{alinged}\n  \\mathbf{y}&=\\mathbf{L}\\mathbf{x}+\\mathbf{\\mu} \\\\\n  E(\\mathbf{y})&= \\mathbf{L}E(\\mathbf{x})+\\mathbf{\\mu} \\\\\n  Var(\\mathbf{y})&= \\mathbf{L}Var(\\mathbf(x)) \\mathbf{L}^T= \\mathbf{L}Var(\\mathbf(I)) \\mathbf{L}^T=\\mathbf{L} \\mathbf{L}^T =\\Sigma\n\\end{aligned}\n$$\n\n이 성립한다.\n\n더 쉬운 예제를 들면, $X \\sim N(0,1) \\quadd Y \\sim N(4,9)$\n\n$$\nY=3X+4\n$$\n\n의 선형식이 성립한다.\n\n그러므로 data의 표본을 토대로 simulation을 할 때는 data의 표본 공분산 행렬을 구해 촐레스키 분해를 하여 L을 구한뒤 rnorm()을 변수의 갯 수 만큼 사용하고 데이터의 변수의 표본 벡터를 구해서 더해 주면 데이터의 분포에 기반한 시뮬래이션이 가능해진다.\n\n:::{.callout-tips}\n\n$$\nY=A\\begin{bmatrix}rnorm(X_1) //rnorm(X_2)//rnorm(X_3)\\end{bmatrix} +B\n$$\n\n정규 분포를 따르는 random vectors에 어떤 행렬을 곱하거나 더해도 그 변환된 Y역시 다변수 정규분포를 따른다는 것이 알려져 있다.\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(00)\n\nrandom_samples <- lower_triangular_matrix %*% matrix(rnorm(3000),nrow=3,ncol=1000) + mean_vector\n#위와 같은 식\nrandom_samples <- lower_triangular_matrix %*% matrix(c(rnorm(1000),rnorm(1000),rnorm(1000)),nrow=3,ncol=1000) + mean_vector\n\nrandom_samples<-t(random_samples)\n```\n:::\n\n\n\n$$\n\\mathbf{L}_{3 \\times 3} \\text{random_samples}_{3 \\times 1000} + \\text{mean_vector}_{3\\times 1} \n$$\n\n`mean_vector`는 브로드캐스팅되어 앞의 두행렬의 연산결과의 각 열에 더해지게 됨.\n\nsample은 아래와 같이 뽑히게 된다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(random_samples)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            [,1]       [,2]       [,3]\n[1,] -0.07612761  4.2403547 -0.2827580\n[2,] -1.22520465  2.6778132  2.5256458\n[3,]  0.57189770  2.5652002  4.5131124\n[4,]  3.71812120  2.2683683  0.9224851\n[5,]  1.03533835 -0.4098458  2.7877527\n[6,]  3.72684756  1.1950652  2.2052107\n```\n\n\n:::\n\n```{.r .cell-code}\n#표본 공분산 행렬 추정\ncov(random_samples)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]      [,2]      [,3]\n[1,]  3.849209 -1.820943  1.031505\n[2,] -1.820943  2.958023 -1.014896\n[3,]  1.031505 -1.014896  2.030114\n```\n\n\n:::\n\n```{.r .cell-code}\ncentered_X<-scale(random_samples,center=T,scale=F)\n1/(1000-1)*t(centered_X)%*% centered_X\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]      [,2]      [,3]\n[1,]  3.849209 -1.820943  1.031505\n[2,] -1.820943  2.958023 -1.014896\n[3,]  1.031505 -1.014896  2.030114\n```\n\n\n:::\n\n```{.r .cell-code}\nrandom_samples[,1]%>%hist()\n```\n\n::: {.cell-output-display}\n![](09.cholesky_decomposition_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::",
    "supporting": [
      "09.cholesky_decomposition_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}