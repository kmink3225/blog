{
  "hash": "619b5e56b539e3ea8370088c3fc7d46b",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"CSV/Excel 데이터 분석 에이전트\"\nsubtitle: Pandas DataFrame을 활용한 데이터 분석 에이전트\ndescription: |\n  CSV/Excel 파일로부터 DataFrame을 생성하고 에이전트가 쿼리를 생성하여 데이터를 분석하는 방법을 다룬다.\ncategories:\n  - AI\n  - RAG\n  - LangChain\nauthor: Kwangmin Kim\ndate: 07/21/2025\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\ndraft: False\nexecute:\n    eval: false\n---\n\n* Pandas DataFrame 을 활용하여 분석을 수행하는 Agent 를 생성할 수 있다.\n* CSV/Excel 데이터로부터 Pandas DataFrame 객체를 생성할 수 있으며, 이를 활용하여 Agent 가 Pandas query 를 생성하여 분석을 수행할 수 있다.\n\n::: {#37250e19 .cell execution_count=2}\n``` {.python .cell-code}\n# API 키를 환경변수로 관리하기 위한 설정 파일\nfrom dotenv import load_dotenv\n\n# API 키 정보 로드\nload_dotenv()\n```\n:::\n\n\n::: {#e7244fc3 .cell execution_count=3}\n``` {.python .cell-code}\n# LangSmith 추적을 설정합니다. https://smith.langchain.com\n# !pip install -qU langchain-teddynote\nfrom langchain_teddynote import logging\n\n# 프로젝트 이름을 입력합니다.\nlogging.langsmith(\"CH15-Agent-CSV-Excel\")\n```\n:::\n\n\n::: {#9eb6023a .cell execution_count=4}\n``` {.python .cell-code}\nimport pandas as pd\n\ndf = pd.read_csv(\"./data/titanic.csv\")  # CSV 파일을 읽습니다.\n# df2 = pd.read_excel(\"./data/titanic.xlsx\", sheet_name=\"Sheet1\") # 엑셀 파일도 읽을 수 있습니다.\ndf.head()\n```\n:::\n\n\n::: {#7a122273 .cell execution_count=5}\n``` {.python .cell-code}\nfrom langchain_experimental.tools import PythonAstREPLTool\n\n# 파이썬 코드를 실행하는 도구를 생성합니다.\npython_tool = PythonAstREPLTool()\npython_tool.locals[\"df\"] = df\n\n\n# 도구 호출 시 실행되는 콜백 함수입니다.\ndef tool_callback(tool) -> None:\n    print(f\"<<<<<<< Code >>>>>>\")\n    if tool_name := tool.get(\"tool\"):  # 도구에 입력된 값이 있다면\n        if tool_name == \"python_repl_ast\":\n            tool_input = tool.get(\"tool_input\")\n            for k, v in tool_input.items():\n                if k == \"query\":\n                    print(v)  # Query 를 출력합니다.\n                    result = python_tool.invoke({\"query\": v})\n                    print(result)\n    print(f\"<<<<<<< Code >>>>>>\")\n\n\n# 관찰 결과를 출력하는 콜백 함수입니다.\ndef observation_callback(observation) -> None:\n    print(f\"<<<<<<< Message >>>>>>\")\n    if \"observation\" in observation:\n        print(observation[\"observation\"])\n    print(f\"<<<<<<< Message >>>>>>\")\n\n\n# 최종 결과를 출력하는 콜백 함수입니다.\ndef result_callback(result: str) -> None:\n    print(f\"<<<<<<< 최종 답변 >>>>>>\")\n    print(result)\n    print(f\"<<<<<<< 최종 답변 >>>>>>\")\n```\n:::\n\n\n::: {#b6eaccb0 .cell execution_count=6}\n``` {.python .cell-code}\nfrom langchain_experimental.agents.agent_toolkits import create_pandas_dataframe_agent\nfrom langchain.agents.agent_types import AgentType\nfrom langchain_openai import ChatOpenAI\nfrom langchain_teddynote.messages import AgentStreamParser, AgentCallbacks\n\nagent = create_pandas_dataframe_agent(\n    ChatOpenAI(model=\"gpt-4o\", temperature=0),\n    df,\n    verbose=False,\n    agent_type=\"tool-calling\",\n    allow_dangerous_code=True,\n    prefix=\"You are a professional data analyst and expert in Pandas. \"\n    \"You must use Pandas DataFrame(`df`) to answer user's request. \"\n    \"\\n\\n[IMPORTANT] DO NOT create or overwrite the `df` variable in your code. \\n\\n\"\n    \"If you are willing to generate visualization code, please use `plt.show()` at the end of your code. \"\n    \"I prefer seaborn code for visualization, but you can use matplotlib as well.\"\n    \"\\n\\n<Visualization Preference>\\n\"\n    \"- `muted` cmap, white background, and no grid for your visualization.\"\n    \"\\nRecomment to set palette parameter for seaborn plot.\",\n)\n\nparser_callback = AgentCallbacks(tool_callback, observation_callback, result_callback)\nstream_parser = AgentStreamParser(parser_callback)\n```\n:::\n\n\n::: {#90a93ba4 .cell execution_count=7}\n``` {.python .cell-code}\ndef ask(query):\n    # 질의에 대한 답변을 출력합니다.\n    response = agent.stream({\"input\": query})\n\n    for step in response:\n        stream_parser.process_agent_steps(step)\n```\n:::\n\n\n::: {#65a71eca .cell execution_count=8}\n``` {.python .cell-code}\n# 질의에 대한 답변을 출력합니다.\nresponse = agent.stream({\"input\": \"corr() 을 구해서 히트맵 시각화\"})\n\nfor step in response:\n    stream_parser.process_agent_steps(step)\n```\n:::\n\n\n::: {#8127a15a .cell execution_count=9}\n``` {.python .cell-code}\nask(\"몇 개의 행이 있어?\")\n```\n:::\n\n\n```\n[도구 호출]\nTool: python_repl_ast\nquery: len(df)\nLog: \nInvoking: `python_repl_ast` with `{'query': 'len(df)'}`\n\n\n\n[관찰 내용]\nObservation: 891\n[최종 답변]\n데이터프레임 `df`에는 총 891개의 행이 있습니다.\n\n```\n\n::: {#5a111ef2 .cell execution_count=10}\n``` {.python .cell-code}\nask(\"남자와 여자의 생존율의 차이는 몇이야?\")\n```\n:::\n\n\n```\n[도구 호출]\nTool: python_repl_ast\nquery: male_survival_rate = df[df['Sex'] == 'male']['Survived'].mean()\nfemale_survival_rate = df[df['Sex'] == 'female']['Survived'].mean()\nsurvival_rate_difference = female_survival_rate - male_survival_rate\nsurvival_rate_difference\nLog: \nInvoking: `python_repl_ast` with `{'query': \"male_survival_rate = df[df['Sex'] == 'male']['Survived'].mean()\\nfemale_survival_rate = df[df['Sex'] == 'female']['Survived'].mean()\\nsurvival_rate_difference = female_survival_rate - male_survival_rate\\nsurvival_rate_difference\"}`\n\n\n\n[관찰 내용]\nObservation: 0.5531300709799203\n[최종 답변]\n남자와 여자의 생존율의 차이는 약 0.55입니다. 즉, 여자의 생존율이 남자보다 약 55.3% 더 높습니다.\n```\n\n::: {#caa14c46 .cell execution_count=11}\n``` {.python .cell-code}\nask(\"남자 승객과 여자 승객의 생존율을 구한뒤 barplot 차트로 시각화 해줘\")\n```\n:::\n\n\n```\n[도구 호출]\nTool: python_repl_ast\nquery: import pandas as pd\nimport matplotlib.pyplot as plt\n\n# 남자와 여자 승객의 생존율 계산\nsurvival_rate = df.groupby('Sex')['Survived'].mean()\n\n# barplot 시각화\nsurvival_rate.plot(kind='bar', color=['blue', 'pink'])\nplt.title('Survival Rate by Gender')\nplt.xlabel('Gender')\nplt.ylabel('Survival Rate')\nplt.xticks(rotation=0)\nplt.show()\nLog: \nInvoking: `python_repl_ast` with `{'query': \"import pandas as pd\\nimport matplotlib.pyplot as plt\\n\\n# 남자와 여자 승객의 생존율 계산\\nsurvival_rate = df.groupby('Sex')['Survived'].mean()\\n\\n# barplot 시각화\\nsurvival_rate.plot(kind='bar', color=['blue', 'pink'])\\nplt.title('Survival Rate by Gender')\\nplt.xlabel('Gender')\\nplt.ylabel('Survival Rate')\\nplt.xticks(rotation=0)\\nplt.show()\"}`\n\n\n\n[관찰 내용]\nObservation: \n[최종 답변]\n남자 승객과 여자 승객의 생존율을 계산한 후, 바 차트로 시각화한 결과를 확인할 수 있습니다. 차트는 남성과 여성의 생존율을 비교하여 보여줍니다.\n```\n\n::: {#c2baf7ec .cell execution_count=12}\n``` {.python .cell-code}\nask(\"1,2 등급에 탑승한 10세 이하 어린 아이의 성별별 생존율을 구하고 시각화 하세요\")\n```\n:::\n\n\n```\n[도구 호출]\nTool: python_repl_ast\nquery: import pandas as pd\nimport matplotlib.pyplot as plt\n\n# 1, 2등급에 탑승한 10세 이하 어린 아이 필터링\nchildren = df[(df['Pclass'].isin([1, 2])) & (df['Age'] <= 10)]\n\n# 성별별 생존율 계산\nsurvival_rate = children.groupby('Sex')['Survived'].mean() * 100\n\n# 시각화\nplt.figure(figsize=(8, 5))\nplt.bar(survival_rate.index, survival_rate.values, color=['blue', 'pink'])\nplt.title('Survival Rate of Children (Age <= 10) in 1st and 2nd Class by Gender')\nplt.xlabel('Gender')\nplt.ylabel('Survival Rate (%)')\nplt.ylim(0, 100)\nplt.grid(axis='y')\nplt.show()\nLog: \nInvoking: `python_repl_ast` with `{'query': \"import pandas as pd\\nimport matplotlib.pyplot as plt\\n\\n# 1, 2등급에 탑승한 10세 이하 어린 아이 필터링\\nchildren = df[(df['Pclass'].isin([1, 2])) & (df['Age'] <= 10)]\\n\\n# 성별별 생존율 계산\\nsurvival_rate = children.groupby('Sex')['Survived'].mean() * 100\\n\\n# 시각화\\nplt.figure(figsize=(8, 5))\\nplt.bar(survival_rate.index, survival_rate.values, color=['blue', 'pink'])\\nplt.title('Survival Rate of Children (Age <= 10) in 1st and 2nd Class by Gender')\\nplt.xlabel('Gender')\\nplt.ylabel('Survival Rate (%)')\\nplt.ylim(0, 100)\\nplt.grid(axis='y')\\nplt.show()\"}`\n\n[관찰 내용]\nObservation: \n[최종 답변]\n위의 코드를 실행하여 1, 2등급에 탑승한 10세 이하 어린 아이의 성별별 생존율을 계산하고 시각화했습니다. 결과는 다음과 같은 막대 그래프로 나타납니다. 각 성별에 따른 생존율을 확인할 수 있습니다.\n```\n\n",
    "supporting": [
      "07-CSV-Excel-Agent_files"
    ],
    "filters": [],
    "includes": {}
  }
}