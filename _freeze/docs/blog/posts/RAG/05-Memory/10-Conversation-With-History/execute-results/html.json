{
  "hash": "9e91628d4b103d5e19695dec41e34005",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"이전 대화를 기억하는 Chain 생성방법\"\nsubtitle: 대화 메모리\ndescription: |\n  대화 컨텍스트를 관리하는 다양한 메모리 시스템을 다룬다.\ncategories:\n  - AI\n  - RAG\n  - LangChain\nauthor: Kwangmin Kim\ndate: 12/31/2024\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\ndraft: False\nexecute:\n    eval: false\n---\n\n::: {#17177198 .cell execution_count=1}\n``` {.python .cell-code}\n# API KEY를 환경변수로 관리하기 위한 설정 파일\nfrom dotenv import load_dotenv\n\n# API KEY 정보로드\nload_dotenv()\n```\n:::\n\n\n::: {#07532800 .cell execution_count=2}\n``` {.python .cell-code}\n# LangSmith 추적을 설정합니다. https://smith.langchain.com\n# !pip install langchain-teddynote\nfrom langchain_teddynote import logging\n\n# 프로젝트 이름을 입력합니다.\nlogging.langsmith(\"CH05-Memory\")\n```\n:::\n\n\n## 이전 대화내용을 기억하는 multi-turn Chain\n\n::: {#3c2331a0 .cell execution_count=3}\n``` {.python .cell-code}\nfrom langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder\nfrom langchain_community.chat_message_histories import ChatMessageHistory\nfrom langchain_core.chat_history import BaseChatMessageHistory\nfrom langchain_core.runnables.history import RunnableWithMessageHistory\nfrom langchain_openai import ChatOpenAI\nfrom langchain_core.output_parsers import StrOutputParser\n\n\n# 프롬프트 정의\nprompt = ChatPromptTemplate.from_messages(\n    [\n        (\n            \"system\",\n            \"당신은 Question-Answering 챗봇입니다. 주어진 질문에 대한 답변을 제공해주세요.\",\n        ),\n        # 대화기록용 key 인 chat_history 는 가급적 변경 없이 사용하세요!\n        MessagesPlaceholder(variable_name=\"chat_history\"),\n        (\"human\", \"#Question:\\n{question}\"),  # 사용자 입력을 변수로 사용\n    ]\n)\n\n# llm 생성\nllm = ChatOpenAI(model_name=\"gpt-4.1-mini\")\n\n# 일반 Chain 생성\nchain = prompt | llm | StrOutputParser()\n```\n:::\n\n\n대화를 기록하는 체인 생성(`chain_with_history`)\n\n::: {#ee94df28 .cell execution_count=4}\n``` {.python .cell-code}\n# 세션 기록을 저장할 딕셔너리\nstore = {}\n\n\n# 세션 ID를 기반으로 세션 기록을 가져오는 함수\ndef get_session_history(session_ids):\n    print(f\"[대화 세션ID]: {session_ids}\")\n    if session_ids not in store:  # 세션 ID가 store에 없는 경우\n        # 새로운 ChatMessageHistory 객체를 생성하여 store에 저장\n        store[session_ids] = ChatMessageHistory()\n    return store[session_ids]  # 해당 세션 ID에 대한 세션 기록 반환\n```\n:::\n\n\n::: {#0827d6d5 .cell execution_count=5}\n``` {.python .cell-code}\nchain_with_history = RunnableWithMessageHistory(\n    chain,\n    get_session_history,  # 세션 기록을 가져오는 함수\n    input_messages_key=\"question\",  # 사용자의 질문이 템플릿 변수에 들어갈 key\n    history_messages_key=\"chat_history\",  # 기록 메시지의 키\n)\n```\n:::\n\n\n첫 번째 질문 실행\n\n::: {#f339744e .cell execution_count=6}\n``` {.python .cell-code}\nchain_with_history.invoke(\n    # 질문 입력\n    {\"question\": \"나의 이름은 테디입니다.\"},\n    # 세션 ID 기준으로 대화를 기록합니다.\n    config={\"configurable\": {\"session_id\": \"abc123\"}},\n)\n```\n:::\n\n\n이어서 질문 실행\n\n::: {#cd4d0917 .cell execution_count=7}\n``` {.python .cell-code}\nchain_with_history.invoke(\n    # 질문 입력\n    {\"question\": \"내 이름이 뭐라고?\"},\n    # 세션 ID 기준으로 대화를 기록합니다.\n    config={\"configurable\": {\"session_id\": \"abc123\"}},\n)\n```\n:::\n\n\n아래는 `session_id`가 다른 경우 새로운 세션이 생성되는 경우입니다.\n\n::: {#187ed103 .cell execution_count=8}\n``` {.python .cell-code}\nchain_with_history.invoke(\n    # 질문 입력\n    {\"question\": \"내 이름이 뭐라고?\"},\n    # 세션 ID 기준으로 대화를 기록합니다.\n    config={\"configurable\": {\"session_id\": \"abc1234\"}},\n)\n```\n:::\n\n\n",
    "supporting": [
      "10-Conversation-With-History_files"
    ],
    "filters": [],
    "includes": {}
  }
}