{
  "hash": "39f47aaa2f83264f8ae60d2543ca4738",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"PromptTemplate\"\nsubtitle: 프롬프트 엔지니어링\ndescription: |\n  효과적인 프롬프트 템플릿 설계 및 관리 기법을 다룬다.\ncategories:\n  - AI\n  - RAG\n  - LangChain\n  - Prompt Engineering\nauthor: Kwangmin Kim\ndate: 01/12/2025\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\ndraft: False\nexecute:\n    eval: false\n---\n\n::: {#be27877c .cell execution_count=1}\n``` {.python .cell-code}\nfrom dotenv import load_dotenv\n\nload_dotenv()\n```\n:::\n\n\n::: {#089b14f7 .cell execution_count=2}\n``` {.python .cell-code}\n# LangSmith 추적을 설정합니다. https://smith.langchain.com\n# !pip install -qU langchain-teddynote\nfrom langchain_teddynote import logging\n\n# 프로젝트 이름을 입력합니다.\nlogging.langsmith(\"CH02-Prompt\")\n```\n:::\n\n\nLLM 객체를 정의합니다. \n\n::: {#550f98b2 .cell execution_count=3}\n``` {.python .cell-code}\nfrom langchain_openai import ChatOpenAI\n\nllm = ChatOpenAI()\n```\n:::\n\n\n### 방법 1. from_template() 메소드를 사용하여 PromptTemplate 객체 생성\n\n- 치환될 변수를 `{ 변수 }` 로 묶어서 템플릿을 정의합니다.\n\n::: {#363a5942 .cell execution_count=4}\n``` {.python .cell-code}\nfrom langchain_core.prompts import PromptTemplate\n\n# template 정의. {country}는 변수로, 이후에 값이 들어갈 자리를 의미\ntemplate = \"{country}의 수도는 어디인가요?\"\n\n# from_template 메소드를 이용하여 PromptTemplate 객체 생성\nprompt = PromptTemplate.from_template(template)\nprompt\n```\n:::\n\n\n`country` 변수에 값을 넣어서 문장을 생성할 수 있습니다.\n\n::: {#42669f6d .cell execution_count=5}\n``` {.python .cell-code}\n# prompt 생성. format 메소드를 이용하여 변수에 값을 넣어줌\nprompt = prompt.format(country=\"대한민국\")\nprompt\n```\n:::\n\n\n::: {#1ce6b00f .cell execution_count=6}\n``` {.python .cell-code}\n# template 정의\ntemplate = \"{country}의 수도는 어디인가요?\"\n\n# from_template 메소드를 이용하여 PromptTemplate 객체 생성\nprompt = PromptTemplate.from_template(template)\n\n# chain 생성\nchain = prompt | llm\n```\n:::\n\n\n::: {#56829f94 .cell execution_count=7}\n``` {.python .cell-code}\n# country 변수에 입력된 값이 자동으로 치환되어 수행됨\nchain.invoke(\"대한민국\").content\n```\n:::\n\n\n### 방법 2. PromptTemplate 객체 생성과 동시에 prompt 생성\n\n추가 유효성 검사를 위해 `input_variables` 를 명시적으로 지정하세요.\n\n이러한 변수는 인스턴스화 중에 템플릿 문자열에 있는 변수와 비교하여 불일치하는 경우 예외를 발생시킵니다.\n\n::: {#43fc48ed .cell execution_count=8}\n``` {.python .cell-code}\n# template 정의\ntemplate = \"{country}의 수도는 어디인가요?\"\n\n# PromptTemplate 객체를 활용하여 prompt_template 생성\nprompt = PromptTemplate(\n    template=template,\n    input_variables=[\"country\"],\n)\n\nprompt\n```\n:::\n\n\n::: {#e954fbdd .cell execution_count=9}\n``` {.python .cell-code}\n# prompt 생성\nprompt.format(country=\"대한민국\")\n```\n:::\n\n\n::: {#b591305b .cell execution_count=10}\n``` {.python .cell-code}\n# template 정의\ntemplate = \"{country1}과 {country2}의 수도는 각각 어디인가요?\"\n\n# PromptTemplate 객체를 활용하여 prompt_template 생성\nprompt = PromptTemplate(\n    template=template,\n    input_variables=[\"country1\"],\n    partial_variables={\n        \"country2\": \"미국\"  # dictionary 형태로 partial_variables를 전달\n    },\n)\n\nprompt\n```\n:::\n\n\n::: {#cbf30434 .cell execution_count=11}\n``` {.python .cell-code}\nprompt.format(country1=\"대한민국\")\n```\n:::\n\n\n::: {#575685d1 .cell execution_count=12}\n``` {.python .cell-code}\nprompt_partial = prompt.partial(country2=\"캐나다\")\nprompt_partial\n```\n:::\n\n\n::: {#d23713c5 .cell execution_count=13}\n``` {.python .cell-code}\nprompt_partial.format(country1=\"대한민국\")\n```\n:::\n\n\n::: {#0a428fbb .cell execution_count=14}\n``` {.python .cell-code}\nchain = prompt_partial | llm\n```\n:::\n\n\n::: {#a8c58591 .cell execution_count=15}\n``` {.python .cell-code}\nchain.invoke(\"대한민국\").content\n```\n:::\n\n\n::: {#0c6aaba7 .cell execution_count=16}\n``` {.python .cell-code}\nchain.invoke({\"country1\": \"대한민국\", \"country2\": \"호주\"}).content\n```\n:::\n\n\n### `partial_variables`: 부분 변수 채움\n\n`partial`을 사용하는 일반적인 용도는 함수를 부분적으로 사용하는 것입니다. 이 사용 사례는 **항상 공통된 방식으로 가져오고 싶은 변수** 가 있는 경우입니다.\n\n대표적인 예가 **날짜나 시간** 입니다.\n\n항상 현재 날짜가 표시되기를 원하는 프롬프트가 있다고 가정해 보겠습니다. 프롬프트에 하드 코딩할 수도 없고, 다른 입력 변수와 함께 전달하는 것도 번거롭습니다. 이 경우 항상 현재 **날짜를 반환하는 함수** 를 사용하여 프롬프트를 부분적으로 변경할 수 있으면 매우 편리합니다.\n\n다음의 코드는 오늘 날짜를 구하는 파이썬 코드입니다.\n\n::: {#f857504d .cell execution_count=17}\n``` {.python .cell-code}\nfrom datetime import datetime\n\n# 오늘 날짜를 출력\ndatetime.now().strftime(\"%B %d\")\n```\n:::\n\n\n::: {#23352e84 .cell execution_count=18}\n``` {.python .cell-code}\n# 날짜를 반환하는 함수 정의\ndef get_today():\n    return datetime.now().strftime(\"%B %d\")\n```\n:::\n\n\n::: {#7cc4fb72 .cell execution_count=19}\n``` {.python .cell-code}\nprompt = PromptTemplate(\n    template=\"오늘의 날짜는 {today} 입니다. 오늘이 생일인 유명인 {n}명을 나열해 주세요. 생년월일을 표기해주세요.\",\n    input_variables=[\"n\"],\n    partial_variables={\n        \"today\": get_today  # dictionary 형태로 partial_variables를 전달\n    },\n)\n```\n:::\n\n\n::: {#7d7ffeb2 .cell execution_count=20}\n``` {.python .cell-code}\n# prompt 생성\nprompt.format(n=3)\n```\n:::\n\n\n::: {#5ee8f471 .cell execution_count=21}\n``` {.python .cell-code}\n# chain 을 생성합니다.\nchain = prompt | llm\n```\n:::\n\n\n::: {#90c582c5 .cell execution_count=22}\n``` {.python .cell-code}\n# chain 을 실행 후 결과를 확인합니다.\nprint(chain.invoke(3).content)\n```\n:::\n\n\n::: {#78d10e00 .cell execution_count=23}\n``` {.python .cell-code}\n# chain 을 실행 후 결과를 확인합니다.\nprint(chain.invoke({\"today\": \"Jan 02\", \"n\": 3}).content)\n```\n:::\n\n\n## 파일로부터 template 읽어오기\n\n::: {#30e6fb39 .cell execution_count=24}\n``` {.python .cell-code}\nfrom langchain_core.prompts import load_prompt\n\nprompt = load_prompt(\"prompts/fruit_color.yaml\", encoding=\"utf-8\")\nprompt\n```\n:::\n\n\nWindow 사용자 중 이전의 코드가 오류가 나는 경우 아래의 코드로 실행하세요(인코딩 설정)\n\n::: {#4e581b4a .cell execution_count=25}\n``` {.python .cell-code}\nfrom langchain_teddynote.prompts import load_prompt\n\n# Windows 사용자 only: 인코딩을 cp949로 설정\nload_prompt(\"prompts/fruit_color.yaml\", encoding=\"utf-8\")\n```\n:::\n\n\n::: {#069a5eb1 .cell execution_count=26}\n``` {.python .cell-code}\nprompt.format(fruit=\"사과\")\n```\n:::\n\n\n::: {#566cdb2e .cell execution_count=27}\n``` {.python .cell-code}\nprompt2 = load_prompt(\"prompts/capital.yaml\")\nprint(prompt2.format(country=\"대한민국\"))\n```\n:::\n\n\n## ChatPromptTemplate\n\n`ChatPromptTemplate` 은 대화목록을 프롬프트로 주입하고자 할 때 활용할 수 있습니다.\n\n메시지는 튜플(tuple) 형식으로 구성하며, (`role`, `message`) 로 구성하여 리스트로 생성할 수 있습니다.\n\n**role**\n- `\"system\"`: 시스템 설정 메시지 입니다. 주로 전역설정과 관련된 프롬프트입니다.\n- `\"human\"` : 사용자 입력 메시지 입니다.\n- `\"ai\"`: AI 의 답변 메시지입니다.\n\n::: {#f50806fb .cell execution_count=28}\n``` {.python .cell-code}\nfrom langchain_core.prompts import ChatPromptTemplate\n\nchat_prompt = ChatPromptTemplate.from_template(\"{country}의 수도는 어디인가요?\")\nchat_prompt\n```\n:::\n\n\n::: {#23bfd340 .cell execution_count=29}\n``` {.python .cell-code}\nchat_prompt.format(country=\"대한민국\")\n```\n:::\n\n\n::: {#fbc85e2b .cell execution_count=30}\n``` {.python .cell-code}\nfrom langchain_core.prompts import ChatPromptTemplate\n\nchat_template = ChatPromptTemplate.from_messages(\n    [\n        # role, message\n        (\"system\", \"당신은 친절한 AI 어시스턴트입니다. 당신의 이름은 {name} 입니다.\"),\n        (\"human\", \"반가워요!\"),\n        (\"ai\", \"안녕하세요! 무엇을 도와드릴까요?\"),\n        (\"human\", \"{user_input}\"),\n    ]\n)\n\n# 챗 message 를 생성합니다.\nmessages = chat_template.format_messages(\n    name=\"테디\", user_input=\"당신의 이름은 무엇입니까?\"\n)\nmessages\n```\n:::\n\n\n생성한 메시지를 바로 주입하여 결과를 받을 수 있습니다.\n\n::: {#e3fe7e64 .cell execution_count=31}\n``` {.python .cell-code}\nllm.invoke(messages).content\n```\n:::\n\n\n이번에는 체인을 생성해 보겠습니다.\n\n::: {#b64917c3 .cell execution_count=32}\n``` {.python .cell-code}\nchain = chat_template | llm\n```\n:::\n\n\n::: {#67ae2993 .cell execution_count=33}\n``` {.python .cell-code}\nchain.invoke({\"name\": \"Teddy\", \"user_input\": \"당신의 이름은 무엇입니까?\"}).content\n```\n:::\n\n\n## MessagePlaceholder\n\n또한 LangChain은 포맷하는 동안 렌더링할 메시지를 완전히 제어할 수 있는 `MessagePlaceholder` 를 제공합니다. \n\n메시지 프롬프트 템플릿에 어떤 역할을 사용해야 할지 확실하지 않거나 서식 지정 중에 메시지 목록을 삽입하려는 경우 유용할 수 있습니다.\n\n::: {#726e7540 .cell execution_count=34}\n``` {.python .cell-code}\nfrom langchain_core.output_parsers import StrOutputParser\nfrom langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder\n\nchat_prompt = ChatPromptTemplate.from_messages(\n    [\n        (\n            \"system\",\n            \"당신은 요약 전문 AI 어시스턴트입니다. 당신의 임무는 주요 키워드로 대화를 요약하는 것입니다.\",\n        ),\n        MessagesPlaceholder(variable_name=\"conversation\"),\n        (\"human\", \"지금까지의 대화를 {word_count} 단어로 요약합니다.\"),\n    ]\n)\nchat_prompt\n```\n:::\n\n\n`conversation` 대화목록을 나중에 추가하고자 할 때 `MessagesPlaceholder` 를 사용할 수 있습니다.\n\n::: {#c98e08a2 .cell execution_count=35}\n``` {.python .cell-code}\nformatted_chat_prompt = chat_prompt.format(\n    word_count=5,\n    conversation=[\n        (\"human\", \"안녕하세요! 저는 오늘 새로 입사한 테디 입니다. 만나서 반갑습니다.\"),\n        (\"ai\", \"반가워요! 앞으로 잘 부탁 드립니다.\"),\n    ],\n)\n\nprint(formatted_chat_prompt)\n```\n:::\n\n\n::: {#ecbd8cc0 .cell execution_count=36}\n``` {.python .cell-code}\n# chain 생성\nchain = chat_prompt | llm | StrOutputParser()\n```\n:::\n\n\n::: {#66135083 .cell execution_count=37}\n``` {.python .cell-code}\n# chain 실행 및 결과확인\nchain.invoke(\n    {\n        \"word_count\": 5,\n        \"conversation\": [\n            (\n                \"human\",\n                \"안녕하세요! 저는 오늘 새로 입사한 테디 입니다. 만나서 반갑습니다.\",\n            ),\n            (\"ai\", \"반가워요! 앞으로 잘 부탁 드립니다.\"),\n        ],\n    }\n)\n```\n:::\n\n\n",
    "supporting": [
      "01-PromptTemplate_files"
    ],
    "filters": [],
    "includes": {}
  }
}