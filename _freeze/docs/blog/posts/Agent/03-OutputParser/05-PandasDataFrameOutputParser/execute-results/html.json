{
  "hash": "daeaf38a2b16d9719b98373ad93411a1",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"PandasDataFrameOutputParser\"\nsubtitle: 출력 파싱\ndescription: |\n  LLM 출력을 구조화된 데이터로 변환하는 다양한 파서를 다룬다.\ncategories:\n  - AI\n  - RAG\n  - LangChain\nauthor: Kwangmin Kim\ndate: 01/21/2025\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\ndraft: False\nexecute:\n    eval: false\n---\n\n**Pandas DataFrame**은 Python 프로그래밍 언어에서 널리 사용되는 데이터 구조로, 데이터 조작 및 분석을 위한 강력한 도구입니다. DataFrame은 구조화된 데이터를 효과적으로 다루기 위한 포괄적인 도구 세트를 제공하며, 이를 통해 데이터 정제, 변환 및 분석과 같은 다양한 작업을 수행할 수 있습니다.\n\n이 **출력 파서**는 사용자가 임의의 Pandas DataFrame을 지정하여 해당 DataFrame에서 데이터를 추출하고, 이를 형식화된 사전(dictionary) 형태로 조회할 수 있게 해주는 LLM(Large Language Model) 기반 도구입니다.\n\n::: {#2fa49c8f .cell execution_count=1}\n``` {.python .cell-code}\nfrom dotenv import load_dotenv\n\nload_dotenv()\n```\n:::\n\n\n::: {#81db5b77 .cell execution_count=2}\n``` {.python .cell-code}\n# LangSmith 추적을 설정합니다. https://smith.langchain.com\n# !pip install langchain-teddynote\nfrom langchain_teddynote import logging\n\n# 프로젝트 이름을 입력합니다.\nlogging.langsmith(\"CH03-OutputParser\")\n```\n:::\n\n\n::: {#9d449abf .cell execution_count=3}\n``` {.python .cell-code}\nimport pprint\nfrom typing import Any, Dict\n\nimport pandas as pd\nfrom langchain.output_parsers import PandasDataFrameOutputParser\nfrom langchain_core.prompts import PromptTemplate\nfrom langchain_openai import ChatOpenAI\n```\n:::\n\n\n::: {#b398b7c8 .cell execution_count=4}\n``` {.python .cell-code}\n# ChatOpenAI 모델 초기화 (gpt-3.5-turbo 모델 사용을 권장합니다)\nmodel = ChatOpenAI(temperature=0, model_name=\"gpt-3.5-turbo\")\n```\n:::\n\n\n`format_parser_output` 함수는 파서 출력을 사전 형식으로 변환하고 출력 형식을 지정하는 데 사용됩니다. \n\n::: {#f4f5873a .cell execution_count=5}\n``` {.python .cell-code}\n# 출력 목적으로만 사용됩니다.\ndef format_parser_output(parser_output: Dict[str, Any]) -> None:\n    # 파서 출력의 키들을 순회합니다.\n    for key in parser_output.keys():\n        # 각 키의 값을 딕셔너리로 변환합니다.\n        parser_output[key] = parser_output[key].to_dict()\n    # 예쁘게 출력합니다.\n    return pprint.PrettyPrinter(width=4, compact=True).pprint(parser_output)\n```\n:::\n\n\n- `titanic.csv` 데이터를 읽어온 뒤 DataFrame 을 로드하여 `df` 변수에 할당합니다.\n- PandasDataFrameOutputParser를 사용하여 DataFrame을 파싱합니다.\n\n::: {#04216302 .cell execution_count=6}\n``` {.python .cell-code}\n# 원하는 Pandas DataFrame을 정의합니다.\ndf = pd.read_csv(\"./data/titanic.csv\")\ndf.head()\n```\n:::\n\n\n::: {#939bbe0d .cell execution_count=7}\n``` {.python .cell-code}\n# 파서를 설정하고 프롬프트 템플릿에 지시사항을 주입합니다.\nparser = PandasDataFrameOutputParser(dataframe=df)\n\n# 파서의 지시사항을 출력합니다.\nprint(parser.get_format_instructions())\n```\n:::\n\n\n컬럼에 대한 값을 조회하는 예제입니다.\n\n::: {#e0d64b6b .cell execution_count=8}\n``` {.python .cell-code}\n# 열 작업 예시입니다.\ndf_query = \"Age column 을 조회해 주세요.\"\n\n\n# 프롬프트 템플릿을 설정합니다.\nprompt = PromptTemplate(\n    template=\"Answer the user query.\\n{format_instructions}\\n{question}\\n\",\n    input_variables=[\"question\"],  # 입력 변수 설정\n    partial_variables={\n        \"format_instructions\": parser.get_format_instructions()\n    },  # 부분 변수 설정\n)\n\n# 체인 생성\nchain = prompt | model | parser\n\n# 체인 실행\nparser_output = chain.invoke({\"question\": df_query})\n\n# 출력\nformat_parser_output(parser_output)\n```\n:::\n\n\n첫 번째 행을 검색하는 예시입니다.\n\n::: {#35331558 .cell execution_count=9}\n``` {.python .cell-code}\n# 행 조회 예시입니다.\ndf_query = \"Retrieve the first row.\"\n\n# 체인 실행\nparser_output = chain.invoke({\"question\": df_query})\n\n# 결과 출력\nformat_parser_output(parser_output)\n```\n:::\n\n\n특정 열에서 일부 행의 평균을 검색하는 작업 예제입니다.\n\n::: {#ab52f2e5 .cell execution_count=10}\n``` {.python .cell-code}\n# row 0 ~ 4의 평균 나이를 구합니다.\ndf[\"Age\"].head().mean()\n```\n:::\n\n\n::: {#b3e3d365 .cell execution_count=11}\n``` {.python .cell-code}\n# 임의의 Pandas DataFrame 작업 예시, 행의 수를 제한합니다.\ndf_query = \"Retrieve the average of the Ages from row 0 to 4.\"\n\n# 체인 실행\nparser_output = chain.invoke({\"question\": df_query})\n\n# 결과 출력\nprint(parser_output)\n```\n:::\n\n\n다음은 요금(Fare) 에 대한 평균 가격을 산정하는 예시입니다.\n\n::: {#6f721e57 .cell execution_count=12}\n``` {.python .cell-code}\ndf.head()\n```\n:::\n\n\n::: {#34b9498e .cell execution_count=13}\n``` {.python .cell-code}\n# 잘못 형식화된 쿼리의 예시입니다.\ndf_query = \"Calculate average `Fare` rate.\"\n\n# 체인 실행\nparser_output = chain.invoke({\"question\": df_query})\n\n# 결과 출력\nprint(parser_output)\n```\n:::\n\n\n::: {#40d79141 .cell execution_count=14}\n``` {.python .cell-code}\n# 결과 검증\ndf[\"Fare\"].mean()\n```\n:::\n\n\n",
    "supporting": [
      "05-PandasDataFrameOutputParser_files"
    ],
    "filters": [],
    "includes": {}
  }
}