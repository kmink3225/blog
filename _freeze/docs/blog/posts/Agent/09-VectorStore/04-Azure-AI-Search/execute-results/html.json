{
  "hash": "56fb4b345b94c267e17cac4a48efac0f",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Azure AI Search\"\nsubtitle: Azure 네이티브 벡터 스토어\ndescription: |\n  Azure AI Search를 활용한 하이브리드 검색 시스템 구축 방법을 다룬다.\n  벡터 검색과 전문 검색을 결합한 엔터프라이즈급 검색 솔루션을 설명한다.\ncategories:\n  - AI\n  - RAG\n  - LangChain\n  - Azure\nauthor: Kwangmin Kim\ndate: 04/18/2025\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\ndraft: False\nexecute:\n    eval: false\n---\n\n## Azure AI Search란?\n\nAzure AI Search(이전 Azure Cognitive Search)는 Microsoft Azure에서 제공하는 완전 관리형 클라우드 검색 서비스다.\n\n**주요 특징:**\n- 벡터 검색 + 전문 검색(Full-Text Search) 하이브리드 지원\n- Azure 생태계와의 완벽한 통합\n- 엔터프라이즈급 보안 및 규정 준수\n- AI 기반 인덱싱 및 검색 기능\n- 확장 가능한 아키텍처\n\n**왜 Azure AI Search인가?**\n- **기업 환경에 최적화**: Azure 서비스들과 네이티브 통합\n- **하이브리드 검색**: 의미 검색(벡터) + 키워드 검색(전문검색) 동시 지원\n- **관리 편의성**: 인프라 관리 불필요, 자동 스케일링\n- **보안 및 규정 준수**: 엔터프라이즈급 보안 기능 내장\n\n## Azure AI Search vs 다른 VectorStore\n\n| 항목 | Azure AI Search | FAISS | Pinecone | Chroma |\n|------|----------------|-------|----------|--------|\n| **배포** | 클라우드 전용 | 로컬/클라우드 | 클라우드 전용 | 로컬/클라우드 |\n| **관리** | 완전 관리형 | 자체 관리 | 완전 관리형 | 자체 관리 |\n| **하이브리드 검색** | ✅ 네이티브 지원 | ❌ | ❌ | ❌ |\n| **Azure 통합** | ✅ 완벽 통합 | 수동 설정 | 수동 설정 | 수동 설정 |\n| **엔터프라이즈 보안** | ✅ 내장 | 수동 설정 | 기본 지원 | 수동 설정 |\n| **가격** | 사용량 기반 | 무료 (인프라 비용 별도) | 사용량 기반 | 무료 (인프라 비용 별도) |\n\n## Azure AI Search 아키텍처\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                 클라이언트 애플리케이션                     │\n│              (LangChain + Azure SDK)                    │\n└────────────────────┬────────────────────────────────────┘\n                     │\n                     ▼\n┌─────────────────────────────────────────────────────────┐\n│               Azure AI Search Service                   │\n│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │\n│  │ 벡터 인덱스    │  │  전문 인덱스  │  │ 시맨틱 검색   │    │\n│  └──────────────┘  └──────────────┘  └──────────────┘   │\n│  ┌──────────────────────────────────────────────────┐   │\n│  │           하이브리드 검색 엔진                      │   │\n│  └──────────────────────────────────────────────────┘   │\n└────────────────────┬────────────────────────────────────┘\n                     │\n                     ▼\n┌─────────────────────────────────────────────────────────┐\n│                   데이터 소스                             │\n│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │\n│  │ Blob Storage │  │  Cosmos DB   │  │   SQL DB     │   │\n│  └──────────────┘  └──────────────┘  └──────────────┘   │\n└─────────────────────────────────────────────────────────┘\n```\n\n## 설치 및 설정\n\n### 필수 패키지 설치\n\n::: {#9ef41290 .cell execution_count=1}\n``` {.python .cell-code}\n# Azure AI Search SDK 설치\n# !pip install azure-search-documents\n# !pip install azure-identity\n# !pip install langchain-community\n# !pip install langchain-openai\n```\n:::\n\n\n### Azure AI Search 리소스 생성\n\n**Azure Portal에서 생성:**\n1. Azure Portal → \"리소스 만들기\" → \"Azure AI Search\" 검색\n2. 기본 정보 입력:\n   - 구독 선택\n   - 리소스 그룹 생성 또는 선택\n   - 서비스 이름 입력 (전역적으로 고유해야 함)\n   - 지역 선택\n3. 가격 책정 계층 선택:\n   - **Free**: 개발/테스트용 (50MB, 최대 3개 인덱스, $0/월)\n   - **Basic**: 소규모 프로젝트 (15GB, 최대 15개 인덱스, $73.73/월)\n   - **Standard S1**: 프로덕션용 (160GB, 최대 50개 인덱스, $245.28/월)\n   - **Standard S2**: 대규모 프로덕션 (512GB, 최대 200개 인덱스, $981.12/월)\n   - **Standard S3**: 엔터프라이즈 (1TB, 최대 200개 인덱스, $1,962.24/월)\n   - **Storage Optimized L1**: 스토리지 집약적 (2TB, 최대 10개 인덱스, $2,802.47/월)\n   - **Storage Optimized L2**: 대용량 스토리지 (4TB, 최대 10개 인덱스, $5,604.21/월)\n\n**엔드포인트 및 키 확인:**\n- 생성된 리소스 → \"키\" 메뉴\n- 엔드포인트 URL과 관리 키 복사\n\n### 환경 변수 설정\n\n::: {#1f87be68 .cell execution_count=2}\n``` {.python .cell-code}\nfrom dotenv import load_dotenv\nimport os\n\nload_dotenv()\n\n# 환경 변수 설정\nAZURE_SEARCH_ENDPOINT = os.getenv(\"AZURE_SEARCH_ENDPOINT\")\nAZURE_SEARCH_API_KEY = os.getenv(\"AZURE_SEARCH_API_KEY\")\nAZURE_OPENAI_ENDPOINT = os.getenv(\"AZURE_OPENAI_ENDPOINT\")\nAZURE_OPENAI_API_KEY = os.getenv(\"AZURE_OPENAI_API_KEY\")\n```\n:::\n\n\n`.env` 파일 예시:\n```\nAZURE_SEARCH_ENDPOINT=https://your-search-service.search.windows.net\nAZURE_SEARCH_API_KEY=your-admin-key\nAZURE_OPENAI_ENDPOINT=https://your-openai-resource.openai.azure.com\nAZURE_OPENAI_API_KEY=your-openai-key\n```\n\n## 기본 사용법\n\n### Azure OpenAI 임베딩 설정\n\n::: {#a8459138 .cell execution_count=3}\n``` {.python .cell-code}\nfrom langchain_openai import AzureOpenAIEmbeddings\n\n# Azure OpenAI 임베딩 모델 설정\nembeddings = AzureOpenAIEmbeddings(\n    azure_deployment=\"text-embedding-ada-002\",\n    openai_api_version=\"2024-02-01\",\n    azure_endpoint=AZURE_OPENAI_ENDPOINT,\n    api_key=AZURE_OPENAI_API_KEY\n)\n\n# 임베딩 테스트\ntest_embedding = embeddings.embed_query(\"테스트 문장\")\nprint(f\"임베딩 차원: {len(test_embedding)}\")\n```\n:::\n\n\n### Azure AI Search 초기화\n\n::: {#216f0388 .cell execution_count=4}\n``` {.python .cell-code}\nfrom langchain_community.vectorstores.azuresearch import AzureSearch\n\n# Azure Search VectorStore 초기화\nvector_store = AzureSearch(\n    azure_search_endpoint=AZURE_SEARCH_ENDPOINT,\n    azure_search_key=AZURE_SEARCH_API_KEY,\n    index_name=\"langchain-vector-demo\",\n    embedding_function=embeddings.embed_query\n)\n\nprint(\"Azure AI Search VectorStore 초기화 완료\")\n```\n:::\n\n\n### 문서 추가\n\n::: {#c4850c69 .cell execution_count=5}\n``` {.python .cell-code}\nfrom langchain_core.documents import Document\n\n# 샘플 문서 생성\ndocuments = [\n    Document(\n        page_content=\"Azure AI Search는 Microsoft Azure의 관리형 검색 서비스다.\",\n        metadata={\"source\": \"azure-docs\", \"category\": \"search\", \"year\": 2024}\n    ),\n    Document(\n        page_content=\"벡터 검색과 전문 검색을 결합한 하이브리드 검색을 지원한다.\",\n        metadata={\"source\": \"azure-docs\", \"category\": \"features\", \"year\": 2024}\n    ),\n    Document(\n        page_content=\"Azure OpenAI Service와 통합하여 RAG 시스템을 구축할 수 있다.\",\n        metadata={\"source\": \"azure-docs\", \"category\": \"ai\", \"year\": 2024}\n    ),\n    Document(\n        page_content=\"엔터프라이즈급 보안과 규정 준수 기능을 제공한다.\",\n        metadata={\"source\": \"azure-docs\", \"category\": \"security\", \"year\": 2024}\n    ),\n    Document(\n        page_content=\"자동 스케일링과 고가용성을 지원하는 클라우드 네이티브 서비스다.\",\n        metadata={\"source\": \"azure-docs\", \"category\": \"infrastructure\", \"year\": 2024}\n    )\n]\n\n# 문서 추가\nids = vector_store.add_documents(documents)\nprint(f\"{len(documents)}개 문서가 인덱스에 추가되었다.\")\nprint(f\"문서 IDs: {ids}\")\n```\n:::\n\n\n### 유사도 검색\n\n::: {#5b652729 .cell execution_count=6}\n``` {.python .cell-code}\n# 기본 유사도 검색\nquery = \"Azure에서 RAG 시스템을 만드는 방법은?\"\nresults = vector_store.similarity_search(query, k=3)\n\nprint(f\"\\n질문: {query}\\n\")\nfor i, doc in enumerate(results, 1):\n    print(f\"[결과 {i}]\")\n    print(f\"내용: {doc.page_content}\")\n    print(f\"메타데이터: {doc.metadata}\\n\")\n```\n:::\n\n\n### 유사도 점수와 함께 검색\n\n::: {#e452df73 .cell execution_count=7}\n``` {.python .cell-code}\n# 유사도 점수 포함 검색\nresults_with_score = vector_store.similarity_search_with_score(query, k=3)\n\nprint(f\"질문: {query}\\n\")\nfor doc, score in results_with_score:\n    print(f\"점수: {score:.4f}\")\n    print(f\"내용: {doc.page_content}\")\n    print(f\"카테고리: {doc.metadata.get('category', 'N/A')}\\n\")\n```\n:::\n\n\n## 하이브리드 검색\n\nAzure AI Search의 가장 강력한 기능은 벡터 검색과 전문 검색을 결합한 하이브리드 검색이다.\n\n### 하이브리드 검색 실행\n\n::: {#a36b5ffe .cell execution_count=8}\n``` {.python .cell-code}\nfrom azure.search.documents.models import VectorizedQuery\n\n# 하이브리드 검색 (벡터 + 키워드)\nquery = \"Azure 보안 기능\"\nresults = vector_store.hybrid_search(\n    query=query,\n    k=5\n)\n\nprint(f\"하이브리드 검색 결과:\\n\")\nfor i, doc in enumerate(results, 1):\n    print(f\"[{i}] {doc.page_content}\")\n    print(f\"    카테고리: {doc.metadata.get('category')}\\n\")\n```\n:::\n\n\n### 검색 가중치 조정\n\n::: {#7824364c .cell execution_count=9}\n``` {.python .cell-code}\n# 벡터 검색 가중치 조정\n# alpha = 1.0: 벡터 검색 100%\n# alpha = 0.0: 키워드 검색 100%\n# alpha = 0.5: 50:50 (기본값)\n\nquery = \"검색 서비스\"\n\n# 벡터 검색 위주\nprint(\"=== 벡터 검색 위주 (alpha=0.8) ===\")\nresults_vector = vector_store.hybrid_search(query, k=3, alpha=0.8)\nfor doc in results_vector:\n    print(f\"- {doc.page_content[:50]}...\")\n\n# 키워드 검색 위주\nprint(\"\\n=== 키워드 검색 위주 (alpha=0.2) ===\")\nresults_keyword = vector_store.hybrid_search(query, k=3, alpha=0.2)\nfor doc in results_keyword:\n    print(f\"- {doc.page_content[:50]}...\")\n```\n:::\n\n\n## 메타데이터 필터링\n\n::: {#f6a5a378 .cell execution_count=10}\n``` {.python .cell-code}\n# 특정 카테고리의 문서만 검색\nquery = \"Azure 기능\"\nresults = vector_store.similarity_search(\n    query=query,\n    k=5,\n    filters=\"category eq 'features' or category eq 'ai'\"\n)\n\nprint(\"필터링된 검색 결과:\")\nfor doc in results:\n    print(f\"- {doc.page_content}\")\n    print(f\"  카테고리: {doc.metadata['category']}\\n\")\n```\n:::\n\n\n::: {#f0eb1ae6 .cell execution_count=11}\n``` {.python .cell-code}\n# 복잡한 필터 조건\nresults = vector_store.similarity_search(\n    query=\"Azure\",\n    k=10,\n    filters=\"category eq 'search' and year eq 2024\"\n)\n\nprint(f\"검색 조건: category='search' AND year=2024\")\nprint(f\"결과 수: {len(results)}\")\n```\n:::\n\n\n## RAG 시스템 구축\n\n### Azure OpenAI와 통합\n\n::: {#e77a46cb .cell execution_count=12}\n``` {.python .cell-code}\nfrom langchain_openai import AzureChatOpenAI\nfrom langchain.chains import RetrievalQA\n\n# Azure OpenAI Chat 모델 설정\nllm = AzureChatOpenAI(\n    azure_deployment=\"gpt-4\",\n    openai_api_version=\"2024-02-01\",\n    azure_endpoint=AZURE_OPENAI_ENDPOINT,\n    api_key=AZURE_OPENAI_API_KEY,\n    temperature=0\n)\n\n# Retriever 생성 (하이브리드 검색 사용)\nretriever = vector_store.as_retriever(\n    search_type=\"similarity\",\n    search_kwargs={\"k\": 3}\n)\n\n# RAG 체인 생성\nqa_chain = RetrievalQA.from_chain_type(\n    llm=llm,\n    chain_type=\"stuff\",\n    retriever=retriever,\n    return_source_documents=True\n)\n\nprint(\"RAG 시스템 준비 완료\")\n```\n:::\n\n\n### 질의응답 실행\n\n::: {#57f14288 .cell execution_count=13}\n``` {.python .cell-code}\n# 질문하기\nquestion = \"Azure AI Search의 주요 특징은 무엇인가?\"\nresult = qa_chain.invoke({\"query\": question})\n\nprint(f\"질문: {question}\\n\")\nprint(f\"답변:\\n{result['result']}\\n\")\nprint(\"참조 문서:\")\nfor i, doc in enumerate(result[\"source_documents\"], 1):\n    print(f\"[{i}] {doc.page_content}\")\n    print(f\"    출처: {doc.metadata.get('source')}, 카테고리: {doc.metadata.get('category')}\\n\")\n```\n:::\n\n\n### 대화형 RAG\n\n::: {#0c796659 .cell execution_count=14}\n``` {.python .cell-code}\nfrom langchain.chains import ConversationalRetrievalChain\nfrom langchain.memory import ConversationBufferMemory\n\n# 대화 메모리 설정\nmemory = ConversationBufferMemory(\n    memory_key=\"chat_history\",\n    return_messages=True,\n    output_key=\"answer\"\n)\n\n# 대화형 RAG 체인\nconversational_chain = ConversationalRetrievalChain.from_llm(\n    llm=llm,\n    retriever=retriever,\n    memory=memory,\n    return_source_documents=True\n)\n\n# 대화 시작\nquestions = [\n    \"Azure AI Search가 무엇인가?\",\n    \"하이브리드 검색이란?\",\n    \"Azure와 어떻게 통합되나?\"\n]\n\nfor question in questions:\n    result = conversational_chain.invoke({\"question\": question})\n    print(f\"Q: {question}\")\n    print(f\"A: {result['answer']}\\n\")\n```\n:::\n\n\n## 고급 인덱스 관리\n\n### 인덱스 스키마 정의\n\n::: {#c392bb73 .cell execution_count=15}\n``` {.python .cell-code}\nfrom azure.search.documents.indexes.models import (\n    SearchIndex,\n    SearchField,\n    SearchFieldDataType,\n    VectorSearch,\n    HnswAlgorithmConfiguration,\n    VectorSearchProfile,\n    SemanticConfiguration,\n    SemanticField,\n    SemanticSearch\n)\n\n# 필드 정의\nfields = [\n    SearchField(\n        name=\"id\",\n        type=SearchFieldDataType.String,\n        key=True,\n        filterable=True\n    ),\n    SearchField(\n        name=\"content\",\n        type=SearchFieldDataType.String,\n        searchable=True,\n        analyzer_name=\"ko.microsoft\"  # 한글 형태소 분석기\n    ),\n    SearchField(\n        name=\"content_vector\",\n        type=SearchFieldDataType.Collection(SearchFieldDataType.Single),\n        vector_search_dimensions=1536,  # Ada-002 차원\n        vector_search_profile_name=\"myHnswProfile\"\n    ),\n    SearchField(\n        name=\"category\",\n        type=SearchFieldDataType.String,\n        filterable=True,\n        facetable=True\n    ),\n    SearchField(\n        name=\"year\",\n        type=SearchFieldDataType.Int32,\n        filterable=True,\n        sortable=True\n    )\n]\n\n# 벡터 검색 설정 (HNSW 알고리즘)\nvector_search = VectorSearch(\n    algorithms=[\n        HnswAlgorithmConfiguration(\n            name=\"myHnsw\",\n            parameters={\n                \"m\": 4,  # 연결 수\n                \"efConstruction\": 400,  # 구축 시 탐색 깊이\n                \"efSearch\": 500,  # 검색 시 탐색 깊이\n                \"metric\": \"cosine\"  # 유사도 메트릭\n            }\n        )\n    ],\n    profiles=[\n        VectorSearchProfile(\n            name=\"myHnswProfile\",\n            algorithm_configuration_name=\"myHnsw\"\n        )\n    ]\n)\n\n# 시맨틱 검색 설정\nsemantic_config = SemanticConfiguration(\n    name=\"my-semantic-config\",\n    prioritized_fields=SemanticField(\n        title_field=None,\n        content_fields=[SemanticField(field_name=\"content\")],\n        keywords_fields=[SemanticField(field_name=\"category\")]\n    )\n)\n\nsemantic_search = SemanticSearch(configurations=[semantic_config])\n```\n:::\n\n\n### 인덱스 생성\n\n::: {#91f511ff .cell execution_count=16}\n``` {.python .cell-code}\nfrom azure.search.documents.indexes import SearchIndexClient\nfrom azure.core.credentials import AzureKeyCredential\n\n# 인덱스 클라이언트\nindex_client = SearchIndexClient(\n    endpoint=AZURE_SEARCH_ENDPOINT,\n    credential=AzureKeyCredential(AZURE_SEARCH_API_KEY)\n)\n\n# 인덱스 생성\nindex = SearchIndex(\n    name=\"advanced-index\",\n    fields=fields,\n    vector_search=vector_search,\n    semantic_search=semantic_search\n)\n\nresult = index_client.create_or_update_index(index)\nprint(f\"인덱스 '{result.name}' 생성 완료\")\n```\n:::\n\n\n### 인덱스 조회 및 삭제\n\n::: {#1b9618da .cell execution_count=17}\n``` {.python .cell-code}\n# 모든 인덱스 조회\nindexes = index_client.list_indexes()\nprint(\"현재 인덱스 목록:\")\nfor idx in indexes:\n    print(f\"- {idx.name}\")\n\n# 특정 인덱스 정보 조회\nindex_info = index_client.get_index(\"advanced-index\")\nprint(f\"\\n인덱스 정보:\")\nprint(f\"이름: {index_info.name}\")\nprint(f\"필드 수: {len(index_info.fields)}\")\n\n# 인덱스 삭제\n# index_client.delete_index(\"advanced-index\")\n# print(\"인덱스 삭제 완료\")\n```\n:::\n\n\n## 시맨틱 검색\n\nAzure AI Search의 시맨틱 랭킹 기능을 활용한다.\n\n::: {#0060f941 .cell execution_count=18}\n``` {.python .cell-code}\nfrom azure.search.documents.models import QueryType\n\n# 시맨틱 검색 실행\nresults = vector_store.similarity_search(\n    query=\"클라우드 기반 검색 솔루션의 보안 기능\",\n    k=5,\n    query_type=QueryType.SEMANTIC,\n    semantic_configuration_name=\"my-semantic-config\"\n)\n\nprint(\"시맨틱 검색 결과:\")\nfor i, doc in enumerate(results, 1):\n    print(f\"\\n[{i}] {doc.page_content}\")\n    print(f\"카테고리: {doc.metadata.get('category')}\")\n```\n:::\n\n\n## 성능 최적화\n\n### 배치 업로드\n\n::: {#5dcab334 .cell execution_count=19}\n``` {.python .cell-code}\nfrom azure.search.documents import SearchClient\n\n# Search 클라이언트 생성\nsearch_client = SearchClient(\n    endpoint=AZURE_SEARCH_ENDPOINT,\n    index_name=\"langchain-vector-demo\",\n    credential=AzureKeyCredential(AZURE_SEARCH_API_KEY)\n)\n\n# 대량 문서 업로드 (배치 단위)\nbatch_size = 100\ndocuments_batch = []\n\nfor doc in large_document_list:\n    documents_batch.append(doc)\n    \n    if len(documents_batch) >= batch_size:\n        # 배치 업로드\n        result = search_client.upload_documents(documents=documents_batch)\n        print(f\"{len(documents_batch)}개 문서 업로드 완료\")\n        documents_batch = []\n\n# 남은 문서 업로드\nif documents_batch:\n    search_client.upload_documents(documents=documents_batch)\n```\n:::\n\n\n### 인덱싱 최적화\n\n::: {#09c99498 .cell execution_count=20}\n``` {.python .cell-code}\n# 인덱서 설정으로 자동 인덱싱\nfrom azure.search.documents.indexes.models import (\n    SearchIndexer,\n    IndexingSchedule,\n    FieldMapping\n)\n\n# 데이터 소스 연결 (예: Blob Storage)\nindexer = SearchIndexer(\n    name=\"my-indexer\",\n    data_source_name=\"my-datasource\",\n    target_index_name=\"my-index\",\n    schedule=IndexingSchedule(interval=\"PT2H\"),  # 2시간마다\n    field_mappings=[\n        FieldMapping(source_field_name=\"content\", target_field_name=\"content\")\n    ]\n)\n\n# 인덱서 생성 및 실행\n# indexer_client.create_or_update_indexer(indexer)\n# indexer_client.run_indexer(\"my-indexer\")\n```\n:::\n\n\n## 보안 및 인증\n\n### Managed Identity 사용\n\n::: {#e1bc5c10 .cell execution_count=21}\n``` {.python .cell-code}\nfrom azure.identity import DefaultAzureCredential\n\n# Managed Identity로 인증 (권장)\ncredential = DefaultAzureCredential()\n\nvector_store = AzureSearch(\n    azure_search_endpoint=AZURE_SEARCH_ENDPOINT,\n    azure_search_credential=credential,  # 키 대신 credential\n    index_name=\"secure-index\",\n    embedding_function=embeddings.embed_query\n)\n\nprint(\"Managed Identity로 인증 완료\")\n```\n:::\n\n\n### Private Endpoint 설정\n\nAzure Portal에서 설정:\n1. Azure AI Search 리소스 → \"네트워킹\"\n2. \"프라이빗 엔드포인트 연결\" 추가\n3. VNet 및 서브넷 선택\n4. DNS 설정 구성\n\n### 역할 기반 액세스 제어 (RBAC)\n\nAzure Portal에서 설정:\n1. AI Search 리소스 → \"액세스 제어(IAM)\"\n2. \"역할 할당 추가\"\n3. 역할 선택:\n   - Search Service Contributor: 관리 작업\n   - Search Index Data Contributor: 문서 추가/삭제\n   - Search Index Data Reader: 읽기 전용\n\n## 모니터링 및 진단\n\n### Azure Monitor 통합\n\n- Azure Portal에서 모니터링\n- AI Search → 모니터링 → 메트릭\n- 주요 메트릭:\n    - SearchQueriesPerSecond: 초당 검색 쿼리 수\n    - ThrottledSearchQueriesPercentage: 제한된 쿼리 비율\n    - SearchLatency: 검색 지연 시간\n    - IndexingDocumentsCount: 인덱싱된 문서 수\n\n### 검색 품질 분석\n\n::: {#c6618c14 .cell execution_count=22}\n``` {.python .cell-code}\ndef analyze_search_quality(test_queries, expected_results):\n    \"\"\"검색 품질 메트릭 계산\"\"\"\n    metrics = {\n        \"precision\": [],\n        \"recall\": [],\n        \"mrr\": []  # Mean Reciprocal Rank\n    }\n    \n    for query, expected in zip(test_queries, expected_results):\n        results = vector_store.similarity_search(query, k=10)\n        result_ids = [doc.metadata.get(\"id\") for doc in results]\n        \n        # Precision@K\n        relevant_in_top_k = len(set(result_ids[:5]) & set(expected))\n        precision = relevant_in_top_k / 5\n        metrics[\"precision\"].append(precision)\n        \n        # Recall\n        total_relevant = len(set(result_ids) & set(expected))\n        recall = total_relevant / len(expected) if expected else 0\n        metrics[\"recall\"].append(recall)\n        \n        # MRR\n        for i, doc_id in enumerate(result_ids, 1):\n            if doc_id in expected:\n                metrics[\"mrr\"].append(1/i)\n                break\n        else:\n            metrics[\"mrr\"].append(0)\n    \n    return {\n        \"avg_precision\": sum(metrics[\"precision\"]) / len(metrics[\"precision\"]),\n        \"avg_recall\": sum(metrics[\"recall\"]) / len(metrics[\"recall\"]),\n        \"avg_mrr\": sum(metrics[\"mrr\"]) / len(metrics[\"mrr\"])\n    }\n\n# 사용 예시\n# test_queries = [\"Azure 검색\", \"RAG 시스템\", \"보안 기능\"]\n# expected = [[\"doc1\", \"doc2\"], [\"doc3\", \"doc4\"], [\"doc5\"]]\n# quality_metrics = analyze_search_quality(test_queries, expected)\n```\n:::\n\n\n## 비용 최적화\n\n### 가격 책정 계층\n\n| 계층 | 월 비용 (SU당) | 스토리지 | 최대 인덱스 | 최대 스케일 | 용도 |\n|------|---------------|---------|-----------|-----------|------|\n| **Free** | $0 | 50MB | 3 | N/A | 개발/테스트 |\n| **Basic** | $73.73 | 15GB | 15 | 최대 3 파티션, 3 복제본 | 소규모 프로젝트 |\n| **Standard S1** | $245.28 | 160GB | 50 | 최대 12 파티션, 12 복제본 | 프로덕션 환경 |\n| **Standard S2** | $981.12 | 512GB | 200 | 최대 12 파티션, 12 복제본 | 대규모 프로덕션 |\n| **Standard S3** | $1,962.24 | 1TB | 200 (고밀도 모드: 1,000/파티션) | 최대 12 파티션, 12 복제본 | 엔터프라이즈급 |\n| **Storage Optimized L1** | $2,802.47 | 2TB | 10 | 최대 12 파티션, 12 복제본 | 스토리지 집약적 워크로드 |\n| **Storage Optimized L2** | $5,604.21 | 4TB | 10 | 최대 12 파티션, 12 복제본 | 대용량 스토리지 |\n\n**참고:**\n- 스토리지는 서비스당 최대 용량 기준 (파티션 수에 따라 증가)\n- Standard S3의 고밀도 모드는 파티션당 최대 1,000개 인덱스 지원\n- Confidential Compute 옵션은 추가 비용 발생 (약 10% 할증)\n\n### 비용 절감 전략\n\n1. 인덱스 크기 최적화\n    - 필요한 필드만 저장\n    - 검색하지 않는 필드는 `retrievable=False`\n2. 복제본 및 파티션 조정\n    - 개발: 1 복제본, 1 파티션\n    - 프로덕션: 필요한 만큼만\n3. 사용하지 않는 인덱스 삭제\n\n```python\nunused_indexes = [\"old-index-1\", \"test-index-2\"]\nfor index_name in unused_indexes:\n    index_client.delete_index(index_name)\n    print(f\"삭제: {index_name}\")\n```\n\n4. 스케줄링된 인덱싱 사용\n    - 실시간 업데이트 대신 배치 처리\n\n\n## 문제 해결\n\n### 일반적인 오류\n\n\n```python\n# 인증 오류\n# 오류: 401 Unauthorized\n# 해결: API 키 및 엔드포인트 확인\nprint(f\"Endpoint: {AZURE_SEARCH_ENDPOINT}\")\nprint(f\"Key: {AZURE_SEARCH_API_KEY[:10]}...\")\n\n# 인덱스 용량 초과\n# 오류: 413 Request Entity Too Large\n# 해결: 배치 크기 줄이기 또는 상위 계층으로 업그레이드\nbatch_size = 50  # 기본 100에서 줄임\n\n# 벡터 차원 불일치\n# 오류: Vector dimension mismatch\n# 해결: 인덱스 스키마와 임베딩 차원 일치 확인\ntest_embed = embeddings.embed_query(\"test\")\nprint(f\"임베딩 차원: {len(test_embed)}\")\nprint(\"인덱스 스키마에서 vector_search_dimensions 확인\")\n\n# 쿼리 제한\n# 오류: 429 Too Many Requests\n# 해결: 재시도 로직 구현 또는 계층 업그레이드\nimport time\nfrom tenacity import retry, stop_after_attempt, wait_exponential\n\n@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))\ndef search_with_retry(query):\n    return vector_store.similarity_search(query)\n```\n\n## 참고 자료\n\n### 공식 문서\n- [Azure AI Search 공식 문서](https://learn.microsoft.com/en-us/azure/search/)\n- [Azure AI Search Python SDK](https://learn.microsoft.com/en-us/python/api/overview/azure/search-documents-readme)\n- [벡터 검색 개요](https://learn.microsoft.com/en-us/azure/search/vector-search-overview)\n- [하이브리드 검색 가이드](https://learn.microsoft.com/en-us/azure/search/hybrid-search-overview)\n- [시맨틱 검색 문서](https://learn.microsoft.com/en-us/azure/search/semantic-search-overview)\n\n### LangChain 통합\n- [LangChain Azure Search 통합](https://python.langchain.com/docs/integrations/vectorstores/azuresearch)\n- [Azure OpenAI + RAG 샘플](https://github.com/Azure-Samples/azure-search-openai-demo)\n\n### 튜토리얼 및 샘플\n- [Azure AI Search Python Samples](https://github.com/Azure-Samples/azure-search-python-samples)\n- [Vector Search Samples](https://github.com/Azure/azure-search-vector-samples)\n- [ChatGPT + Enterprise Data](https://github.com/Azure-Samples/azure-search-openai-demo-csharp)\n\n### 커뮤니티\n- [Microsoft Q&A - Azure AI Search](https://learn.microsoft.com/en-us/answers/tags/156/azure-search)\n- [Azure Updates](https://azure.microsoft.com/en-us/updates/?product=search)\n- [Tech Community Blog](https://techcommunity.microsoft.com/t5/azure-ai-services-blog/bg-p/Azure-AI-Services-blog)\n\n",
    "supporting": [
      "04-Azure-AI-Search_files"
    ],
    "filters": [],
    "includes": {}
  }
}