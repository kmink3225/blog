{
  "hash": "0ce7db644d7200e89f9eb20a5b070ad1",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"한글 단어 리트리버 튜닝\"\nsubtitle: 검색기\ndescription: |\n  문서 검색을 위한 다양한 Retriever 패턴과 최적화 기법을 다룬다.\ncategories:\n  - AI\n  - RAG\n  - LangChain\nauthor: Kwangmin Kim\ndate: 12/31/2024\nformat: \n  html:\n    page-layout: full\n    code-fold: true\n    toc: true\n    number-sections: true\ndraft: False\nexecute:\n    eval: false\n---\n\n한글 형태소 분석기 라이브러리인 `kiwipiepy` 를 설치합니다.\n- [`kiwipiepy` 프로젝트 링크](https://github.com/bab2min/kiwipiepy)\n\n::: {#2d33c5d4 .cell execution_count=1}\n``` {.python .cell-code}\n# API 키를 환경변수로 관리하기 위한 설정 파일\nfrom dotenv import load_dotenv\n\n# API 키 정보 로드\nload_dotenv()\n```\n:::\n\n\n::: {#2ae93d13 .cell execution_count=2}\n``` {.python .cell-code}\n# LangSmith 추적을 설정합니다. https://smith.langchain.com\n# !pip install langchain-teddynote\nfrom langchain_teddynote import logging\n\n# 프로젝트 이름을 입력합니다.\nlogging.langsmith(\"CH10-Retriever\")\n```\n:::\n\n\n::: {#ec156f6b .cell execution_count=3}\n``` {.python .cell-code}\n# !pip install kiwipiepy\n```\n:::\n\n\n::: {#0813a5db .cell execution_count=4}\n``` {.python .cell-code}\nfrom kiwipiepy import Kiwi\n\nkiwi = Kiwi()\n```\n:::\n\n\n토큰화를 진행합니다.\n\n::: {#14ecc9ad .cell execution_count=5}\n``` {.python .cell-code}\nkiwi.tokenize(\"안녕하세요? 형태소 분석기 키위입니다\")\n```\n:::\n\n\n## 다양한 문장으로 테스트\n\n::: {#c456bb96 .cell execution_count=6}\n``` {.python .cell-code}\nfrom langchain.retrievers import EnsembleRetriever\nfrom langchain_community.retrievers import BM25Retriever\nfrom langchain_core.documents import Document\nfrom langchain.vectorstores import FAISS\nfrom langchain_openai import OpenAIEmbeddings\n\ndocs = [\n    Document(\n        page_content=\"금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.\"\n    ),\n    Document(\n        page_content=\"금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.\"\n    ),\n    Document(\n        page_content=\"저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.\"\n    ),\n    Document(\n        page_content=\"금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.\"\n    ),\n    Document(\n        page_content=\"금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.\"\n    ),\n    Document(\n        page_content=\"금보험은 저축성과를 극대화합니다. 특히 노후 대비 저축에 유리하게 구성되어 있습니다.\"\n    ),\n    Document(\n        page_content=\"금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.\"\n    ),\n]\n```\n:::\n\n\n::: {#bacccbc3 .cell execution_count=7}\n``` {.python .cell-code}\nfor doc in docs:\n    print(\" \".join([token.form for token in kiwi.tokenize(doc.page_content)]))\n```\n:::\n\n\n::: {#a136070e .cell execution_count=8}\n``` {.python .cell-code}\n# 토큰화 함수를 생성\ndef kiwi_tokenize(text):\n    return [token.form for token in kiwi.tokenize(text)]\n```\n:::\n\n\n### 실험: 다양한 종류의 검색기를 사용하여 검색 결과를 비교\n\n::: {#d2760598 .cell execution_count=9}\n``` {.python .cell-code}\nbm25 = BM25Retriever.from_documents(docs)\n\nkiwi_bm25 = BM25Retriever.from_documents(docs, preprocess_func=kiwi_tokenize)\n\nfaiss = FAISS.from_documents(docs, OpenAIEmbeddings()).as_retriever()\n\nbm25_faiss_73 = EnsembleRetriever(\n    retrievers=[bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.7, 0.3],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\nbm25_faiss_37 = EnsembleRetriever(\n    retrievers=[bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.3, 0.7],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\nkiwibm25_faiss_73 = EnsembleRetriever(\n    retrievers=[kiwi_bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.7, 0.3],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\nkiwibm25_faiss_37 = EnsembleRetriever(\n    retrievers=[kiwi_bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.3, 0.7],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\n\nretrievers = {\n    \"bm25\": bm25,\n    \"kiwi_bm25\": kiwi_bm25,\n    \"faiss\": faiss,\n    \"bm25_faiss_73\": bm25_faiss_73,\n    \"bm25_faiss_37\": bm25_faiss_37,\n    \"kiwi_bm25_faiss_73\": kiwibm25_faiss_73,\n    \"kiwi_bm25_faiss_37\": kiwibm25_faiss_37,\n}\n```\n:::\n\n\n::: {#42d4d6c2 .cell execution_count=10}\n``` {.python .cell-code}\ndef print_search_results(retrievers, query):\n    print(f\"Query: {query}\")\n    for name, retriever in retrievers.items():\n        print(f\"{name}    \\t: {retriever.invoke(query)[0].page_content}\")\n    print(\"===\" * 20)\n```\n:::\n\n\n검색 결과를 출력합니다.\n\n::: {#67b93b05 .cell execution_count=11}\n``` {.python .cell-code}\nprint_search_results(retrievers, \"금융보험\")\nprint_search_results(retrievers, \"금융 보험\")\nprint_search_results(retrievers, \"금융저축보험\")\nprint_search_results(retrievers, \"축산물 보험\")\nprint_search_results(retrievers, \"저축금융보험\")\nprint_search_results(retrievers, \"금융보씨 개인정보 조회\")\n```\n:::\n\n\n## Konlpy\n\n::: {#3504aeb3 .cell execution_count=12}\n``` {.python .cell-code}\n# !pip install konlpy\n```\n:::\n\n\n::: {#46d1a978 .cell execution_count=13}\n``` {.python .cell-code}\nfrom konlpy.tag import Kkma, Okt, Komoran, Hannanum\nfrom kiwipiepy import Kiwi\n\nkkma = Kkma()\nokt = Okt()\nkomoran = Komoran()\nhannanum = Hannanum()\nkiwi = Kiwi()\n```\n:::\n\n\n::: {#ee7ff84f .cell execution_count=14}\n``` {.python .cell-code}\ntext = \"안녕하세요? 형태소 분석기 테스트베드입니다.\"\n```\n:::\n\n\n::: {#538de1cb .cell execution_count=15}\n``` {.python .cell-code}\nprint(\"kkma    : \\t\", end=\"\")\nprint(\" \".join(kkma.morphs(text)))\nprint(\"okt     : \\t\", end=\"\")\nprint(\" \".join(okt.morphs(text)))\nprint(\"komoran : \\t\", end=\"\")\nprint(\" \".join(komoran.morphs(text)))\nprint(\"hannanum: \\t\", end=\"\")\nprint(\" \".join(hannanum.morphs(text)))\nprint(\"kiwi    : \\t\", end=\"\")\nprint(\" \".join([tok.form for tok in kiwi.tokenize(text)]))\n```\n:::\n\n\n::: {#5a91a703 .cell execution_count=16}\n``` {.python .cell-code}\nkiwi.add_user_word(\"안녕하세요 반가워요\", \"NNP\", 0)\n```\n:::\n\n\n::: {#fb444e31 .cell execution_count=17}\n``` {.python .cell-code}\nprint(\"kiwi    : \\t\", end=\"\")\nprint(\" \".join([tok.form for tok in kiwi.tokenize(text)]))\n```\n:::\n\n\n::: {#3d5120ba .cell execution_count=18}\n``` {.python .cell-code}\ndef kkma_tokenize(text):\n    return [token for token in kkma.morphs(text)]\n```\n:::\n\n\n::: {#4e4ed7e8 .cell execution_count=19}\n``` {.python .cell-code}\ndef okt_tokenize(text):\n    return [token for token in okt.morphs(text)]\n```\n:::\n\n\n::: {#73564c90 .cell execution_count=20}\n``` {.python .cell-code}\nkkma_bm25 = BM25Retriever.from_documents(docs, preprocess_func=kkma_tokenize)\nkkma_bm25_faiss_73 = EnsembleRetriever(\n    retrievers=[kkma_bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.7, 0.3],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\nkkma_bm25_faiss_37 = EnsembleRetriever(\n    retrievers=[kkma_bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.3, 0.7],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\n\nokt_bm25 = BM25Retriever.from_documents(docs, preprocess_func=okt_tokenize)\nokt_bm25_faiss_73 = EnsembleRetriever(\n    retrievers=[okt_bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.7, 0.3],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\nokt_bm25_faiss_37 = EnsembleRetriever(\n    retrievers=[okt_bm25, faiss],  # 사용할 검색 모델의 리스트\n    weights=[0.3, 0.7],  # 각 검색 모델의 결과에 적용할 가중치\n    search_type=\"mmr\",  # 검색 결과의 다양성을 증진시키는 MMR 방식을 사용\n)\n\nretrievers = {\n    \"bm25\": bm25,\n    \"kiwi_bm25\": kiwi_bm25,\n    \"faiss\": faiss,\n    \"bm25_faiss_73\": bm25_faiss_73,\n    \"bm25_faiss_37\": bm25_faiss_37,\n    \"kiwi_bm25_faiss_73\": kiwibm25_faiss_73,\n    \"kiwi_bm25_faiss_37\": kiwibm25_faiss_37,\n    \"kkma_bm25\": kkma_bm25,\n    \"kkma_bm25_faiss_73\": kkma_bm25_faiss_73,\n    \"kkma_bm25_faiss_37\": kkma_bm25_faiss_37,\n    \"okt_bm25\": okt_bm25,\n    \"okt_bm25_faiss_73\": okt_bm25_faiss_73,\n    \"okt_bm25_faiss_37\": okt_bm25_faiss_37,\n}\n```\n:::\n\n\n::: {#0711bcca .cell execution_count=21}\n``` {.python .cell-code}\nprint_search_results(retrievers, \"금융보험\")\nprint_search_results(retrievers, \"금융 보험\")\nprint_search_results(retrievers, \"금융저축보험\")\nprint_search_results(retrievers, \"축산물 보험\")\nprint_search_results(retrievers, \"저축금융보험\")\nprint_search_results(retrievers, \"금융보씨 개인정보 조회\")\n```\n:::\n\n\n",
    "supporting": [
      "10-Kiwi-BM25Retriever_files"
    ],
    "filters": [],
    "includes": {}
  }
}