<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>메시지 기록(메모리) 추가하기 – Kwangmin Kim</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="../../../../../">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "algolia": {
    "application-id": "DUOR1DRC9D",
    "search-only-api-key": "f264da5dea684ffb9e9b4a574af3ed61",
    "index-name": "prod_QUARTO",
    "analytics-events": true,
    "show-logo": true,
    "libDir": "site_libs"
  },
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": true,
  "language": {
    "search-no-results-text": "일치 없음",
    "search-matching-documents-text": "일치된 문서",
    "search-copy-link-title": "검색 링크 복사",
    "search-hide-matches-text": "추가 검색 결과 숨기기",
    "search-more-match-text": "추가 검색결과",
    "search-more-matches-text": "추가 검색결과",
    "search-clear-button-title": "제거",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "취소",
    "search-submit-button-title": "검색",
    "search-label": "검색"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>


<script type="text/javascript">
var ALGOLIA_INSIGHTS_SRC = "https://cdn.jsdelivr.net/npm/search-insights/dist/search-insights.iife.min.js";
!function(e,a,t,n,s,i,c){e.AlgoliaAnalyticsObject=s,e[s]=e[s]||function(){
(e[s].queue=e[s].queue||[]).push(arguments)},i=a.createElement(t),c=a.getElementsByTagName(t)[0],
i.async=1,i.src=n,c.parentNode.insertBefore(i,c)
}(window,document,"script",ALGOLIA_INSIGHTS_SRC,"aa");
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-plugin-algolia-insights">

</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6W0EKFMWBN"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-6W0EKFMWBN', { 'anonymize_ip': true});
</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: black;
      }

      .quarto-title-block .quarto-title-banner {
        color: black;
background: #EDF3F9;
      }
</style>
<style>
.custom-footer { 
  text-align: center; 
  font-size: 0.8em; 
  color: #666; 
  margin-top: 2rem; 
}
</style>


<link rel="stylesheet" href="../../../../../styles.css">
<meta property="og:title" content="메시지 기록(메모리) 추가하기 – Kwangmin Kim">
<meta property="og:description" content="blog">
<meta property="og:site_name" content="Kwangmin Kim">
<meta name="twitter:title" content="메시지 기록(메모리) 추가하기 – Kwangmin Kim">
<meta name="twitter:description" content="blog">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../../.././images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Kwangmin Kim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="검색"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="탐색 전환" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../about.html"> 
<span class="menu-text">Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kmink3225"> <i class="bi bi-github" role="img" aria-label="Github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/kwangmin-kim-a5241b200/"> <i class="bi bi-linkedin" role="img" aria-label="Linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="다크 모드 전환"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">메시지 기록(메모리) 추가하기</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">목차</h2>
   
  <ul>
  <li><a href="#튜토리얼" id="toc-튜토리얼" class="nav-link active" data-scroll-target="#튜토리얼"><span class="header-section-number">1</span> 튜토리얼</a></li>
  <li><a href="#휘발성-대화기록-인메모리in-memory" id="toc-휘발성-대화기록-인메모리in-memory" class="nav-link" data-scroll-target="#휘발성-대화기록-인메모리in-memory"><span class="header-section-number">2</span> 휘발성 대화기록: 인메모리(In-Memory)</a></li>
  <li><a href="#다양한-key를-사용한-runnable-을-사용한-예시" id="toc-다양한-key를-사용한-runnable-을-사용한-예시" class="nav-link" data-scroll-target="#다양한-key를-사용한-runnable-을-사용한-예시"><span class="header-section-number">3</span> 다양한 Key를 사용한 Runnable 을 사용한 예시</a>
  <ul class="collapse">
  <li><a href="#messages-객체를-입력-dict-형태의-출력" id="toc-messages-객체를-입력-dict-형태의-출력" class="nav-link" data-scroll-target="#messages-객체를-입력-dict-형태의-출력"><span class="header-section-number">3.1</span> Messages 객체를 입력, dict 형태의 출력</a></li>
  <li><a href="#messages-객체를-입력-messages-객체의-출력" id="toc-messages-객체를-입력-messages-객체의-출력" class="nav-link" data-scroll-target="#messages-객체를-입력-messages-객체의-출력"><span class="header-section-number">3.2</span> Messages 객체를 입력, Messages 객체의 출력</a></li>
  </ul></li>
  <li><a href="#영구-저장소persistent-storage" id="toc-영구-저장소persistent-storage" class="nav-link" data-scroll-target="#영구-저장소persistent-storage"><span class="header-section-number">4</span> 영구 저장소(Persistent storage)</a>
  <ul class="collapse">
  <li><a href="#redis-설치" id="toc-redis-설치" class="nav-link" data-scroll-target="#redis-설치"><span class="header-section-number">4.1</span> Redis 설치</a></li>
  <li><a href="#redis-서버-구동" id="toc-redis-서버-구동" class="nav-link" data-scroll-target="#redis-서버-구동"><span class="header-section-number">4.2</span> Redis 서버 구동</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><code>RunnableWithMessageHistory</code>를 활용하여 특정 유형의 작업(체인)에 메시지 기록을 추가하는 것은 프로그래밍에서 상당히 유용한 기능입니다.</p>
<p>이 기능은 특히 대화형 애플리케이션 또는 복잡한 데이터 처리 작업을 구현할 때 이전 메시지의 맥락을 유지해야 할 필요가 있을 때 중요합니다.</p>
<p>메시지 기록을 관리함으로써, 개발자는 애플리케이션의 흐름을 더 잘 제어하고, 사용자의 이전 요청에 따라 적절하게 응답할 수 있습니다.</p>
<p><strong>실제 활용 예시</strong></p>
<ul>
<li>대화형 챗봇 개발: 사용자와의 대화 내역을 기반으로 챗봇의 응답을 조정할 수 있습니다.</li>
<li>복잡한 데이터 처리: 데이터 처리 과정에서 이전 단계의 결과를 참조하여 다음 단계의 로직을 결정할 수 있습니다.</li>
<li>상태 관리가 필요한 애플리케이션: 사용자의 이전 선택을 기억하고 그에 따라 다음 화면이나 정보를 제공할 수 있습니다.</li>
</ul>
<p><code>RunnableWithMessageHistory</code>는 애플리케이션의 상태를 유지하고, 사용자 경험을 향상시키며, 더 정교한 응답 메커니즘을 구현할 수 있게 해주는 강력한 도구입니다.</p>
<section id="튜토리얼" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="튜토리얼"><span class="header-section-number">1</span> 튜토리얼</h2>
<div id="d983209b" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-01T14:45:12.355628Z&quot;,&quot;start_time&quot;:&quot;2024-04-01T14:45:11.678242Z&quot;}" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">from</span> langchain_core.prompts <span class="im">import</span> ChatPromptTemplate, MessagesPlaceholder</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">from</span> langchain_openai <span class="im">import</span> ChatOpenAI</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a>model <span class="op">=</span> ChatOpenAI()</span>
<span id="cb1-5"><a href="#cb1-5"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb1-6"><a href="#cb1-6"></a>    [</span>
<span id="cb1-7"><a href="#cb1-7"></a>        (</span>
<span id="cb1-8"><a href="#cb1-8"></a>            <span class="st">"system"</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>            <span class="st">"당신은 </span><span class="sc">{ability}</span><span class="st"> 에 능숙한 어시스턴트입니다. 20자 이내로 응답하세요"</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>        ),</span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="co"># 대화 기록을 변수로 사용, history 가 MessageHistory 의 key 가 됨</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>        MessagesPlaceholder(variable_name<span class="op">=</span><span class="st">"history"</span>),</span>
<span id="cb1-13"><a href="#cb1-13"></a>        (<span class="st">"human"</span>, <span class="st">"</span><span class="sc">{input}</span><span class="st">"</span>),  <span class="co"># 사용자 입력을 변수로 사용</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    ]</span>
<span id="cb1-15"><a href="#cb1-15"></a>)</span>
<span id="cb1-16"><a href="#cb1-16"></a>runnable <span class="op">=</span> prompt <span class="op">|</span> model  <span class="co"># 프롬프트와 모델을 연결하여 runnable 객체 생성</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>메시지 기록을 관리하는 것은 대화형 애플리케이션 또는 복잡한 데이터 처리 작업에서 매우 중요합니다. 메시지 기록을 효과적으로 관리하려면 다음 두 가지 주요 요소가 필요합니다.</p>
<ol type="1">
<li><p><strong>Runnable</strong>: 주로 Retriever, Chain 과 같이 <code>BaseChatMessageHistory</code> 와 상호작용하는 <code>runnable</code> 객체입니다.</p></li>
<li><p><strong><code>BaseChatMessageHistory</code>의 인스턴스를 반환하는 호출 가능한 객체(callable)</strong>: 메시지 기록을 관리하기 위한 객체입니다. 이 객체는 메시지 기록을 저장, 검색, 업데이트하는 데 사용됩니다. 메시지 기록은 대화의 맥락을 유지하고, 사용자의 이전 입력에 기반한 응답을 생성하는 데 필요합니다.</p></li>
</ol>
<p>메시지 기록을 구현하는 데에는 여러 방법이 있으며, <a href="https://integrations.langchain.com/memory">memory integrations</a> 페이지에는 다양한 저장소 옵션과 통합 방법이 소개되어 있습니다.</p>
<p>여기서는 두 가지 주요 방법을 살펴보겠습니다.</p>
<ol type="1">
<li><p><strong>인메모리 <code>ChatMessageHistory</code> 사용</strong></p>
<ul>
<li>이 방법은 메모리 내에서 메시지 기록을 관리합니다. 주로 개발 단계나 간단한 애플리케이션에서 사용됩니다. 인메모리 방식은 빠른 접근 속도를 제공하지만, 애플리케이션을 재시작할 때 메시지 기록이 사라지는 단점이 있습니다.</li>
</ul></li>
<li><p><strong><code>RedisChatMessageHistory</code>를 사용하여 영구적인 저장소 활용</strong></p>
<ul>
<li>Redis를 사용하는 방법은 메시지 기록을 영구적으로 저장할 수 있게 해줍니다. Redis는 높은 성능을 제공하는 오픈 소스 인메모리 데이터 구조 저장소로, 분산 환경에서도 안정적으로 메시지 기록을 관리할 수 있습니다. 이 방법은 복잡한 애플리케이션 또는 장기간 운영되는 서비스에 적합합니다.</li>
</ul></li>
</ol>
<p>메시지 기록을 관리하는 방법을 선택할 때는 애플리케이션의 요구사항, 예상되는 트래픽 양, 메시지 데이터의 중요성 및 보존 기간 등을 고려해야 합니다. 인메모리 방식은 구현이 간단하고 빠르지만, 데이터의 영구성이 요구되는 경우 Redis와 같은 영구적인 저장소를 사용하는 것이 더 적합할 수 있습니다.</p>
</section>
<section id="휘발성-대화기록-인메모리in-memory" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="휘발성-대화기록-인메모리in-memory"><span class="header-section-number">2</span> 휘발성 대화기록: 인메모리(In-Memory)</h2>
<p>아래는 채팅 기록이 메모리에 저장되는 간단한 예시입니다.</p>
<p><code>RunnableWithMessageHistory</code> 설정 매개변수</p>
<ul>
<li><code>runnable</code></li>
<li><code>BaseChatMessageHistory</code> 이거나 상속받은 객체. ex) <code>ChatMessageHistory</code></li>
<li><code>input_messages_key</code>: chain 을 invoke() 할때 사용자 쿼리 입력으로 지정하는 key</li>
<li><code>history_messages_key</code>: 대화 기록으로 지정하는 key</li>
</ul>
<div id="9abe1aa9" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-01T14:43:22.819500Z&quot;,&quot;start_time&quot;:&quot;2024-04-01T14:43:22.798856Z&quot;}" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">from</span> langchain_community.chat_message_histories <span class="im">import</span> ChatMessageHistory</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">from</span> langchain_core.chat_history <span class="im">import</span> BaseChatMessageHistory</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">from</span> langchain_core.runnables.history <span class="im">import</span> RunnableWithMessageHistory</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a>store <span class="op">=</span> {}  <span class="co"># 세션 기록을 저장할 딕셔너리</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># 세션 ID를 기반으로 세션 기록을 가져오는 함수</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">def</span> get_session_history(session_ids: <span class="bu">str</span>) <span class="op">-&gt;</span> BaseChatMessageHistory:</span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="bu">print</span>(session_ids)</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="cf">if</span> session_ids <span class="kw">not</span> <span class="kw">in</span> store:  <span class="co"># 세션 ID가 store에 없는 경우</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>        <span class="co"># 새로운 ChatMessageHistory 객체를 생성하여 store에 저장</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>        store[session_ids] <span class="op">=</span> ChatMessageHistory()</span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="cf">return</span> store[session_ids]  <span class="co"># 해당 세션 ID에 대한 세션 기록 반환</span></span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a>with_message_history <span class="op">=</span> (</span>
<span id="cb2-18"><a href="#cb2-18"></a>    RunnableWithMessageHistory(  <span class="co"># RunnableWithMessageHistory 객체 생성</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>        runnable,  <span class="co"># 실행할 Runnable 객체</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>        get_session_history,  <span class="co"># 세션 기록을 가져오는 함수</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>        input_messages_key<span class="op">=</span><span class="st">"input"</span>,  <span class="co"># 입력 메시지의 키</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>        history_messages_key<span class="op">=</span><span class="st">"history"</span>,  <span class="co"># 기록 메시지의 키</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>    )</span>
<span id="cb2-24"><a href="#cb2-24"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>input_messages_key</code>는 최신 입력 메시지로 처리될 키를 지정하고, <code>history_messages_key</code>는 이전 메시지를 추가할 키를 지정합니다.</p>
<p>다음의 코드를 보면 <code>RunnableWithMessageHistory</code> 의 초기값에 <code>session_id</code> 키를 Default 로 삽입하는 것을 볼 수 있으며, 이 코드로 인하여 <code>RunnableWithMessageHistory</code> 는 대화 스레드 관리를 <code>session_id</code> 로 한다는 것을 간접적으로 알 수 있습니다.</p>
<p>즉, 대화 스레드별 관리는 <code>session_id</code> 별로 구현함을 알 수 있습니다.</p>
<p>참고 코드: <code>RunnableWithMessageHistory</code> 구현을 참고해 보면,</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="cf">if</span> history_factory_config:</span>
<span id="cb3-2"><a href="#cb3-2"></a>    _config_specs <span class="op">=</span> history_factory_config</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="cf">else</span>:</span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="co"># If not provided, then we'll use the default session_id field</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    _config_specs <span class="op">=</span> [</span>
<span id="cb3-6"><a href="#cb3-6"></a>        ConfigurableFieldSpec(</span>
<span id="cb3-7"><a href="#cb3-7"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"session_id"</span>,</span>
<span id="cb3-8"><a href="#cb3-8"></a>            annotation<span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb3-9"><a href="#cb3-9"></a>            name<span class="op">=</span><span class="st">"Session ID"</span>,</span>
<span id="cb3-10"><a href="#cb3-10"></a>            description<span class="op">=</span><span class="st">"Unique identifier for a session."</span>,</span>
<span id="cb3-11"><a href="#cb3-11"></a>            default<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb3-12"><a href="#cb3-12"></a>            is_shared<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-13"><a href="#cb3-13"></a>        ),</span>
<span id="cb3-14"><a href="#cb3-14"></a>    ]</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>따라서, <code>invoke()</code> 시 <code>config={"configurable": {"session_id": "세션ID입력"}}</code> 코드를 반드시 지정해 주어야 합니다.</p>
<div id="365e124d" class="cell" data-execution_count="106">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>with_message_history.invoke(</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="co"># 수학 관련 질문 "코사인의 의미는 무엇인가요?"를 입력으로 전달합니다.</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"What does cosine mean?"</span>},</span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="co"># 설정 정보로 세션 ID "abc123"을 전달합니다.</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"abc123"</span>}},</span>
<span id="cb4-6"><a href="#cb4-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>abc123</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>AIMessage(content='A trigonometric function that relates the adjacent side of a right triangle to its hypotenuse.', response_metadata={'token_usage': {'completion_tokens': 20, 'prompt_tokens': 146, 'total_tokens': 166}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<p>같은 <code>session_id</code> 를 입력하면 이전 대화 스레드의 내용을 가져오기 때문에 이어서 대화가 가능합니다!</p>
<div id="531ea924" class="cell" data-execution_count="104">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># 메시지 기록을 포함하여 호출합니다.</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>with_message_history.invoke(</span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="co"># 능력과 입력을 설정합니다.</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"이전의 내용을 한글로 답변해 주세요."</span>},</span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="co"># 설정 옵션을 지정합니다.</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"abc123"</span>}},</span>
<span id="cb7-7"><a href="#cb7-7"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>abc123</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>AIMessage(content='직각삼각형의 인접변과 빗변 간의 관계를 나타내는 삼각함수입니다.', response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 90, 'total_tokens': 133}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<p>하지만 다른 <code>session_id</code> 를 지정하면 대화기록이 없기 때문에 답변을 제대로 수행하지 못합니다.</p>
<p>(아래의 예시는 <code>session_id</code>: <code>def234</code> 는 존재하지 않기 때문에 엉뚱한 답변을 하는 것을 확인할 수 있습니다)</p>
<div id="34e5cac7" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># 새로운 session_id로 인해 이전 대화 내용을 기억하지 않습니다.</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>with_message_history.invoke(</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="co"># 수학 능력과 입력 메시지를 전달합니다.</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"이전의 내용을 한글로 답변해 주세요"</span>},</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="co"># 새로운 session_id를 설정합니다.</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"def234"</span>}},</span>
<span id="cb10-7"><a href="#cb10-7"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>def234</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>AIMessage(content='수학에 능숙한 어시스턴트입니다.', response_metadata={'token_usage': {'completion_tokens': 19, 'prompt_tokens': 58, 'total_tokens': 77}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<p>메시지 기록을 추적하는 데 사용되는 구성 매개변수는 <code>ConfigurableFieldSpec</code> 객체의 리스트를 <code>history_factory_config</code> 매개변수로 전달하여 사용자 정의할 수 있습니다.</p>
<p>이렇게 <code>history_factory_config</code> 를 새로 설정하게 되면 기존 <code>session_id</code> 설정을 덮어쓰게 됩니다.</p>
<p>아래 예시에서는 <code>user_id</code>와 <code>conversation_id</code>라는 두 가지 매개변수를 사용합니다.</p>
<div id="fcc58e17" class="cell" data-execution_count="109">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="im">from</span> langchain_core.runnables <span class="im">import</span> ConfigurableFieldSpec</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>store <span class="op">=</span> {}  <span class="co"># 빈 딕셔너리를 초기화합니다.</span></span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">def</span> get_session_history(user_id: <span class="bu">str</span>, conversation_id: <span class="bu">str</span>) <span class="op">-&gt;</span> BaseChatMessageHistory:</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="co"># 주어진 user_id와 conversation_id에 해당하는 세션 기록을 반환합니다.</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="cf">if</span> (user_id, conversation_id) <span class="kw">not</span> <span class="kw">in</span> store:</span>
<span id="cb13-9"><a href="#cb13-9"></a>        <span class="co"># 해당 키가 store에 없으면 새로운 ChatMessageHistory를 생성하여 저장합니다.</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>        store[(user_id, conversation_id)] <span class="op">=</span> ChatMessageHistory()</span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="cf">return</span> store[(user_id, conversation_id)]</span>
<span id="cb13-12"><a href="#cb13-12"></a></span>
<span id="cb13-13"><a href="#cb13-13"></a></span>
<span id="cb13-14"><a href="#cb13-14"></a>with_message_history <span class="op">=</span> RunnableWithMessageHistory(</span>
<span id="cb13-15"><a href="#cb13-15"></a>    runnable,</span>
<span id="cb13-16"><a href="#cb13-16"></a>    get_session_history,</span>
<span id="cb13-17"><a href="#cb13-17"></a>    input_messages_key<span class="op">=</span><span class="st">"input"</span>,</span>
<span id="cb13-18"><a href="#cb13-18"></a>    history_messages_key<span class="op">=</span><span class="st">"history"</span>,</span>
<span id="cb13-19"><a href="#cb13-19"></a>    history_factory_config<span class="op">=</span>[  <span class="co"># 기존의 "session_id" 설정을 대체하게 됩니다.</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>        ConfigurableFieldSpec(</span>
<span id="cb13-21"><a href="#cb13-21"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"user_id"</span>,  <span class="co"># get_session_history 함수의 첫 번째 인자로 사용됩니다.</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>            annotation<span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb13-23"><a href="#cb13-23"></a>            name<span class="op">=</span><span class="st">"User ID"</span>,</span>
<span id="cb13-24"><a href="#cb13-24"></a>            description<span class="op">=</span><span class="st">"사용자의 고유 식별자입니다."</span>,</span>
<span id="cb13-25"><a href="#cb13-25"></a>            default<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb13-26"><a href="#cb13-26"></a>            is_shared<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-27"><a href="#cb13-27"></a>        ),</span>
<span id="cb13-28"><a href="#cb13-28"></a>        ConfigurableFieldSpec(</span>
<span id="cb13-29"><a href="#cb13-29"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"conversation_id"</span>,  <span class="co"># get_session_history 함수의 두 번째 인자로 사용됩니다.</span></span>
<span id="cb13-30"><a href="#cb13-30"></a>            annotation<span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb13-31"><a href="#cb13-31"></a>            name<span class="op">=</span><span class="st">"Conversation ID"</span>,</span>
<span id="cb13-32"><a href="#cb13-32"></a>            description<span class="op">=</span><span class="st">"대화의 고유 식별자입니다."</span>,</span>
<span id="cb13-33"><a href="#cb13-33"></a>            default<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb13-34"><a href="#cb13-34"></a>            is_shared<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-35"><a href="#cb13-35"></a>        ),</span>
<span id="cb13-36"><a href="#cb13-36"></a>    ],</span>
<span id="cb13-37"><a href="#cb13-37"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="5c3974ca" class="cell" data-execution_count="111">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>with_message_history.invoke(</span>
<span id="cb14-2"><a href="#cb14-2"></a>    <span class="co"># 능력(ability)과 입력(input)을 포함한 딕셔너리를 전달합니다.</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"what is cosine?"</span>},</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="co"># 설정(config) 딕셔너리를 전달합니다.</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"user_id"</span>: <span class="st">"123"</span>, <span class="st">"conversation_id"</span>: <span class="st">"abc"</span>}},</span>
<span id="cb14-6"><a href="#cb14-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="111">
<pre><code>AIMessage(content='Trigonometric function relating the adjacent side to the hypotenuse in a right triangle.', response_metadata={'token_usage': {'completion_tokens': 18, 'prompt_tokens': 46, 'total_tokens': 64}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_b28b39ffa8', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<div id="d45e28d5" class="cell" data-execution_count="114">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>answer <span class="op">=</span> with_message_history.invoke(</span>
<span id="cb16-2"><a href="#cb16-2"></a>    <span class="co"># 능력(ability)과 입력(input)을 포함한 딕셔너리를 전달합니다.</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"이전의 답변을 한글로 작성해 주세요"</span>},</span>
<span id="cb16-4"><a href="#cb16-4"></a>    <span class="co"># 설정(config) 딕셔너리를 전달합니다.</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"user_id"</span>: <span class="st">"123"</span>, <span class="st">"conversation_id"</span>: <span class="st">"abc"</span>}},</span>
<span id="cb16-6"><a href="#cb16-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="다양한-key를-사용한-runnable-을-사용한-예시" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="다양한-key를-사용한-runnable-을-사용한-예시"><span class="header-section-number">3</span> 다양한 Key를 사용한 Runnable 을 사용한 예시</h2>
<section id="messages-객체를-입력-dict-형태의-출력" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="messages-객체를-입력-dict-형태의-출력"><span class="header-section-number">3.1</span> Messages 객체를 입력, dict 형태의 출력</h3>
<p>메시지를 입력으로 받고 딕셔너리를 출력으로 반환하는 경우입니다.</p>
<ul>
<li></li>
</ul>
<div id="676e8b5d" class="cell" data-execution_count="117">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">from</span> langchain_core.messages <span class="im">import</span> HumanMessage</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="im">from</span> langchain_core.runnables <span class="im">import</span> RunnableParallel</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co"># chain 생성</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>chain <span class="op">=</span> RunnableParallel({<span class="st">"output_message"</span>: ChatOpenAI()})</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="kw">def</span> get_session_history(session_id: <span class="bu">str</span>) <span class="op">-&gt;</span> BaseChatMessageHistory:</span>
<span id="cb17-9"><a href="#cb17-9"></a>    <span class="co"># 세션 ID에 해당하는 대화 기록이 저장소에 없으면 새로운 ChatMessageHistory를 생성합니다.</span></span>
<span id="cb17-10"><a href="#cb17-10"></a>    <span class="cf">if</span> session_id <span class="kw">not</span> <span class="kw">in</span> store:</span>
<span id="cb17-11"><a href="#cb17-11"></a>        store[session_id] <span class="op">=</span> ChatMessageHistory()</span>
<span id="cb17-12"><a href="#cb17-12"></a>    <span class="co"># 세션 ID에 해당하는 대화 기록을 반환합니다.</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>    <span class="cf">return</span> store[session_id]</span>
<span id="cb17-14"><a href="#cb17-14"></a></span>
<span id="cb17-15"><a href="#cb17-15"></a></span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="co"># 체인에 대화 기록 기능을 추가한 RunnableWithMessageHistory 객체를 생성합니다.</span></span>
<span id="cb17-17"><a href="#cb17-17"></a>with_message_history <span class="op">=</span> RunnableWithMessageHistory(</span>
<span id="cb17-18"><a href="#cb17-18"></a>    chain,</span>
<span id="cb17-19"><a href="#cb17-19"></a>    get_session_history,</span>
<span id="cb17-20"><a href="#cb17-20"></a>    <span class="co"># 입력 메시지의 키를 "input"으로 설정합니다.(생략시 Message 객체로 입력)</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>    <span class="co"># input_messages_key="input",</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>    <span class="co"># 출력 메시지의 키를 "output_message"로 설정합니다. (생략시 Message 객체로 출력)</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>    output_messages_key<span class="op">=</span><span class="st">"output_message"</span>,</span>
<span id="cb17-24"><a href="#cb17-24"></a>)</span>
<span id="cb17-25"><a href="#cb17-25"></a></span>
<span id="cb17-26"><a href="#cb17-26"></a><span class="co"># 주어진 메시지와 설정으로 체인을 실행합니다.</span></span>
<span id="cb17-27"><a href="#cb17-27"></a>with_message_history.invoke(</span>
<span id="cb17-28"><a href="#cb17-28"></a>    <span class="co"># 혹은 "what is the definition of cosine?" 도 가능</span></span>
<span id="cb17-29"><a href="#cb17-29"></a>    [HumanMessage(content<span class="op">=</span><span class="st">"what is the definition of cosine?"</span>)],</span>
<span id="cb17-30"><a href="#cb17-30"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"abc123"</span>}},</span>
<span id="cb17-31"><a href="#cb17-31"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>{'output_message': AIMessage(content='In mathematics, the cosine of an angle in a right-angled triangle is defined as the ratio of the length of the side adjacent to the angle to the length of the hypotenuse. It is one of the basic trigonometric functions and is abbreviated as cos.', response_metadata={'token_usage': {'completion_tokens': 54, 'prompt_tokens': 14, 'total_tokens': 68}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})}</code></pre>
</div>
</div>
<div id="2324aea1" class="cell" data-execution_count="72">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>with_message_history.invoke(</span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="co"># 이전의 답변에 대하여 한글로 답변을 재요청합니다.</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    [HumanMessage(content<span class="op">=</span><span class="st">"이전의 내용을 한글로 답변해 주세요!"</span>)],</span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="co"># 설정 옵션을 딕셔너리 형태로 전달합니다.</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"abc123"</span>}},</span>
<span id="cb19-6"><a href="#cb19-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>{'output_message': AIMessage(content='코사인 함수는 주어진 각도의 코사인 값을 반환하는 삼각함수로, 직각삼각형에서 인접 변의 길이와 빗변의 길이의 비율을 나타냅니다. 수학적으로, 각도 θ에 대한 코사인 값은 그 각도를 가지는 직각삼각형의 인접 변의 길이를 빗변의 길이로 나눈 것으로 정의됩니다. 코사인 함수는 일반적으로 "cos"로 표기되며, 각도는 일반적으로 라디안 단위로 표현됩니다.', response_metadata={'token_usage': {'completion_tokens': 187, 'prompt_tokens': 1020, 'total_tokens': 1207}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})}</code></pre>
</div>
</div>
</section>
<section id="messages-객체를-입력-messages-객체의-출력" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="messages-객체를-입력-messages-객체의-출력"><span class="header-section-number">3.2</span> Messages 객체를 입력, Messages 객체의 출력</h3>
<ul>
<li></li>
</ul>
<div id="07d90e3d" class="cell" data-execution_count="118">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>with_message_history <span class="op">=</span> RunnableWithMessageHistory(</span>
<span id="cb21-2"><a href="#cb21-2"></a>    ChatOpenAI(),  <span class="co"># ChatOpenAI 언어 모델을 사용합니다.</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>    get_session_history,  <span class="co"># 대화 세션 기록을 가져오는 함수를 지정합니다.</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>    <span class="co"># 입력 메시지의 키를 "input"으로 설정합니다.(생략시 Message 객체로 입력)</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>    <span class="co"># input_messages_key="input",</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>    <span class="co"># 출력 메시지의 키를 "output_message"로 설정합니다. (생략시 Message 객체로 출력)</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>    <span class="co"># output_messages_key="output_message",</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="91fdb0e5" class="cell" data-execution_count="119">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>with_message_history.invoke(</span>
<span id="cb22-2"><a href="#cb22-2"></a>    <span class="co"># 이전의 답변에 대하여 한글로 답변을 재요청합니다.</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>    [HumanMessage(content<span class="op">=</span><span class="st">"코사인의 의미는 무엇인가요?"</span>)],</span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="co"># 설정 옵션을 딕셔너리 형태로 전달합니다.</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"def123"</span>}},</span>
<span id="cb22-6"><a href="#cb22-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Error in RootListenersTracer.on_llm_end callback: KeyError('input')</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>AIMessage(content='코사인은 삼각함수 중 하나로, 직각삼각형에서의 각도에 대해 대변과 빗변의 비율을 나타내는 값입니다. 코사인 함수는 주어진 각도에 대해 코사인 값을 계산해주는 함수이며, 삼각형의 변 길이를 이용해 각도를 구하거나 각도를 이용해 변 길이를 구하는 데 사용됩니다. 코사인은 삼각형의 오른쪽 변에 인접한 변과 빗변의 비율을 의미하며, 각도가 90도일 때 1이 되는 값입니다.', response_metadata={'token_usage': {'completion_tokens': 191, 'prompt_tokens': 24, 'total_tokens': 215}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_b28b39ffa8', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<section id="모든-메시지-입력과-출력을-위한-단일-키를-가진-dict" class="level4" data-number="3.2.1">
<h4 data-number="3.2.1" class="anchored" data-anchor-id="모든-메시지-입력과-출력을-위한-단일-키를-가진-dict"><span class="header-section-number">3.2.1</span> 모든 메시지 입력과 출력을 위한 단일 키를 가진 Dict</h4>
<p>모든 입력 메시지와 출력 메시지에 대해 단일 키를 사용하는 방식입니다.</p>
<ul>
<li><code>itemgetter("input_messages")</code>를 사용하여 입력 메시지를 추출합니다.</li>
</ul>
<div id="ee02f522" class="cell" data-execution_count="120">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="im">from</span> operator <span class="im">import</span> itemgetter</span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a>with_message_history <span class="op">=</span> RunnableWithMessageHistory(</span>
<span id="cb25-4"><a href="#cb25-4"></a>    <span class="co"># "input_messages" 키를 사용하여 입력 메시지를 가져와 ChatOpenAI()에 전달합니다.</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>    itemgetter(<span class="st">"input_messages"</span>) <span class="op">|</span> ChatOpenAI(),</span>
<span id="cb25-6"><a href="#cb25-6"></a>    get_session_history,  <span class="co"># 세션 기록을 가져오는 함수입니다.</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>    input_messages_key<span class="op">=</span><span class="st">"input_messages"</span>,  <span class="co"># 입력 메시지의 키를 지정합니다.</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7b0f2b18" class="cell" data-execution_count="121">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>with_message_history.invoke(</span>
<span id="cb26-2"><a href="#cb26-2"></a>    {<span class="st">"input_messages"</span>: <span class="st">"코사인의 의미는 무엇인가요?"</span>},</span>
<span id="cb26-3"><a href="#cb26-3"></a>    <span class="co"># 설정 옵션을 딕셔너리 형태로 전달합니다.</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"xyz123"</span>}},</span>
<span id="cb26-5"><a href="#cb26-5"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>AIMessage(content='코사인은 삼각함수 중 하나로, 직각삼각형에서의 각도에 대해 대변과 빗변의 비율을 나타내는 함수입니다. 각도가 주어졌을 때 코사인 값은 삼각형에서 밑변과 빗변의 길이를 나타내는 비율을 의미합니다. 즉, 코사인은 각도에 대한 삼각비로서, 삼각형의 변의 길이와 각도 사이의 관계를 나타내는 중요한 개념입니다.', response_metadata={'token_usage': {'completion_tokens': 172, 'prompt_tokens': 24, 'total_tokens': 196}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="영구-저장소persistent-storage" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="영구-저장소persistent-storage"><span class="header-section-number">4</span> 영구 저장소(Persistent storage)</h2>
<p>영구 저장소(Persistent storage)는 프로그램이 종료되거나 시스템이 재부팅되더라도 데이터를 유지하는 저장 메커니즘을 말합니다. 이는 데이터베이스, 파일 시스템, 또는 기타 비휘발성 저장 장치를 통해 구현될 수 있습니다.</p>
<p>영구 저장소는 애플리케이션의 상태를 저장하고, 사용자 설정을 유지하며, <strong>장기간 데이터를 보존하는 데 필수적</strong>입니다. 이를 통해 프로그램은 이전 실행에서 중단된 지점부터 다시 시작할 수 있으며, <strong>사용자는 데이터 손실 없이 작업을 계속</strong> 할 수 있습니다.</p>
<ul>
<li><code>RunnableWithMessageHistory</code>는 <code>get_session_history</code> 호출 가능 객체가 채팅 메시지 기록을 어떻게 검색하는지에 대해 독립적입니다.</li>
<li>로컬 파일 시스템을 사용하는 예제는 <a href="https://github.com/langchain-ai/langserve/blob/main/examples/chat_with_persistence_and_user/server.py">여기</a>를 참조하세요.</li>
<li>아래에서는 <strong>Redis</strong> 를 사용하는 방법을 보여줍니다. 다른 제공자를 사용하여 채팅 메시지 기록을 구현하는 방법은 <a href="https://integrations.langchain.com/memory">memory integrations</a> 페이지를 확인하세요.</li>
</ul>
<section id="redis-설치" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="redis-설치"><span class="header-section-number">4.1</span> Redis 설치</h3>
<p>Redis가 설치되어 있지 않다면 먼저 설치해야 합니다.</p>
<div id="b577c06b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="op">%</span>pip install <span class="op">-</span>qU redis</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="redis-서버-구동" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="redis-서버-구동"><span class="header-section-number">4.2</span> Redis 서버 구동</h3>
<p>기존에 연결할 Redis 배포가 없는 경우, 로컬 Redis Stack 서버를 시작합니다.</p>
<p>다음은 Docker 로 Redis 서버를 구동하는 명령어입니다.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">-p</span> 6379:6379 <span class="at">-p</span> 8001:8001 redis/redis-stack:latest</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>REDIS_URL</code> 변수에 Redis 데이터베이스의 연결 URL을 할당합니다.</p>
<ul>
<li>URL은 <code>"redis://localhost:6379/0"</code>로 설정되어 있습니다.</li>
</ul>
<div id="c99a3ad4" class="cell" data-execution_count="122">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># Redis 서버의 URL을 지정합니다.</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>REDIS_URL <span class="op">=</span> <span class="st">"redis://localhost:6379/0"</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>LangSmith 추적 설정</strong></p>
<p>추적을 위한 LangSmith 를 설정합니다. LangSmith는 필수적인 것은 아니지만, 도움이 될 수 있습니다.</p>
<div id="fc02f43c" class="cell" data-execution_count="123">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="im">import</span> os</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a>load_dotenv()</span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="co"># LANGCHAIN_TRACING_V2 환경 변수를 "true"로 설정합니다.</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>os.environ[<span class="st">"LANGCHAIN_TRACING_V2"</span>] <span class="op">=</span> <span class="st">"true"</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="co"># LANGCHAIN_PROJECT 설정</span></span>
<span id="cb31-9"><a href="#cb31-9"></a>os.environ[<span class="st">"LANGCHAIN_PROJECT"</span>] <span class="op">=</span> <span class="st">"RunnableWithMessageHistory"</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>메시지 기록 구현을 업데이트하려면 새로운 호출 가능한 객체를 정의하고, 이번에는 RedisChatMessageHistory의 인스턴스를 반환하면 됩니다.</p>
<div id="42346b0d" class="cell" data-execution_count="124">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="im">from</span> langchain_community.chat_message_histories <span class="im">import</span> RedisChatMessageHistory</span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="kw">def</span> get_message_history(session_id: <span class="bu">str</span>) <span class="op">-&gt;</span> RedisChatMessageHistory:</span>
<span id="cb32-5"><a href="#cb32-5"></a>    <span class="co"># 세션 ID를 기반으로 RedisChatMessageHistory 객체를 반환합니다.</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>    <span class="cf">return</span> RedisChatMessageHistory(session_id, url<span class="op">=</span>REDIS_URL)</span>
<span id="cb32-7"><a href="#cb32-7"></a></span>
<span id="cb32-8"><a href="#cb32-8"></a></span>
<span id="cb32-9"><a href="#cb32-9"></a>with_message_history <span class="op">=</span> RunnableWithMessageHistory(</span>
<span id="cb32-10"><a href="#cb32-10"></a>    runnable,  <span class="co"># 실행 가능한 객체</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>    get_message_history,  <span class="co"># 메시지 기록을 가져오는 함수</span></span>
<span id="cb32-12"><a href="#cb32-12"></a>    input_messages_key<span class="op">=</span><span class="st">"input"</span>,  <span class="co"># 입력 메시지의 키</span></span>
<span id="cb32-13"><a href="#cb32-13"></a>    history_messages_key<span class="op">=</span><span class="st">"history"</span>,  <span class="co"># 기록 메시지의 키</span></span>
<span id="cb32-14"><a href="#cb32-14"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>이전과 동일한 방식으로 호출할 수 있습니다.</p>
<div id="084eead7" class="cell" data-execution_count="125">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>with_message_history.invoke(</span>
<span id="cb33-2"><a href="#cb33-2"></a>    <span class="co"># 수학 관련 질문 "코사인의 의미는 무엇인가요?"를 입력으로 전달합니다.</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"What does cosine mean?"</span>},</span>
<span id="cb33-4"><a href="#cb33-4"></a>    <span class="co"># 설정 옵션으로 세션 ID를 "redis123" 로 지정합니다.</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"redis123"</span>}},</span>
<span id="cb33-6"><a href="#cb33-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>AIMessage(content='It is a trigonometric function that gives the ratio of the adjacent side to the hypotenuse in a right triangle.', response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 47, 'total_tokens': 72}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_b28b39ffa8', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<p>동일한 <code>session_id</code>를 사용하여 두 번째 호출을 수행합니다. 이번에는 이전의 답변을 한글로 답변해 달라는 요청을 해보겠습니다.</p>
<div id="068ab370" class="cell" data-execution_count="126">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a>with_message_history.invoke(</span>
<span id="cb35-2"><a href="#cb35-2"></a>    <span class="co"># 이전 답변에 대한 한글 번역을 요청합니다.</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"이전의 답변을 한글로 번역해 주세요."</span>},</span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="co"># 설정 값으로 세션 ID를 "foobar"로 지정합니다.</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"redis123"</span>}},</span>
<span id="cb35-6"><a href="#cb35-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>AIMessage(content='인접변을 빗변으로 나눈 비율을 나타내는 삼각함수입니다.', response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 98, 'total_tokens': 132}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_b28b39ffa8', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<p>이번에는 다른 <code>session_id</code>를 사용하여 질문을 하겠습니다.</p>
<div id="14c277bf" class="cell" data-execution_count="127">
<details class="code-fold">
<summary>코드</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a>with_message_history.invoke(</span>
<span id="cb37-2"><a href="#cb37-2"></a>    <span class="co"># 이전 답변에 대한 한글 번역을 요청합니다.</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>    {<span class="st">"ability"</span>: <span class="st">"math"</span>, <span class="st">"input"</span>: <span class="st">"이전의 답변을 한글로 번역해 주세요."</span>},</span>
<span id="cb37-4"><a href="#cb37-4"></a>    <span class="co"># 설정 값으로 세션 ID를 "redis456"로 지정합니다.</span></span>
<span id="cb37-5"><a href="#cb37-5"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"session_id"</span>: <span class="st">"redis456"</span>}},</span>
<span id="cb37-6"><a href="#cb37-6"></a>)</span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>AIMessage(content='수학에 능숙한 어시스턴트입니다.', response_metadata={'token_usage': {'completion_tokens': 19, 'prompt_tokens': 60, 'total_tokens': 79}, 'model_name': 'gpt-3.5-turbo', 'system_fingerprint': 'fp_3bc1b5746c', 'finish_reason': 'stop', 'logprobs': None})</code></pre>
</div>
</div>
<p>마지막 답변은 이전 대화기록이 없으므로, 제대로 된 답변을 받을 수 없습니다.</p>


</section>
</section>

</main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

// tweak headings in pymd
document.querySelectorAll(".pymd span.co").forEach(el => {
   if (!el.innerText.startsWith("#|")) {
      el.style.fontWeight = 1000;
   }
});

</script>
<!-- Begin Mailchimp Signup Form -->
<div id="mc_embed_signup" style="padding-bottom: 1em; max-width: 400px;" class="ms-auto me-auto">
  <p style="font-weight: 600; margin-bottom: 0;">Subscribe</p>
  <span style="font-size: 0.9em;">Enjoy this blog? Get notified of new posts by email:</span>
<form action="https://quarto.us14.list-manage.com/subscribe/post?u=c79fb56a311ae347fbe916740&amp;id=ec05dfca03" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
    <div id="mc_embed_signup_scroll">
	
        <div class="input-group mt-1 mb-2">
        <input type="email" class="form-control" placeholder="Email Address" aria-label="Email Address" name="EMAIL" style="font-size: 0.8em; padding: .2em;">
        </div>              

	<div id="mce-responses" class="clear foot">
		<div class="response" id="mce-error-response" style="display:none"></div>
		<div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_c79fb56a311ae347fbe916740_ec05dfca03" tabindex="-1" value=""></div>
        <div class="optionalParent">
            <div class="clear foot" style="display: flex; align-items: center; justify-content: center;">
              
              
                <input type="submit" value="Subscribe" name="subscribe" style="min-width: 150px; font-size: 0.8em;" id="mc-embedded-subscribe" class="button btn btn-light btn-sm ms-auto me-auto">
            </div>
        </div>
    </div>
</form>
</div>

<!--End mc_embed_signup-->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "복사완료!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "복사완료!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("kk3225\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="kmink3225/blog" data-repo-id="R_kgDOLCZyDg" data-category="Blog" data-category-id="" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Kwangmin Kim</p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../../../about.html">
<p>About</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kmink3225/blog">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>