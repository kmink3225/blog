<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.543">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Kwangmin Kim - 인공신경망과 역전파</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../.././images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Kwangmin Kim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../docs/blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../about.html"> 
<span class="menu-text">Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kmink3225"> <i class="bi bi-github" role="img" aria-label="Github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/kwangmin-kim-a5241b200/"> <i class="bi bi-linkedin" role="img" aria-label="Linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#인공신경망과-역전파" id="toc-인공신경망과-역전파" class="nav-link active" data-scroll-target="#인공신경망과-역전파">인공신경망과 역전파</a>
  <ul class="collapse">
  <li><a href="#보조함수-정의" id="toc-보조함수-정의" class="nav-link" data-scroll-target="#보조함수-정의">보조함수 정의</a></li>
  <li><a href="#데이터-로딩" id="toc-데이터-로딩" class="nav-link" data-scroll-target="#데이터-로딩">데이터 로딩</a>
  <ul class="collapse">
  <li><a href="#결정-경계와-타겟이-표시된-데이터" id="toc-결정-경계와-타겟이-표시된-데이터" class="nav-link" data-scroll-target="#결정-경계와-타겟이-표시된-데이터">결정 경계와 타겟이 표시된 데이터</a></li>
  </ul></li>
  <li><a href="#x-5y---15-0-로-분류" id="toc-x-5y---15-0-로-분류" class="nav-link" data-scroll-target="#x-5y---15-0-로-분류">$3x + 5y - 15 = 0 $ 로 분류</a></li>
  <li><a href="#x---3y-18-0-로-분류" id="toc-x---3y-18-0-로-분류" class="nav-link" data-scroll-target="#x---3y-18-0-로-분류">$ -6x - 3y + 18 = 0 $로 분류</a></li>
  <li><a href="#위-두-경우를-합성하여-분류하는-경우" id="toc-위-두-경우를-합성하여-분류하는-경우" class="nav-link" data-scroll-target="#위-두-경우를-합성하여-분류하는-경우">위 두 경우를 합성하여 분류하는 경우</a></li>
  <li><a href="#차원-표현" id="toc-차원-표현" class="nav-link" data-scroll-target="#차원-표현">3차원 표현</a></li>
  <li><a href="#network-함수" id="toc-network-함수" class="nav-link" data-scroll-target="#network-함수">network 함수</a>
  <ul class="collapse">
  <li><a href="#network-함수-검증" id="toc-network-함수-검증" class="nav-link" data-scroll-target="#network-함수-검증">network 함수 검증</a></li>
  </ul></li>
  <li><a href="#목적함수-정의와-최적화" id="toc-목적함수-정의와-최적화" class="nav-link" data-scroll-target="#목적함수-정의와-최적화">목적함수 정의와 최적화</a></li>
  <li><a href="#학습-scipy-사용" id="toc-학습-scipy-사용" class="nav-link" data-scroll-target="#학습-scipy-사용">학습: scipy 사용</a>
  <ul class="collapse">
  <li><a href="#학습된-네트워크로-분류" id="toc-학습된-네트워크로-분류" class="nav-link" data-scroll-target="#학습된-네트워크로-분류">학습된 네트워크로 분류</a></li>
  </ul></li>
  <li><a href="#학습-직접-수치미분해서" id="toc-학습-직접-수치미분해서" class="nav-link" data-scroll-target="#학습-직접-수치미분해서">학습: 직접 수치미분해서</a>
  <ul class="collapse">
  <li><a href="#scipy.optimize.fmin_cg" id="toc-scipy.optimize.fmin_cg" class="nav-link" data-scroll-target="#scipy.optimize.fmin_cg">scipy.optimize.fmin_cg</a></li>
  </ul></li>
  <li><a href="#신경망-미분하기-데이터-하나에-대해서" id="toc-신경망-미분하기-데이터-하나에-대해서" class="nav-link" data-scroll-target="#신경망-미분하기-데이터-하나에-대해서">신경망 미분하기 (데이터 하나에 대해서)</a>
  <ul class="collapse">
  <li><a href="#순전파-함수넘파이" id="toc-순전파-함수넘파이" class="nav-link" data-scroll-target="#순전파-함수넘파이">순전파 함수(넘파이)</a></li>
  <li><a href="#순전파-함수파이토치" id="toc-순전파-함수파이토치" class="nav-link" data-scroll-target="#순전파-함수파이토치">순전파 함수(파이토치)</a></li>
  <li><a href="#넘파이-어레이와-텐서-프린트-보조함수" id="toc-넘파이-어레이와-텐서-프린트-보조함수" class="nav-link" data-scroll-target="#넘파이-어레이와-텐서-프린트-보조함수">넘파이 어레이와 텐서 프린트 보조함수</a></li>
  <li><a href="#가중치-무작위-초기화" id="toc-가중치-무작위-초기화" class="nav-link" data-scroll-target="#가중치-무작위-초기화">가중치 무작위 초기화</a></li>
  <li><a href="#초기-상태에서-목적함숫값" id="toc-초기-상태에서-목적함숫값" class="nav-link" data-scroll-target="#초기-상태에서-목적함숫값">초기 상태에서 목적함숫값</a></li>
  <li><a href="#데이터-하나로-순전파-시키기" id="toc-데이터-하나로-순전파-시키기" class="nav-link" data-scroll-target="#데이터-하나로-순전파-시키기">데이터 하나로 순전파 시키기</a></li>
  <li><a href="#단계별-계산" id="toc-단계별-계산" class="nav-link" data-scroll-target="#단계별-계산">단계별 계산</a></li>
  <li><a href="#fracpartial-cpartial-mathbfa2-11" id="toc-fracpartial-cpartial-mathbfa2-11" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfa2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(2)}}\)</span>: (1,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfz2-11" id="toc-fracpartial-cpartial-mathbfz2-11" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfz2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(2)}}\)</span>: (1,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfb2-11" id="toc-fracpartial-cpartial-mathbfb2-11" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfb2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(2)}}\)</span>: (1,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfh2-11" id="toc-fracpartial-cpartial-mathbfh2-11" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfh2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{h}^{(2)}}\)</span>: (1,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfw2-12" id="toc-fracpartial-cpartial-mathbfw2-12" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfw2-12"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(2)}}\)</span>: (1,2)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfa1-21" id="toc-fracpartial-cpartial-mathbfa1-21" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfa1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(1)}}\)</span>: (2,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfz1-21" id="toc-fracpartial-cpartial-mathbfz1-21" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfz1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(1)}}\)</span>: (2,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfb1-21" id="toc-fracpartial-cpartial-mathbfb1-21" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfb1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(1)}}\)</span>: (2,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfh1-21" id="toc-fracpartial-cpartial-mathbfh1-21" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfh1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{h}^{(1)}}\)</span>: (2,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfw1-22" id="toc-fracpartial-cpartial-mathbfw1-22" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfw1-22"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(1)}}\)</span>: (2,2)</a></li>
  <li><a href="#텐서-평활화" id="toc-텐서-평활화" class="nav-link" data-scroll-target="#텐서-평활화">텐서 평활화</a></li>
  </ul></li>
  <li><a href="#데이터가-여러개인-경우" id="toc-데이터가-여러개인-경우" class="nav-link" data-scroll-target="#데이터가-여러개인-경우">데이터가 여러개인 경우</a>
  <ul class="collapse">
  <li><a href="#순전파와-역전파를-동시에-하는-함수" id="toc-순전파와-역전파를-동시에-하는-함수" class="nav-link" data-scroll-target="#순전파와-역전파를-동시에-하는-함수">순전파와 역전파를 동시에 하는 함수</a></li>
  <li><a href="#모든-데이터에-대해-각각-역전파한-미분계수를-평균하기" id="toc-모든-데이터에-대해-각각-역전파한-미분계수를-평균하기" class="nav-link" data-scroll-target="#모든-데이터에-대해-각각-역전파한-미분계수를-평균하기">모든 데이터에 대해 각각 역전파한 미분계수를 평균하기</a></li>
  <li><a href="#역전파-한번으로-미분계수-구하기" id="toc-역전파-한번으로-미분계수-구하기" class="nav-link" data-scroll-target="#역전파-한번으로-미분계수-구하기">역전파 한번으로 미분계수 구하기</a></li>
  <li><a href="#순전파" id="toc-순전파" class="nav-link" data-scroll-target="#순전파">순전파</a></li>
  <li><a href="#단계별-역전파" id="toc-단계별-역전파" class="nav-link" data-scroll-target="#단계별-역전파">단계별 역전파</a></li>
  <li><a href="#fracpartial-cpartial-mathbfa2-1n" id="toc-fracpartial-cpartial-mathbfa2-1n" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfa2-1n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(2)}}\)</span>: (1,N)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfz2-1n" id="toc-fracpartial-cpartial-mathbfz2-1n" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfz2-1n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(2)}}\)</span>: (1,N)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfb2-11-1" id="toc-fracpartial-cpartial-mathbfb2-11-1" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfb2-11-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(2)}}\)</span>: (1,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfw2-12-1" id="toc-fracpartial-cpartial-mathbfw2-12-1" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfw2-12-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(2)}}\)</span>: (1,2)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfa1-2n" id="toc-fracpartial-cpartial-mathbfa1-2n" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfa1-2n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(1)}}\)</span>: (2,N)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfz1-2n" id="toc-fracpartial-cpartial-mathbfz1-2n" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfz1-2n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(1)}}\)</span>: (2,N)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfb1-21-1" id="toc-fracpartial-cpartial-mathbfb1-21-1" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfb1-21-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(1)}}\)</span>: (2,1)</a></li>
  <li><a href="#fracpartial-cpartial-mathbfw1-22-1" id="toc-fracpartial-cpartial-mathbfw1-22-1" class="nav-link" data-scroll-target="#fracpartial-cpartial-mathbfw1-22-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(1)}}\)</span>: (2,2)</a></li>
  <li><a href="#파이토치로-미분하기" id="toc-파이토치로-미분하기" class="nav-link" data-scroll-target="#파이토치로-미분하기">파이토치로 미분하기</a></li>
  </ul></li>
  <li><a href="#자동미분으로-신경망-학습하기" id="toc-자동미분으로-신경망-학습하기" class="nav-link" data-scroll-target="#자동미분으로-신경망-학습하기">자동미분으로 신경망 학습하기</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">인공신경망과 역전파</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="인공신경망과-역전파" class="level1">
<h1>인공신경망과 역전파</h1>
<ul>
<li>마지막 과정으로 가장 간단한 인공신경망을 설계하고 이를 역전파 알고리즘을 통해 학습시키는 코드를 작성</li>
</ul>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits <span class="im">import</span> mplot3d</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>cm2 <span class="op">=</span> ListedColormap([<span class="st">'C6'</span>, <span class="st">'C1'</span>])</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>cm2inv <span class="op">=</span> ListedColormap([<span class="st">'C1'</span>, <span class="st">'C6'</span>])</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 전역으로 지정한 numpy 출력 형식</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(precision<span class="op">=</span><span class="dv">4</span>, linewidth<span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># matplotlib 스타일 지정</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>mpl.style.use(<span class="st">'bmh'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>mpl.style.use(<span class="st">'seaborn-whitegrid'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="보조함수-정의" class="level2">
<h2 class="anchored" data-anchor-id="보조함수-정의">보조함수 정의</h2>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logistic(x):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    logistic sigmoid function</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span><span class="op">+</span>np.exp(<span class="op">-</span>x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="데이터-로딩" class="level2">
<h2 class="anchored" data-anchor-id="데이터-로딩">데이터 로딩</h2>
<ul>
<li>neuralnet_make_samples.ipynb 파일에서 만든 데이터를 로딩</li>
</ul>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> np.load(<span class="st">'C:/Users/kmkim/Desktop/projects/blog/docs/data/08-nndata.npz'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> D[<span class="st">'samples'</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> D[<span class="st">'target'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell" data-executioninfo="{&quot;elapsed&quot;:14,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537408368,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="26a1720f-5f6e-45d3-ffe1-c4e78024072e" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>samples.shape, target.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>((500, 2), (500,))</code></pre>
</div>
</div>
<ul>
<li>데이터는 500개 2차원 점으로 구성되어 있고 각 점 마다 0, 1이 기록된 타겟이 함께 있음</li>
</ul>
<section id="결정-경계와-타겟이-표시된-데이터" class="level3">
<h3 class="anchored" data-anchor-id="결정-경계와-타겟이-표시된-데이터">결정 경계와 타겟이 표시된 데이터</h3>
<div id="cell-11" class="cell" data-executioninfo="{&quot;elapsed&quot;:1105,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537409461,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="435c5998-c223-479b-acf5-16375a4e8072" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[target<span class="op">==</span><span class="dv">1</span>,<span class="dv">0</span>], samples[target<span class="op">==</span><span class="dv">1</span>,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>       markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[target<span class="op">==</span><span class="dv">0</span>,<span class="dv">0</span>], samples[target<span class="op">==</span><span class="dv">0</span>,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>       markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">15</span><span class="op">/</span><span class="dv">7</span>, <span class="dv">50</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.linspace(<span class="dv">15</span><span class="op">/</span><span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">50</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 미리 정의된 pos, neg area</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>pos_area <span class="op">=</span> np.array([<span class="dv">0</span>,<span class="dv">3</span>, <span class="dv">0</span>,<span class="dv">5</span>, <span class="dv">5</span>,<span class="dv">5</span>, <span class="dv">5</span>,<span class="dv">0</span>, <span class="dv">3</span>,<span class="dv">0</span>, <span class="dv">15</span><span class="op">/</span><span class="dv">7</span>,<span class="dv">12</span><span class="op">/</span><span class="dv">7</span>]).reshape(<span class="dv">6</span>,<span class="dv">2</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>pos_polygon <span class="op">=</span> mpl.patches.Polygon(pos_area, color<span class="op">=</span><span class="st">'C1'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>ax.add_patch(pos_polygon)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>neg_area <span class="op">=</span> np.array([<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">3</span>, <span class="dv">15</span><span class="op">/</span><span class="dv">7</span>,<span class="dv">12</span><span class="op">/</span><span class="dv">7</span>, <span class="dv">3</span>,<span class="dv">0</span>]).reshape(<span class="dv">4</span>,<span class="dv">2</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>neg_polygon <span class="op">=</span> mpl.patches.Polygon(neg_area, color<span class="op">=</span><span class="st">'C6'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>ax.add_patch(neg_polygon)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="x-5y---15-0-로-분류" class="level2">
<h2 class="anchored" data-anchor-id="x-5y---15-0-로-분류">$3x + 5y - 15 = 0 $ 로 분류</h2>
<ul>
<li>로지스틱 회귀에서 배운 선형 분류기 다른게 말하면 퍼셉트론으로 주언 데이터를 분류 하기 위해 매개변수 값을 3, 5, -15 로 설정</li>
</ul>
<div id="cell-13" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">50</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>dcs_bnd_1 <span class="op">=</span> <span class="kw">lambda</span> x: <span class="op">-</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">5</span>)<span class="op">*</span>x <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dcs_bnd_1_imp <span class="op">=</span> <span class="kw">lambda</span> x, y: (<span class="dv">3</span>)<span class="op">*</span>x <span class="op">+</span> (<span class="dv">5</span>)<span class="op">*</span>y <span class="op">+</span> (<span class="op">-</span><span class="dv">15</span>) <span class="co">#implicity 음항수 형태</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-executioninfo="{&quot;elapsed&quot;:32,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537409465,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="8de4f576-ba31-4be2-a36b-21a0636134bd" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.axes()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> dcs_bnd_1_imp(X1.ravel(), X2.ravel()).reshape(X1.shape)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>ax.contourf(X1, X2, Y, [<span class="op">-</span><span class="dv">100</span>, <span class="dv">0</span>, <span class="dv">100</span>], cmap<span class="op">=</span>cm2, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>ax.plot(x, dcs_bnd_1(x), color<span class="op">=</span><span class="st">'k'</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>y1_bin <span class="op">=</span> dcs_bnd_1_imp(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>]) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[y1_bin, <span class="dv">0</span>], </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        samples[y1_bin,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>not_y1_bin <span class="op">=</span> np.invert(y1_bin)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>not_y1_and_target <span class="op">=</span> np.logical_and(not_y1_bin,target)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[not_y1_and_target, <span class="dv">0</span>], samples[not_y1_and_target, <span class="dv">1</span>], <span class="st">'o'</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>, zorder<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[np.where(target<span class="op">==</span><span class="dv">0</span>)[<span class="dv">0</span>], <span class="dv">0</span>], samples[np.where(target<span class="op">==</span><span class="dv">0</span>)[<span class="dv">0</span>], <span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>, zorder<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>분류 결과를 보면 결정 경계 아래쪽에 있는 흰색 동그라미는 세모로 잘못 분류</li>
</ul>
</section>
<section id="x---3y-18-0-로-분류" class="level2">
<h2 class="anchored" data-anchor-id="x---3y-18-0-로-분류">$ -6x - 3y + 18 = 0 $로 분류</h2>
<ul>
<li>가중치 값을 바꿔서 다른 선형 분류기로 분류</li>
</ul>
<div id="cell-17" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dcs_bnd_2 <span class="op">=</span> <span class="kw">lambda</span> x: <span class="op">-</span><span class="dv">2</span><span class="op">*</span>x <span class="op">+</span> <span class="dv">6</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dcs_bnd_2_imp <span class="op">=</span> <span class="kw">lambda</span> x, y: (<span class="op">-</span><span class="dv">6</span>)<span class="op">*</span>x <span class="op">+</span> (<span class="op">-</span><span class="dv">3</span>)<span class="op">*</span>y <span class="op">+</span> (<span class="dv">18</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-executioninfo="{&quot;elapsed&quot;:31,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537409469,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="e1f4f160-a557-43c3-bb7b-2b03a90b719e" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> dcs_bnd_2_imp(X1.ravel(), X2.ravel()).reshape(X1.shape)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>ax.contourf(X1, X2, Y, [<span class="op">-</span><span class="dv">100</span>, <span class="dv">0</span>, <span class="dv">100</span>], cmap<span class="op">=</span>cm2, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>ax.plot(x, dcs_bnd_2(x), color<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>y2_bin <span class="op">=</span> dcs_bnd_2_imp(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>]) <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[y2_bin, <span class="dv">0</span>], samples[y2_bin, <span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>not_y2_bin <span class="op">=</span> np.invert(y2_bin)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>not_y2_and_target <span class="op">=</span> np.logical_and(not_y2_bin,target)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[not_y2_and_target, <span class="dv">0</span>], samples[not_y2_and_target, <span class="dv">1</span>], <span class="st">'o'</span>,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'gray'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[np.where(target<span class="op">==</span><span class="dv">0</span>)[<span class="dv">0</span>], <span class="dv">0</span>], samples[np.where(target<span class="op">==</span><span class="dv">0</span>)[<span class="dv">0</span>], <span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>이번에도 두 샘플을 정확하게 분류할 수 없음</p></li>
<li><p>결정경계 왼쪽 동그라미를 세모로 잘못 분류 하고 있음</p></li>
</ul>
</section>
<section id="위-두-경우를-합성하여-분류하는-경우" class="level2">
<h2 class="anchored" data-anchor-id="위-두-경우를-합성하여-분류하는-경우">위 두 경우를 합성하여 분류하는 경우</h2>
<ul>
<li>앞서 만든 두 선형 분류기를 함께 혼합하여 또 다른 선형 분류기의 입력으로 사용</li>
</ul>
<div id="cell-21" class="cell" data-executioninfo="{&quot;elapsed&quot;:820,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410261,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="36e4fd3d-6a1b-400c-d630-30228831dcdf" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 두 선형 분류기 합치기[+]</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>w1, w2, bias <span class="op">=</span> <span class="dv">10</span>, <span class="op">-</span><span class="dv">9</span>, <span class="dv">4</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="kw">lambda</span> x, y: logistic( </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>               w1<span class="op">*</span>logistic(dcs_bnd_1_imp(x, y)) </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>               <span class="op">+</span> w2<span class="op">*</span>logistic(dcs_bnd_2_imp(x, y)) </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>               <span class="op">+</span> bias</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot()</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> a(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>])</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>pred_pos <span class="op">=</span> pred <span class="op">&gt;=</span> <span class="fl">0.5</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>pred_neg <span class="op">=</span> pred <span class="op">&lt;</span> <span class="fl">0.5</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>ax.contour(X1, X2, a(X1,X2), cmap<span class="op">=</span><span class="st">'gray'</span>, levels<span class="op">=</span>[<span class="fl">0.5</span>])</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>ax.contourf(X1, X2, a(X1,X2), cmap<span class="op">=</span>cm2, levels<span class="op">=</span>[<span class="op">-</span><span class="dv">10</span>, <span class="fl">0.5</span>, <span class="dv">10</span>], alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># for positive samples</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_pos)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_neg)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co"># for negative samples</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_neg)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_pos)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TP,<span class="dv">0</span>], samples[TP,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TN,<span class="dv">0</span>], samples[TN,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FN,<span class="dv">0</span>], samples[FN,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FP,<span class="dv">0</span>], samples[FP,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>         markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>샘플 두 개만 틀리고 모두 바르게 분류</p></li>
<li><p>결정경계는 비선형으로 곡선형태를 띄고 있음</p></li>
<li><p>함수의 합성과정에서 비선형 함수인 로지스틱 시그모이드 함수가 끼어있어 전체 함수가 비선형성을 띄게됨</p></li>
</ul>
</section>
<section id="차원-표현" class="level2">
<h2 class="anchored" data-anchor-id="차원-표현">3차원 표현</h2>
<div id="cell-24" class="cell" data-executioninfo="{&quot;elapsed&quot;:110,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410269,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="a598ff3f-5bc6-441d-dfd3-a56bd6ac0356" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(projection<span class="op">=</span><span class="st">'3d'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'xtick'</span>,labelsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'ytick'</span>,labelsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">101</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">101</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x1, x2)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>ax.contour(X1, X2, a(X1, X2), linewidths<span class="op">=</span><span class="dv">5</span>, cmap<span class="op">=</span><span class="st">'gray'</span>, levels<span class="op">=</span>[<span class="fl">0.5</span>])</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>ax.plot_surface(X1, X2, a(X1, X2), color<span class="op">=</span><span class="st">'w'</span>, edgecolor<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>ax.plot3D(samples[TP,<span class="dv">0</span>], samples[TP,<span class="dv">1</span>], <span class="fl">1.0</span>, <span class="st">'o'</span>, </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>ax.plot3D(samples[TN,<span class="dv">0</span>], samples[TN,<span class="dv">1</span>], <span class="fl">0.0</span>, <span class="st">'^'</span>, </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>ax.plot3D(samples[FN,<span class="dv">0</span>], samples[FN,<span class="dv">1</span>], <span class="fl">0.0</span>, <span class="st">'o'</span>, </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>ax.plot3D(samples[FP,<span class="dv">0</span>], samples[FP,<span class="dv">1</span>], <span class="fl">1.0</span>, <span class="st">'^'</span>, </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">15</span>) </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>ax.zaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r'$x$'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r'$y$'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>ax.set_zlabel(<span class="vs">r'$a$'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>ax.view_init(<span class="dv">30</span>, <span class="op">-</span><span class="dv">80</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>이렇게 다층퍼셉트론(다른 말로 인공신경망)은 선형 분류기인 로지스틱 회귀를 여러개 겹쳐 사용한것 임을 확인</p></li>
<li><p>이제 이렇게 만들어진 인공신경망을 계산하는 함수를 만들어 전체를 네트워크 하나로 처리</p></li>
</ul>
</section>
<section id="network-함수" class="level2">
<h2 class="anchored" data-anchor-id="network-함수">network 함수</h2>
<ul>
<li><p>아래 함수는 샘플 점 <code>X</code>아 로지스틱 회귀 모델 세개에 해당하는 매개변수 아홉 개를 입력으로 받아 이 네트워크의 출력을 계산하는 함수</p></li>
<li><p>이하 매개변수는 가중치 또는 가중치와 바이어스라는 용어를 혼용</p></li>
</ul>
<div id="cell-27" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> network(X, W):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    X : (N, D)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    W : (3, 3)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">        [b^(1)_1, w^(1)_11, w^(1)_12]</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">        [b^(1)_2, w^(1)_21, w^(1)_22]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">        [b^(2)_1, w^(2)_11, w^(2)_12]</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ret : (N,)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    D, H, A = 2, 2, 1</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">######################################</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># WRITE YOUR CODE HERE</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1st layer</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> np.dot(W[:<span class="dv">2</span>,<span class="dv">1</span>:], X.T)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> Z1 <span class="op">+</span> W[:<span class="dv">2</span>,<span class="dv">0</span>].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    A1 <span class="op">=</span> logistic(Z1)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2nd layer</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> np.dot(W[<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>:], A1)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> Z <span class="op">+</span> W[<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> logistic(Z)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">######################################</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> A</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="network-함수-검증" class="level3">
<h3 class="anchored" data-anchor-id="network-함수-검증">network 함수 검증</h3>
<ul>
<li>위 작성한 함수가 제대로 함숫값을 계산한다면 아래 셀 실행 결과는 2가 되어야 함</li>
</ul>
<div id="cell-29" class="cell" data-executioninfo="{&quot;elapsed&quot;:88,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410277,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="3c92bdc9-a679-463d-e503-800660486f8b" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">############################################################</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 이 테스트 코드의 결과는 2가 나와야 함</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> np.array([ [<span class="op">-</span><span class="dv">15</span>, <span class="dv">3</span>, <span class="dv">5</span>], [<span class="dv">18</span>, <span class="op">-</span><span class="dv">6</span>, <span class="op">-</span><span class="dv">3</span>], [<span class="dv">4</span>, <span class="dv">10</span>, <span class="op">-</span><span class="dv">9</span>] ])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> network(samples, W)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>pred.shape</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>pred[pred<span class="op">&gt;=</span><span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>pred[pred<span class="op">&lt;</span><span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pred <span class="op">!=</span> target</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"오분류 데이터 개수: </span><span class="sc">{</span>result<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>오분류 데이터 개수: 2</code></pre>
</div>
</div>
<ul>
<li>네트워크를 함수로 작동하게 만들었으므로 최적화 과정을 적용해서 이 함수를 학습시킬 수 있음</li>
</ul>
</section>
</section>
<section id="목적함수-정의와-최적화" class="level2">
<h2 class="anchored" data-anchor-id="목적함수-정의와-최적화">목적함수 정의와 최적화</h2>
<section id="변수-초기화" class="level4">
<h4 class="anchored" data-anchor-id="변수-초기화">변수 초기화</h4>
<div id="cell-33" class="cell" data-executioninfo="{&quot;elapsed&quot;:73,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410283,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="13e5d338-2139-4726-f7b6-d3a7808341f8" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>array([[-15,   3,   5],
       [ 18,  -6,  -3],
       [  4,  10,  -9]])</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-executioninfo="{&quot;elapsed&quot;:65,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410286,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="9749acb5-8093-4b30-ba80-fa9edebf9ba9" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 가중치를 무작위로 초기화</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">17</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> np.random.randn(<span class="dv">9</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># W.reshape(3,3)</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>array([ 0.2763, -1.8546,  0.6239,  1.1453,  1.0372,  1.8866, -0.1117, -0.3621,  0.1487])</code></pre>
</div>
</div>
<ul>
<li>가중치가 임의로 초기화 되었으므로 오분류 개수는 2보다 커져야 함</li>
</ul>
<div id="cell-36" class="cell" data-executioninfo="{&quot;elapsed&quot;:459,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410691,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="3580b850-ac47-4dee-ab38-c80c751b4239" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> network(samples, W.reshape(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>pred[pred<span class="op">&gt;=</span><span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>pred[pred<span class="op">&lt;</span><span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pred <span class="op">!=</span> target</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"오분류 데이터 개수: </span><span class="sc">{</span>result<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>오분류 데이터 개수: 163</code></pre>
</div>
</div>
</section>
<section id="목적함수-정의" class="level4">
<h4 class="anchored" data-anchor-id="목적함수-정의">목적함수 정의</h4>
<ul>
<li>분류 문제는 크로스엔트로피 목적함수를 자주 사용하지만 여기서는 역전파 과정을 간략하게 설명하기 위해 간단한 오차 제곱합 함수를 목적함수로 사용</li>
</ul>
<div id="cell-38" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> J(W, X, T):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    W: 함숫값을 결정하는 변수, 가중치 (9,)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    X: 주어진 점 데이터 X, X: (N,D)</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    T: 데이터에 대한 클래스 T, 0 또는 1, T: (N,)</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X.shape[<span class="dv">0</span>]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> W.reshape(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 네트워크를 포워드 시키고 적당한 로스 함수를 계산하여 되돌림</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> network(X, W)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N)) <span class="op">*</span> ((T<span class="op">-</span>Y)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-39" class="cell" data-executioninfo="{&quot;elapsed&quot;:34,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537410694,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="13acd463-0308-44ff-ff08-ff6ba2f80237" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 초기 상태에서 목적함숫값</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.1263148192185165</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>J(W, samples, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>0.1263148192185165</code></pre>
</div>
</div>
</section>
</section>
<section id="학습-scipy-사용" class="level2">
<h2 class="anchored" data-anchor-id="학습-scipy-사용">학습: scipy 사용</h2>
<ul>
<li><p>네트워크를 학습시키는 과정은 함수를 최적화하는 과정과 다르지 않음</p></li>
<li><p>그렇기 때문에 기존 라이브러리에서 제공하는 최적화 모듈을 사용해도 충분히 학습이 가능</p></li>
<li><p>여기서는 사이파이에서 제공하는 켤레기울기법을 사용</p></li>
</ul>
<div id="cell-41" class="cell" data-executioninfo="{&quot;elapsed&quot;:1683,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537412358,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="68899288-7abe-4cb3-9a98-4ad5c30b7fc9" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> optimize</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.fmin_cg.html</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>W_star <span class="op">=</span> optimize.fmin_cg(J, W, args<span class="op">=</span>(samples, target),  gtol<span class="op">=</span><span class="fl">1e-06</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully.
         Current function value: 0.000000
         Iterations: 534
         Function evaluations: 19760
         Gradient evaluations: 1976</code></pre>
</div>
</div>
<div id="cell-42" class="cell" data-executioninfo="{&quot;elapsed&quot;:21,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537412360,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="7d730d7a-0ea1-4078-afb9-dbd0d7f007fa" data-execution_count="22">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>W_star <span class="op">=</span> W_star.reshape(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>W_star</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array([[ 48.0777, -10.5942, -15.3917],
       [-27.7851,   9.6463,   3.5314],
       [ 21.6201, -49.2293,  47.523 ]])</code></pre>
</div>
</div>
<section id="학습된-네트워크로-분류" class="level3">
<h3 class="anchored" data-anchor-id="학습된-네트워크로-분류">학습된 네트워크로 분류</h3>
<div id="cell-44" class="cell" data-executioninfo="{&quot;elapsed&quot;:711,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537413059,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="42d1001c-01b2-450f-8338-59134dbfef31" data-execution_count="23">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">200</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>dcs_bnd_1_imp_ <span class="op">=</span> <span class="kw">lambda</span> x, y: W_star[<span class="dv">0</span>, <span class="dv">1</span>]<span class="op">*</span>x <span class="op">+</span> W_star[<span class="dv">0</span>, <span class="dv">2</span>]<span class="op">*</span>y <span class="op">+</span> W_star[<span class="dv">0</span>, <span class="dv">0</span>] </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>dcs_bnd_2_imp_ <span class="op">=</span> <span class="kw">lambda</span> x, y: W_star[<span class="dv">1</span>, <span class="dv">1</span>]<span class="op">*</span>x <span class="op">+</span> W_star[<span class="dv">1</span>, <span class="dv">2</span>]<span class="op">*</span>y <span class="op">+</span> W_star[<span class="dv">1</span>, <span class="dv">0</span>] </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>a, b, c <span class="op">=</span> W_star[<span class="dv">2</span>, <span class="dv">1</span>], W_star[<span class="dv">2</span>, <span class="dv">2</span>], W_star[<span class="dv">2</span>, <span class="dv">0</span>] </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>o <span class="op">=</span> <span class="kw">lambda</span> x, y: logistic( a<span class="op">*</span>logistic(dcs_bnd_1_imp_(x, y)) </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                         <span class="op">+</span> b<span class="op">*</span>logistic(dcs_bnd_2_imp_(x, y)) </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                         <span class="op">+</span> c )</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.axes()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> o(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>])</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>pred_pos <span class="op">=</span> pred <span class="op">&gt;=</span> <span class="fl">0.5</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>pred_neg <span class="op">=</span> pred <span class="op">&lt;</span> <span class="fl">0.5</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>ax.contour(X1, X2, o(X1,X2), cmap<span class="op">=</span><span class="st">'gray'</span>, levels<span class="op">=</span>[<span class="fl">0.5</span>])</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>ax.contourf(X1, X2, o(X1,X2), cmap<span class="op">=</span>cm2, levels<span class="op">=</span>[<span class="op">-</span><span class="dv">10</span>, <span class="fl">0.5</span>, <span class="dv">10</span>], alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co"># for positive samples</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_pos)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_neg)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co"># for negative samples</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_neg)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_pos)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="co"># True Positive and True Negative</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TP,<span class="dv">0</span>], samples[TP,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TN,<span class="dv">0</span>], samples[TN,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="co"># False Positive and False Negative</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FN,<span class="dv">0</span>], samples[FN,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, </span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FP,<span class="dv">0</span>], samples[FP,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, </span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>학습이 잘되어 모든 데이터를 오류없이 잘 분류함을 확인할 수 있음</li>
</ul>
</section>
</section>
<section id="학습-직접-수치미분해서" class="level2">
<h2 class="anchored" data-anchor-id="학습-직접-수치미분해서">학습: 직접 수치미분해서</h2>
<ul>
<li><p>앞서 <code>fmin_cg</code>함수를 그냥 사용하기만 했는데 제대로 네트워크가 학습되는 것을 확인</p></li>
<li><p><code>fmin_cg</code>함수가 내부적으로 수치 미분을 수행하기 때문에 학습이 가능</p></li>
<li><p>다음 단계로 수치 미분도 직접 해서 최적화를 수행</p></li>
<li><p>수치 미분함수는 이전에 만들어 뒀던 함수를 그대로 재사용</p></li>
</ul>
<div id="cell-47" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 수치미분 함수</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> numer_deriv(x, fun, args<span class="op">=</span>(), h<span class="op">=</span><span class="va">None</span>, method<span class="op">=</span><span class="st">"central"</span>, dtype<span class="op">=</span><span class="st">'float32'</span>):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Find the first derivative of a function at a point x.</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">    x     : The point at which derivative is found.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">    fun   : Input function.</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">    args  : Tuple extra arguments passed to fun</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">    h     : step size</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">    method: 'central' or 'forward'</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">    dtype : Data type of gradient, must be set to 'longdouble' if numerically unstable </span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [1] 필요변수 초기화</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    scalar <span class="op">=</span> <span class="va">False</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [2] x가 스칼라인지 벡터인지 확인 스칼라면 무조건 벡터로 고치고 시작</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="bu">type</span>(x), <span class="st">'__iter__'</span>):</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> np.array([x])</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        scalar <span class="op">=</span> <span class="va">True</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [3] x 타입을 디폴트로 float32로 변경</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x.astype(dtype)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [4] 미분 계수 초기화</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> np.zeros(x.shape[<span class="dv">0</span>]).astype(dtype)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [5] 미분계수를 변수 개수만큼 루프를 돌면서 구하기</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(x.shape[<span class="dv">0</span>]) :</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [5-1]변경된 위치를 설정할 변수 두개를 준비</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># dx1[i], dx2[i]로 각 변수의 요소를 접근할 수 있음</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        dx1 <span class="op">=</span> x.copy()</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        dx2 <span class="op">=</span> x.copy()</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [5-2] h 결정 대충 변수의 1%정도</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># https://en.wikipedia.org/wiki/Numerical_differentiation</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> h <span class="op">==</span> <span class="va">None</span>:</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> np.sqrt(np.finfo(np.float32).eps) <span class="cf">if</span> x[i] <span class="op">==</span> <span class="fl">0.0</span> <span class="cf">else</span> np.sqrt(np.finfo(np.float32).eps) <span class="op">*</span> x[i]</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [5-3*] dx1[i] 변경</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>        dx1[i] <span class="op">+=</span> h</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [5-4*] central이면 dx[2]도 함께 변경</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> method <span class="op">==</span> <span class="st">"central"</span>:</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>            dx2[i] <span class="op">-=</span> h</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>            m <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [5-5*] 미분계수 계산</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>        g[i] <span class="op">=</span> ( fun(dx1, <span class="op">*</span>args) <span class="op">-</span> fun(dx2, <span class="op">*</span>args) ) <span class="op">/</span> (m<span class="op">*</span>h)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [6] 결과값 리턴</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> scalar:</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> g[<span class="dv">0</span>]    </span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> g</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="scipy.optimize.fmin_cg" class="level3">
<h3 class="anchored" data-anchor-id="scipy.optimize.fmin_cg">scipy.optimize.fmin_cg</h3>
<ul>
<li><code>scipy</code>에서 제공하는 켤레 경사법 함수의 매개변수를 살펴보면</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>scipy.optimize.fmin_cg(f, x0, fprime<span class="op">=</span><span class="va">None</span>, args<span class="op">=</span>(), </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                       gtol<span class="op">=</span><span class="fl">1e-05</span>, norm<span class="op">=</span>inf, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                       epsilon<span class="op">=</span><span class="fl">1.4901161193847656e-08</span>, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                       maxiter<span class="op">=</span><span class="va">None</span>, full_output<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                       disp<span class="op">=</span><span class="dv">1</span>, retall<span class="op">=</span><span class="dv">0</span>, callback<span class="op">=</span><span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>f: callable, f(x, *args)</p>
<ul>
<li>Objective function to be minimized. Here x must be a 1-D array of the variables that are to be changed in the search for a minimum, and args are the other (fixed) parameters of f.</li>
</ul></li>
<li><p>x0: ndarray</p>
<ul>
<li>A user-supplied initial estimate of xopt, the optimal value of x. It must be a 1-D array of values.</li>
</ul></li>
<li><p>fprime: callable, fprime(x, *args), optional</p>
<ul>
<li>A function that returns the gradient of f at x. Here x and args are as described above for f.&nbsp;The returned value must be a 1-D array. Defaults to None, in which case the gradient is approximated numerically (see epsilon, below).</li>
</ul></li>
<li><p>앞선 실험과 최대한 비슷한 최적화 결과를 만들기 위해 <code>fmin_cg</code>함수를 그대로 사용하되 수치미분 함수만 직접 만든 함수로 전달하는 방법을 사용</p></li>
<li><p>수치 미분함수를 직접 만들었으니 간단하게 경사하강법을 직접 구현해도 되지만 그렇게 할 경우 선탐색이나 강하 방향을 구하는 부분이 <code>fmin_cg</code>와 달라져서 앞선 실험과 동일한 결과를 얻기 힘들어 짐</p></li>
<li><p><code>fmin_cg</code>를 그대로 사용하기 위해 함수 도움말을 살펴보면 함숫값을 구하는 f와 미분계수를 구하는 fprime이 함수 헤더가 동일해야 함</p></li>
<li><p>지금 f에 해당하는 <code>J</code>의 해더는 다음과 같고</p>
<ul>
<li><code>def J(W, X, T):</code></li>
</ul></li>
<li><p>fprime 역할을 할 <code>numer_deriv</code>의 헤더는 다음과 같아서 일치하지 않음</p>
<ul>
<li><code>numer_deriv(x, fun, args=(), h=None, method='central', dtype='float32'):</code></li>
</ul></li>
<li><p>헤더가 다르므로 다음처럼 <code>fmin_cg</code>를 호출할 수 없고, 따라서 목적함수 <code>J</code>와 미분계수를 계산하는 <code>numer_deriv</code>의 헤더를 동일하게 해줄 방법이 필요</p>
<ul>
<li><code>fmin_cg(J, W, fprime=numer_deriv)</code></li>
</ul></li>
<li><p>함수를 리턴하는 클로져 사용하여 이 문제를 간단하게 해결</p></li>
</ul>
<div id="cell-49" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make_fprime함수는 내부적으로 함수를 하나 만들어 반환하는데</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 이 반환된 함수는 fprime(W, X, T)로 호출할 수 잇는 함수</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 반환된 함수 내부에서 numer_derive가 호출되어 함수 f에 대한</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 미분 계수를 구할 수 있음</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_fprime(f):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fprime(W, X, T, h<span class="op">=</span><span class="va">None</span>, method<span class="op">=</span><span class="st">'central'</span>, dtype<span class="op">=</span><span class="st">'float32'</span>):</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> numer_deriv(W, f, (X,T), h, method, dtype)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fprime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>클로저 문법을 사용하여 <code>J</code>를 수치미분하는 함수 <code>fprime</code>을 생성</li>
</ul>
<div id="cell-51" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fprime <span class="op">=</span> make_fprime(J)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>이제 <code>fprime</code>은 매개변수로 <code>W</code>, <code>X</code>, <code>T</code>를 받는 함수이므로 목적함수 <code>J</code>와 똑같은 호출 방식으로 미분 계수를 구할 수 있게 됨</li>
</ul>
<div id="cell-53" class="cell" data-executioninfo="{&quot;elapsed&quot;:113,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537413069,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="797fe70a-7b06-4790-c877-9f05c1dce58b" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fprime(W, samples, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>array([ 1.2754e-03,  2.9345e-03,  7.6448e-03,  7.3761e-05,  4.8319e-05,  3.5792e-05, -7.4173e-02, -1.2350e-02, -7.4711e-02], dtype=float32)</code></pre>
</div>
</div>
<ul>
<li>모든 부품이 완성되었으므로 최적화 수행</li>
</ul>
<div id="cell-55" class="cell" data-executioninfo="{&quot;elapsed&quot;:3331,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537416305,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="0e1133ce-7233-4243-cfbf-bc4e867f0fab" data-execution_count="28">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># X = samples.copy()</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># y = target.copy()</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># W_scratch = W.copy()</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>W_scratch <span class="op">=</span> optimize.fmin_cg(J, W, fprime<span class="op">=</span>fprime, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                             args<span class="op">=</span>(samples, target), gtol<span class="op">=</span><span class="fl">1e-06</span>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: Desired error not necessarily achieved due to precision loss.
         Current function value: 0.000022
         Iterations: 477
         Function evaluations: 1893
         Gradient evaluations: 1882</code></pre>
</div>
</div>
<ul>
<li>최적회 결과를 사용하여 결과를 확인하면 잘 분류하는 것을 확인할 수 있음</li>
</ul>
<div id="cell-57" class="cell" data-executioninfo="{&quot;elapsed&quot;:87,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537416310,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="dd895e8d-af16-400d-e644-8d6578c728a9" data-execution_count="29">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>W_scratch <span class="op">=</span> W_scratch.reshape(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>W_scratch</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># array([[ 40.6953,  -8.9941, -13.0385],</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#        [-24.8027,   8.6743,   2.8026],</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">#        [ 18.5373, -42.7733,  42.151 ]])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>array([[ 37.5771,  -8.2841, -12.0733],
       [-23.0983,   8.0599,   2.6867],
       [ 14.0654, -33.0609,  33.4288]])</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-executioninfo="{&quot;elapsed&quot;:617,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537416880,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="98499f5c-b958-4325-edb9-b6a2e6274890" data-execution_count="30">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">200</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>dcs_bnd_1_imp_ <span class="op">=</span> <span class="kw">lambda</span> x, y: W_scratch[<span class="dv">0</span>, <span class="dv">1</span>]<span class="op">*</span>x <span class="op">+</span> W_scratch[<span class="dv">0</span>, <span class="dv">2</span>]<span class="op">*</span>y <span class="op">+</span> W_scratch[<span class="dv">0</span>, <span class="dv">0</span>] </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>dcs_bnd_2_imp_ <span class="op">=</span> <span class="kw">lambda</span> x, y: W_scratch[<span class="dv">1</span>, <span class="dv">1</span>]<span class="op">*</span>x <span class="op">+</span> W_scratch[<span class="dv">1</span>, <span class="dv">2</span>]<span class="op">*</span>y <span class="op">+</span> W_scratch[<span class="dv">1</span>, <span class="dv">0</span>] </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>a, b, c <span class="op">=</span> W_scratch[<span class="dv">2</span>, <span class="dv">1</span>], W_scratch[<span class="dv">2</span>, <span class="dv">2</span>], W_scratch[<span class="dv">2</span>, <span class="dv">0</span>] </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>o <span class="op">=</span> <span class="kw">lambda</span> x, y: logistic( a<span class="op">*</span>logistic(dcs_bnd_1_imp_(x, y)) </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                         <span class="op">+</span> b<span class="op">*</span>logistic(dcs_bnd_2_imp_(x, y)) </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                         <span class="op">+</span> c )</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.axes()</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> o(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>])</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>pred_pos <span class="op">=</span> pred <span class="op">&gt;=</span> <span class="fl">0.5</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>pred_neg <span class="op">=</span> pred <span class="op">&lt;</span> <span class="fl">0.5</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>ax.contour(X1, X2, o(X1,X2), cmap<span class="op">=</span><span class="st">'gray'</span>, levels<span class="op">=</span>[<span class="fl">0.5</span>])</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>ax.contourf(X1, X2, o(X1,X2), cmap<span class="op">=</span>cm2, levels<span class="op">=</span>[<span class="op">-</span><span class="dv">10</span>, <span class="fl">0.5</span>, <span class="dv">10</span>], alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="co"># for positive samples</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_pos)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_neg)</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="co"># for negative samples</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_neg)</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_pos)</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a><span class="co"># True Positive and True Negative</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TP,<span class="dv">0</span>], samples[TP,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TN,<span class="dv">0</span>], samples[TN,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co"># False Positive and False Negative</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FN,<span class="dv">0</span>], samples[FN,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, </span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>        markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FP,<span class="dv">0</span>], samples[FP,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, </span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>        markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="신경망-미분하기-데이터-하나에-대해서" class="level2">
<h2 class="anchored" data-anchor-id="신경망-미분하기-데이터-하나에-대해서">신경망 미분하기 (데이터 하나에 대해서)</h2>
<ul>
<li><p>이제 <code>fmin_cg</code>에 전달했던 수치미분으로 미분 계수를 구하는 함수를 자동미분을 이용한 역전파 방식으로 바꿔서 전달할 차례</p></li>
<li><p>지금부터 한단계 한단계 생략없이 주어진 네트워크에 자동미분을 적용하고 그 결과를 파이토치 자동미분과 비교하여 모든 결과의 유효성을 검증</p></li>
</ul>
<div id="cell-60" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pytorch를 임포트 한다.</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="순전파-함수넘파이" class="level3">
<h3 class="anchored" data-anchor-id="순전파-함수넘파이">순전파 함수(넘파이)</h3>
<div id="cell-62" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward(X, W, T, retopt<span class="op">=</span><span class="st">'all'</span>):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">    네트워크를 피드포워드 시킨다. numpy 버전</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">    X : 네트워크의 입력벡터 shape:(N,2)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">    retopt : 네트워크가 순전파되면서 각 레이어에서 계산된 결과 값을 </span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">    되돌릴 방법을 설정한다.</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'all'  : 모든 층에서 계산된 결과를 튜플 형태로 되돌린다.</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'fval' : 함수의 최종 출력값만 되돌린다.</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X.shape[<span class="dv">0</span>]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    H1 <span class="op">=</span> np.dot(W[:<span class="dv">2</span>,<span class="dv">1</span>:], X.T)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> H1 <span class="op">+</span> W[:<span class="dv">2</span>,<span class="dv">0</span>].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    A1 <span class="op">=</span> logistic(Z1)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    H2 <span class="op">=</span> np.dot(W[<span class="dv">2</span>,<span class="dv">1</span>:], A1)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    Z2 <span class="op">=</span> H2 <span class="op">+</span> W[<span class="dv">2</span>,<span class="dv">0</span>]</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> logistic(Z2)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N)) <span class="op">*</span> ((T<span class="op">-</span>A2)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> retopt <span class="op">==</span> <span class="st">'all'</span>:</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (H1, Z1, A1, H2, Z2, A2, C)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> retopt <span class="op">==</span> <span class="st">'fval'</span>:</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="순전파-함수파이토치" class="level3">
<h3 class="anchored" data-anchor-id="순전파-함수파이토치">순전파 함수(파이토치)</h3>
<div id="cell-64" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_torch(X, W, T, retopt<span class="op">=</span><span class="st">'all'</span>):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">    네트워크를 피드포워드 시킨다. pytorch 버전</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">    X : 네트워크의 입력벡터 size:(N,2)</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">    retopt : 네트워크가 순전파되면서 각 레이어에서 계산된 결과 값을 </span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">    되돌릴 방법을 설정한다.</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'all'  : 모든 층에서 계산된 결과를 튜플 형태로 되돌린다.</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'fval' : 함수의 최종 출력값만 되돌린다.</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X.size()[<span class="dv">0</span>]</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> torch.tensor(T, dtype<span class="op">=</span>torch.double)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 계산 결과 검증을 위해 pytorch를 사용하므로 numpy 어레이 뿐 아니라</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pytorch tensor형태에 대해서도 동일한 연산을 한다.</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    H1 <span class="op">=</span> torch.mm(W[:<span class="dv">2</span>,<span class="dv">1</span>:], torch.t(X))</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> H1 <span class="op">+</span> W[:<span class="dv">2</span>,<span class="dv">0</span>].view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    A1 <span class="op">=</span> torch.sigmoid(Z1)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    H2 <span class="op">=</span> torch.mm(W[<span class="dv">2</span>:,<span class="dv">1</span>:], A1)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    Z2 <span class="op">=</span> H2 <span class="op">+</span> W[<span class="dv">2</span>,<span class="dv">0</span>]</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> torch.sigmoid(Z2)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N)) <span class="op">*</span> ((T<span class="op">-</span>A2)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> retopt <span class="op">==</span> <span class="st">'all'</span>:</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (H1, Z1, A1, H2, Z2, A2, C)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> retopt <span class="op">==</span> <span class="st">'fval'</span>:</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="넘파이-어레이와-텐서-프린트-보조함수" class="level3">
<h3 class="anchored" data-anchor-id="넘파이-어레이와-텐서-프린트-보조함수">넘파이 어레이와 텐서 프린트 보조함수</h3>
<div id="cell-66" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(precision<span class="op">=</span><span class="dv">4</span>, linewidth <span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_tensor(t):</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">    텐서형 자료를 보기 좋게 프린트하기 위한 보조 함수</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> namestr(obj, namespace):</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [name <span class="cf">for</span> name <span class="kw">in</span> namespace <span class="cf">if</span> namespace[name] <span class="kw">is</span> obj]</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    var_name <span class="op">=</span> namestr(t, <span class="bu">globals</span>())[<span class="dv">0</span>]</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(var_name, t.shape, t.dtype))</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(t)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-------------------------------------------"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="가중치-무작위-초기화" class="level3">
<h3 class="anchored" data-anchor-id="가중치-무작위-초기화">가중치 무작위 초기화</h3>
<div id="cell-68" class="cell" data-executioninfo="{&quot;elapsed&quot;:81,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537419329,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="ac5cb8ce-a124-4ea6-b970-359046a7208b" data-execution_count="41">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">17</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> np.random.randn(<span class="dv">9</span>).reshape(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>W_torch <span class="op">=</span> torch.tensor(W, dtype<span class="op">=</span>torch.double)<span class="op">;</span> W_torch.requires_grad<span class="op">=</span><span class="va">True</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>print_tensor(W)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>print_tensor(W_torch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>W:(3, 3),float64
[[ 0.2763 -1.8546  0.6239]
 [ 1.1453  1.0372  1.8866]
 [-0.1117 -0.3621  0.1487]]
-------------------------------------------
W_torch:torch.Size([3, 3]),torch.float64
tensor([[ 0.2763, -1.8546,  0.6239],
        [ 1.1453,  1.0372,  1.8866],
        [-0.1117, -0.3621,  0.1487]], dtype=torch.float64, requires_grad=True)
-------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="초기-상태에서-목적함숫값" class="level3">
<h3 class="anchored" data-anchor-id="초기-상태에서-목적함숫값">초기 상태에서 목적함숫값</h3>
<ul>
<li><p>초기 상태에서 목적함숫값을 구하여 <code>forward</code> 함수가 제대로 네트워크를 포워드 패스하는지 확인</p></li>
<li><p><code>J()</code>와 <code>forward()</code>의 출력값이 동일 입력에 대해서 동일해야 함</p></li>
</ul>
<div id="cell-70" class="cell" data-executioninfo="{&quot;elapsed&quot;:69,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537419331,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="defce15d-6acb-444d-8708-baef2db3775b" data-execution_count="42">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 초기 상태에서 목적함숫값</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>J(W, samples, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>0.1263148192185165</code></pre>
</div>
</div>
<div id="cell-71" class="cell" data-executioninfo="{&quot;elapsed&quot;:395,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420141,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="69016763-7fb3-4673-8653-d6190d67e28f" data-execution_count="43">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>H1, Z1, A1, H2, Z2, A2, C <span class="op">=</span> forward(samples, W, target)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>0.1263148192185165</code></pre>
</div>
</div>
</section>
<section id="데이터-하나로-순전파-시키기" class="level3">
<h3 class="anchored" data-anchor-id="데이터-하나로-순전파-시키기">데이터 하나로 순전파 시키기</h3>
<ul>
<li><p>500개 샘플 중에 0번 샘플 하나만 네트워크에 입력하여 순전파 시키고 이후 단계별로 역전파 시켜 가중치와 바이어스에 대한 미분계수를 계산</p></li>
<li><p>이후 계산은 항상 직접 만든 코드와 파이토치의 계산 결과를 비교하면서 진행</p></li>
</ul>
<div id="cell-73" class="cell" data-executioninfo="{&quot;elapsed&quot;:390,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420142,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="7fe0c1b0-abd1-4d92-c242-cf7ac2a5ea37" data-execution_count="44">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> samples[[<span class="dv">0</span>]]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>x_torch <span class="op">=</span> torch.tensor(x, dtype<span class="op">=</span>torch.double)<span class="op">;</span> x_torch.requires_grad<span class="op">=</span><span class="va">True</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> target[[<span class="dv">0</span>]]</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>print_tensor(x)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>print_tensor(x_torch)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>print_tensor(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x:(1, 2),float64
[[2.754  3.5407]]
-------------------------------------------
x_torch:torch.Size([1, 2]),torch.float64
tensor([[2.7540, 3.5407]], dtype=torch.float64, requires_grad=True)
-------------------------------------------
t:(1,),float64
[1.]
-------------------------------------------</code></pre>
</div>
</div>
<div id="cell-74" class="cell" data-executioninfo="{&quot;elapsed&quot;:387,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420150,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="da2e8a24-a2cd-4b32-ae30-31faadc98e0c" data-execution_count="45">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>H1, Z1, A1, H2, Z2, A2, C <span class="op">=</span> forward(x, W, t)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>print_tensor(H1)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>print_tensor(Z1)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>print_tensor(A1)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>print_tensor(H2)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>print_tensor(Z2)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>print_tensor(A2)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>print_tensor(C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>H1:(2, 1),float64
[[-2.8986]
 [ 9.5365]]
-------------------------------------------
Z1:(2, 1),float64
[[-2.6223]
 [10.6818]]
-------------------------------------------
A1:(2, 1),float64
[[0.0677]
 [1.    ]]
-------------------------------------------
H2:(1,),float64
[0.1242]
-------------------------------------------
Z2:(1,),float64
[0.0125]
-------------------------------------------
A2:(1,),float64
[0.5031]
-------------------------------------------
C:(),float64
0.12344827837124746
-------------------------------------------</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-executioninfo="{&quot;elapsed&quot;:380,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420153,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="6f9156a3-eed6-4a58-e597-40cd5d73c82d" data-execution_count="46">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>H1_torch, Z1_torch, A1_torch, H2_torch, Z2_torch, A2_torch, C_torch <span class="op">=</span> forward_torch(x_torch, W_torch, t)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>print_tensor(H1_torch)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>print_tensor(Z1_torch)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>print_tensor(A1_torch)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>print_tensor(H2_torch)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>print_tensor(Z2_torch)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>print_tensor(A2_torch)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>print_tensor(C_torch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>H1_torch:torch.Size([2, 1]),torch.float64
tensor([[-2.8986],
        [ 9.5365]], dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;)
-------------------------------------------
Z1_torch:torch.Size([2, 1]),torch.float64
tensor([[-2.6223],
        [10.6818]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;)
-------------------------------------------
A1_torch:torch.Size([2, 1]),torch.float64
tensor([[0.0677],
        [1.0000]], dtype=torch.float64, grad_fn=&lt;SigmoidBackward0&gt;)
-------------------------------------------
H2_torch:torch.Size([1, 1]),torch.float64
tensor([[0.1242]], dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;)
-------------------------------------------
Z2_torch:torch.Size([1, 1]),torch.float64
tensor([[0.0125]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;)
-------------------------------------------
A2_torch:torch.Size([1, 1]),torch.float64
tensor([[0.5031]], dtype=torch.float64, grad_fn=&lt;SigmoidBackward0&gt;)
-------------------------------------------
C_torch:torch.Size([]),torch.float64
tensor(0.1234, dtype=torch.float64, grad_fn=&lt;MulBackward0&gt;)
-------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="단계별-계산" class="level3">
<h3 class="anchored" data-anchor-id="단계별-계산">단계별 계산</h3>
</section>
<section id="fracpartial-cpartial-mathbfa2-11" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfa2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(2)}}\)</span>: (1,1)</h3>
<ul>
<li><p>목적함수를 목적함수의 직접적인 입력값인 네트워크의 최종 출력 <span class="math inline">\(\mathbf{a}^{(2)}\)</span>로 미분</p></li>
<li><p>현재 예제로 다루는 네트워크는 최종출력이 노드 하나라 <span class="math inline">\(\mathbf{a}^{(2)}\)</span>가 스칼라지만 일반화를 위해 표기는 볼드인 벡터로 함</p></li>
</ul>
<div id="cell-78" class="cell" data-executioninfo="{&quot;elapsed&quot;:371,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420162,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="cda9feec-0400-4abd-a5be-e77a24dc3265" data-execution_count="47">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dA2 <span class="op">=</span> <span class="op">-</span>(t<span class="op">-</span>A2)<span class="op">/</span>N</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>dA2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>array([-0.4969])</code></pre>
</div>
</div>
<ul>
<li><p>위 직접 미분한 결과와 파이토치 미분 결과를 비교</p></li>
<li><p>파이토치 <code>grad</code>함수를 사용하여 종속변수와 독립변수를 지정하고 미분계수를 되돌려 받음</p></li>
</ul>
<div id="cell-80" class="cell" data-executioninfo="{&quot;elapsed&quot;:364,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420164,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="bbb29cc6-2e36-44d1-b769-3f306bdbf0c6" data-execution_count="48">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              종속변수, 독립변수, 종속변수와 곱해지는 상위 그래디언트 </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>dA2_torch <span class="op">=</span> torch.autograd.grad(C_torch, A2_torch, torch.tensor(<span class="dv">1</span>, dtype<span class="op">=</span>torch.double), </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                                retain_graph<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>dA2_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>tensor([[-0.4969]], dtype=torch.float64)</code></pre>
</div>
</div>
<ul>
<li>코드상의 노테이션
<ul>
<li>목적함수에 대한 어떤 독립변수 <code>x</code>의 미분: 독립변수만 표시 <code>dx</code></li>
<li>중간변수 <code>y</code>에 대한 어떤 독립변수 <code>x</code>의 미분: <code>dx</code>: 두 변수를 언더바로 연결 <code>dy_dx</code></li>
</ul></li>
</ul>
</section>
<section id="fracpartial-cpartial-mathbfz2-11" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfz2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(2)}}\)</span>: (1,1)</h3>
<ul>
<li><p><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(2)}}\)</span>에 대한 미분을 끝냈으면 그 다음 단계로 <span class="math inline">\(\mathbf{z}^{(2)}\)</span>에 대한 미분을 할 차례</p></li>
<li><p>이를 위해서 <span class="math inline">\(\frac{d\mathbf{a}^{(2)}}{d\mathbf{z}^{(2)}}\)</span>를 계산하고 다음처럼 연쇄법칙 적용</p></li>
</ul>
<p><span class="math display">\[
\frac{\partial C}{\partial \mathbf{z}^{(2)}} = \frac{d\mathbf{a}^{(2)}}{d\mathbf{z}^{(2)}} \frac{\partial C}{\partial \mathbf{a}^{(2)}}
\]</span></p>
<div id="cell-83" class="cell" data-executioninfo="{&quot;elapsed&quot;:346,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420166,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="112befca-0dff-4dec-c3a2-dc1ca6777498" data-execution_count="49">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>dA2_dZ2 <span class="op">=</span> logistic(Z2)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z2))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>dZ2 <span class="op">=</span> dA2_dZ2 <span class="op">*</span> dA2</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>dZ2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>array([-0.1242])</code></pre>
</div>
</div>
<ul>
<li><p>역시 파이토치 미분 결과와 비교</p></li>
<li><p>두 결과는 완전히 동일해야 함</p></li>
</ul>
<div id="cell-85" class="cell" data-executioninfo="{&quot;elapsed&quot;:322,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420167,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="6a1dea07-f9ec-44bf-8e26-174cf53fd832" data-execution_count="50">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              종속변수, 독립변수, 종속변수와 곱해지는 상위 그래디언트 </span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>dZ2_torch <span class="op">=</span> torch.autograd.grad(C_torch, Z2_torch, torch.tensor(<span class="dv">1</span>, dtype<span class="op">=</span>torch.double), </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                                retain_graph<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>dZ2_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>tensor([[-0.1242]], dtype=torch.float64)</code></pre>
</div>
</div>
<ul>
<li><p>이런 식으로 단위 함수에 대한 미분을 완성하고 지금까지 구한 미분계수를 곱하여 현재까지 미분계수를 계속 구해 나가는 방식을 역전파 알고리즘이라고 함</p></li>
<li><p>그리고 특정층 <span class="math inline">\(l\)</span>에 대한 가중합(가중치를 곱하고 바이어스를 더한 결과) <span class="math inline">\(\mathbf{z}^{(l)}\)</span>에 대한 미분은 특별한 역할을 하므로 다음처럼 <span class="math inline">\(\delta\)</span>로 주로 표시</p></li>
</ul>
<p><span class="math display">\[
\boldsymbol{\delta}^{(l)} = \frac{\partial C}{\partial \mathbf{z}^{(l)}}
\]</span></p>
<ul>
<li>이 문서에서 다음 세 표현은 모두 동일한 것들</li>
</ul>
<p><span class="math display">\[
\boldsymbol{\delta}^{(l)} = \frac{\partial C}{\partial \mathbf{z}^{(l)}} = \frac{\partial C}{\partial \mathbf{h}^{(l)}}
\]</span></p>
<ul>
<li>이 후 계속 진행되는 코드는 계속 반복되므로 슬라이드를 참조하면 됨</li>
</ul>
</section>
<section id="fracpartial-cpartial-mathbfb2-11" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfb2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(2)}}\)</span>: (1,1)</h3>
<ul>
<li><span class="math inline">\(\mathbf{b}^{(2)}\)</span>에 대한 미분은 더하기 연산의 백워드 패스 특성에 따라 그냥 <span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(2)}}\)</span>가 됨</li>
</ul>
<div id="cell-89" class="cell" data-executioninfo="{&quot;elapsed&quot;:278,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420169,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="a2d291a1-ed9b-4c09-d3e8-50c5ad1b6dab" data-execution_count="51">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>db2 <span class="op">=</span> dZ2</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>db2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>array([-0.1242])</code></pre>
</div>
</div>
<div id="cell-90" class="cell" data-executioninfo="{&quot;elapsed&quot;:248,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420171,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="1029fa55-c6b5-469b-d563-07f926209317" data-execution_count="52">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>W_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>tensor([[ 0.2763, -1.8546,  0.6239],
        [ 1.1453,  1.0372,  1.8866],
        [-0.1117, -0.3621,  0.1487]], dtype=torch.float64, requires_grad=True)</code></pre>
</div>
</div>
<ul>
<li><p>파이토치로 결과 확인</p></li>
<li><p>단 여기서는 모든 가중치와 바이어스가 모여있는 <code>W_torch</code>행렬로 미분을 해서 모든 매개변수에 대한 미분계수를 한꺼번에 계산</p></li>
<li><p>그렇게 매개변수에 대한 미분 계수 <code>dW_torch</code>를 계산한 다음 적절한 위치의 숫자를 잘라와서 직접 계산한 미분 계수와 비교</p></li>
</ul>
<div id="cell-92" class="cell" data-executioninfo="{&quot;elapsed&quot;:237,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420172,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="931780f7-bc53-43c0-9549-c3f8cdbe24e2" data-execution_count="53">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              종속변수, 독립변수, 종속변수와 곱해지는 상위 그래디언트 </span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>dW_torch <span class="op">=</span> torch.autograd.grad(C_torch, W_torch, torch.tensor(<span class="dv">1</span>, dtype<span class="op">=</span>torch.double), </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>                               retain_graph<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>dW_torch[<span class="dv">2</span>,<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>tensor(-0.1242, dtype=torch.float64)</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfh2-11" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfh2-11"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{h}^{(2)}}\)</span>: (1,1)</h3>
<div id="cell-94" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>dH2 <span class="op">=</span> dZ2</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>dH2_torch <span class="op">=</span> dZ2_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfw2-12" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfw2-12"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(2)}}\)</span>: (1,2)</h3>
<ul>
<li><p><span class="math inline">\(\mathbf{h}^{(2)}\)</span>를 <span class="math inline">\(\mathbf{W}^{(2)}\)</span>로 미분하는 단계에서는 벡터를 벡터로 미분하는 것이기 때문에 결과는 야코비안이 되야 함</p></li>
<li><p>그런데 <span class="math inline">\(\mathbf{W}^{(2)}\)</span>는 어디까지나 행벡터이기 때문에 정확히 야코비안을 구하려면 <span class="math inline">\(\mathbf{W}^{(2)}\)</span>를 전치시켜서 열벡터로 만들고 나서 미분해야 함</p></li>
<li><p>아래는 그렇게 구해진 야코비안을 계산하는 코드</p></li>
</ul>
<div id="cell-96" class="cell" data-executioninfo="{&quot;elapsed&quot;:219,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420177,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="7c766c2d-c073-4c1c-e0e7-611934cf0329" data-execution_count="55">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>dH2_dW2 <span class="op">=</span> A1.T <span class="co">#(1,2)</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>np.dot(dH2_dW2.T, dH2.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>array([[-0.0084],
       [-0.1242]])</code></pre>
</div>
</div>
<ul>
<li><p>이렇게 구해진 야코비안을 다시 전치 시켜 현재까지 구한 그래디언테 <code>dH2</code>와 곱함</p></li>
<li><p>여기서 역전파 알고리즘의 가장 일반적인 규칙인 ✅<strong>야코비안 전치 곱하기 그래디언트</strong> 가 처음으로 나타남</p></li>
</ul>
<div id="cell-98" class="cell" data-executioninfo="{&quot;elapsed&quot;:210,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420181,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="d16b3ea6-28ef-40b1-95ef-bc3230926827" data-execution_count="56">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>dH2_dW2 <span class="op">=</span> A1.T <span class="co">#(1,2)</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>dW2 <span class="op">=</span> np.dot(dH2_dW2.T, dH2.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="co"># (2,1) 야코비안 전치 곱하기 그레디언트</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>dW2.T <span class="co">#여기서 결과를 다시 전치시켜야 (1,2)가 되는 이유는 일반화 야코비안과 관련있고 뒤에 다시 설명</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>array([[-0.0084, -0.1242]])</code></pre>
</div>
</div>
<div id="cell-99" class="cell" data-executioninfo="{&quot;elapsed&quot;:194,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420185,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="bfc473bb-21fb-4daa-f57e-627b13c9ce17" data-execution_count="57">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>dW_torch[<span class="dv">2</span>,<span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>tensor([-0.0084, -0.1242], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfa1-21" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfa1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(1)}}\)</span>: (2,1)</h3>
<div id="cell-101" class="cell" data-executioninfo="{&quot;elapsed&quot;:132,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420186,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="0ffca939-b952-4842-8111-3666ab9e3cca" data-execution_count="58">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>dH2_dA1 <span class="op">=</span> W[<span class="dv">2</span>:,<span class="dv">1</span>:] <span class="co"># dH2/dA1은 (1,2)인 야코비안이 맞고</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>dH2_dA1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>(1, 2)</code></pre>
</div>
</div>
<div id="cell-102" class="cell" data-executioninfo="{&quot;elapsed&quot;:120,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420190,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="73dddc59-082c-42a3-f978-f00643c01d62" data-execution_count="59">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>dA1 <span class="op">=</span> np.dot(dH2_dA1.T, dH2.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="co"># 따라서 야코비안 전치 그래디언트가 성립, W.T * delta</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>dA1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>array([[ 0.045 ],
       [-0.0185]])</code></pre>
</div>
</div>
<div id="cell-103" class="cell" data-executioninfo="{&quot;elapsed&quot;:798,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420889,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="0d835a9e-4165-4c74-ccb0-43cbbe60a97c" data-execution_count="60">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              종속변수, 독립변수, 종속변수와 곱해지는 상위 그래디언트 </span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>dA1_torch <span class="op">=</span> torch.autograd.grad(C_torch, A1_torch, torch.tensor(<span class="dv">1</span>, dtype<span class="op">=</span>torch.double), </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>                                retain_graph<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>dA1_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>tensor([[ 0.0450],
        [-0.0185]], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfz1-21" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfz1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(1)}}\)</span>: (2,1)</h3>
<div id="cell-105" class="cell" data-executioninfo="{&quot;elapsed&quot;:318,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420891,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="71dabf42-9be6-49aa-eac7-b62933db3735" data-execution_count="61">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>dA1_dZ1 <span class="op">=</span>  np.zeros((A1.shape[<span class="dv">0</span>], Z1.shape[<span class="dv">0</span>]))</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>dA1_dZ1[np.diag_indices(Z1.shape[<span class="dv">0</span>])] <span class="op">=</span> (logistic(Z1)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z1))).reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>dA1_dZ1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>array([[6.3132e-02, 0.0000e+00],
       [0.0000e+00, 2.2958e-05]])</code></pre>
</div>
</div>
<div id="cell-106" class="cell" data-executioninfo="{&quot;elapsed&quot;:311,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420892,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="6b78cc3b-7b91-49de-ec7b-342ea101b24d" data-execution_count="62">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>dZ1 <span class="op">=</span> np.dot(dA1_dZ1.T, dA1)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>dZ1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>array([[ 2.8396e-03],
       [-4.2398e-07]])</code></pre>
</div>
</div>
<div id="cell-107" class="cell" data-executioninfo="{&quot;elapsed&quot;:305,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420893,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="2bdac717-918b-4a63-e5e5-b7adddc8b60c" data-execution_count="63">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              종속변수, 독립변수, 종속변수와 곱해지는 상위 그래디언트 </span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>dZ1_torch <span class="op">=</span> torch.autograd.grad(C_torch, Z1_torch, torch.tensor(<span class="dv">1</span>, dtype<span class="op">=</span>torch.double), </span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>                                retain_graph<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>dZ1_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>tensor([[ 2.8396e-03],
        [-4.2398e-07]], dtype=torch.float64)</code></pre>
</div>
</div>
<ul>
<li><p>중간층에 비선형 활성화 함수는 일변수 스칼라 함수이므로 야코비안은 항상 대각행렬 형태로만 나타남</p></li>
<li><p>그래서 굳이 이렇게 어렵게 하지말고 그냥 엘리먼트 와이즈(아다마르 곱)로 처리하는 것이 더 간편하다.</p></li>
<li><p>넘파이로는 그냥 <code>*</code>연산자로 곱하면 그만</p></li>
</ul>
<div id="cell-109" class="cell" data-executioninfo="{&quot;elapsed&quot;:299,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420893,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="ffbbecfa-5169-4302-e203-c0258f1a86e8" data-execution_count="64">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>dA1_dZ1 <span class="op">=</span> logistic(Z1)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z1))</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>dA1_dZ1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>array([[6.3132e-02],
       [2.2958e-05]])</code></pre>
</div>
</div>
<div id="cell-110" class="cell" data-executioninfo="{&quot;elapsed&quot;:295,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420894,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="b350b9d8-c6c4-48ae-d6b7-35a1215f1922" data-execution_count="65">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>dZ1_ <span class="op">=</span> dA1_dZ1 <span class="op">*</span> dA1</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>dZ1_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>array([[ 2.8396e-03],
       [-4.2398e-07]])</code></pre>
</div>
</div>
<ul>
<li>이후 계산은 <span class="math inline">\(\mathbf{W}^{(1)}\)</span>으로 미분할 때 까지 동일하게 진행</li>
</ul>
</section>
<section id="fracpartial-cpartial-mathbfb1-21" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfb1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(1)}}\)</span>: (2,1)</h3>
<div id="cell-113" class="cell" data-executioninfo="{&quot;elapsed&quot;:290,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420895,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="39f61ae1-a662-4d2c-a0d7-0efbb5e3238d" data-execution_count="66">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>db1 <span class="op">=</span> dZ1</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>db1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>array([[ 2.8396e-03],
       [-4.2398e-07]])</code></pre>
</div>
</div>
<div id="cell-114" class="cell" data-executioninfo="{&quot;elapsed&quot;:285,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420896,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="371b9f23-69b7-43b7-f87b-b04ed673a093" data-execution_count="67">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>dW_torch[:<span class="dv">2</span>,<span class="dv">0</span>].view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>tensor([[ 2.8396e-03],
        [-4.2398e-07]], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfh1-21" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfh1-21"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{h}^{(1)}}\)</span>: (2,1)</h3>
<div id="cell-116" class="cell" data-executioninfo="{&quot;elapsed&quot;:275,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420897,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="36ff21d9-9cd9-47f5-9ae7-cb78169cf07c" data-execution_count="68">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>dH1 <span class="op">=</span> dZ1</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>dH1_torch <span class="op">=</span> dZ1_torch</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>dH1_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>tensor([[ 2.8396e-03],
        [-4.2398e-07]], dtype=torch.float64)</code></pre>
</div>
</div>
<div id="cell-117" class="cell" data-executioninfo="{&quot;elapsed&quot;:269,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420898,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="d39a28ec-2d69-40c2-9771-da14cc1e05db" data-execution_count="69">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>dH1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>array([[ 2.8396e-03],
       [-4.2398e-07]])</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfw1-22" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfw1-22"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(1)}}\)</span>: (2,2)</h3>
<ul>
<li><p>최종적으로 <span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(1)}}\)</span>를 구하기위해 <span class="math inline">\(\frac{\partial \mathbf{h}^{(1)}}{\partial \mathbf{W}^{(1)}}\)</span>를 계산해야 하는데 분자는 벡터, 분모는 행렬 일반적인 규칙으로 미분안됨</p></li>
<li><p>방법1: 일반화 야코비안을 결과로 얻는 법</p>
<ul>
<li><span class="math inline">\(\mathbf{h}^{(1)}\)</span>의 각 요소(스칼라)를 행렬 <span class="math inline">\(\mathbf{W}^{(1)}\)</span>로 미분하여 결과 행렬을 요소 개수 만큼 만들고</li>
<li>이렇게 얻어진 행렬을 야코비안의 각 행으로 보는 방식, 즉 행이 두 개 있는데 각 행의 모양이 (2,2)인 행렬로 (2, (2,2))가 되는 식</li>
</ul></li>
<li><p>방법2: <span class="math inline">\(\mathbf{W}^{(1)}\)</span>을 <span class="math inline">\(\text{vec}\)</span>연산자를 사용하여 벡터로 바꾸거나 일반화 야코비안을 행렬로 바꾸는 방법</p>
<ul>
<li>잠시 후 코드로 같은 결과가 나옴을 확인할 예정</li>
</ul></li>
<li><p><span class="math inline">\(\frac{\partial \mathbf{h}^{(1)}}{\partial \mathbf{W}^{(1)}}\)</span>를 계산하면 <span class="math inline">\(\mathbf{h}^{(1)}\)</span>가 계산되는 과정 때문에 각 행렬에 결과적으로 <span class="math inline">\(\mathbf{h}^{(1)}\)</span>를 계산하기 위해 <span class="math inline">\(\mathbf{W}^{(1)}\)</span>과 곱해지는 입력이 나타나게 됨</p></li>
</ul>
<div id="cell-119" class="cell" data-executioninfo="{&quot;elapsed&quot;:263,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420899,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="1b0e3034-9f2e-40ee-c13c-f1610f3dd520" data-execution_count="70">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>dH1_dW1 <span class="op">=</span> np.zeros((<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>dH1_dW1[<span class="dv">0</span>,<span class="dv">0</span>,:] <span class="op">=</span> x</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>dH1_dW1[<span class="dv">1</span>,<span class="dv">1</span>,:] <span class="op">=</span> x</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>print_tensor(dH1_dW1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dH1_dW1:(2, 2, 2),float64
[[[2.754  3.5407]
  [0.     0.    ]]

 [[0.     0.    ]
  [2.754  3.5407]]]
-------------------------------------------</code></pre>
</div>
</div>
<div id="cell-120" class="cell" data-executioninfo="{&quot;elapsed&quot;:258,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420900,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="46becac3-d831-4198-f4d7-f09ef0adc053" data-execution_count="71">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>dH1.reshape(dH1.shape[<span class="dv">0</span>], <span class="dv">1</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>array([[[ 2.8396e-03]],

       [[-4.2398e-07]]])</code></pre>
</div>
</div>
<ul>
<li><p>위 두 셀에서 구한 <span class="math inline">\(\frac{\partial \mathbf{h}^{(1)}}{\partial \mathbf{W}^{(1)}}\)</span>과 <span class="math inline">\(\frac{\partial C}{\partial \mathbf{h}^{(1)}}\)</span>를 행렬곱</p></li>
<li><p>여기서 행렬곱할 때 앞에서 곱하는 행렬의 열을 뒤에서 곱하는 벡터의 숫자로 선형조합하는 논리가 적용됨</p></li>
<li><p>아래 코드는 그 논리를 그대로 코드로 옮긴 것</p></li>
</ul>
<div id="cell-122" class="cell" data-executioninfo="{&quot;elapsed&quot;:251,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420901,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="06deb845-8ed9-4c40-c97c-d47a39eca372" data-execution_count="72">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>dW1 <span class="op">=</span> (dH1_dW1<span class="op">*</span>dH1.reshape(dH1.shape[<span class="dv">0</span>], <span class="dv">1</span>, <span class="dv">1</span>)).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>dW1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>array([[ 7.8203e-03,  1.0054e-02],
       [-1.1676e-06, -1.5012e-06]])</code></pre>
</div>
</div>
<div id="cell-123" class="cell" data-executioninfo="{&quot;elapsed&quot;:245,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420902,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="90943234-d15a-418c-ae10-fb97184982bf" data-execution_count="73">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>dW_torch[:<span class="dv">2</span>,<span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>tensor([[ 7.8203e-03,  1.0054e-02],
        [-1.1676e-06, -1.5012e-06]], dtype=torch.float64)</code></pre>
</div>
</div>
<ul>
<li>위 진행한 연산의 최종 결과를 정리하면 다음처럼 <span class="math inline">\(l\)</span>층의 가중치 <span class="math inline">\(\mathbf{W}^{(l)}\)</span>에 대한 미분의 일반 공식을 알 수 있음</li>
</ul>
<p><span class="math display">\[
\frac{\partial C}{\partial \mathbf{W}^{(l)}} = \boldsymbol{\delta}^{(l)} \left( \mathbf{a}^{(l-1)}\right)^T
\]</span></p>
<div id="cell-125" class="cell" data-executioninfo="{&quot;elapsed&quot;:240,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420903,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="a71e26f8-1d41-41e5-c8fc-05fa1643cc4d" data-execution_count="74">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dH1.shape)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x.shape)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>np.dot(dH1, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(2, 1)
(1, 2)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>array([[ 7.8203e-03,  1.0054e-02],
       [-1.1676e-06, -1.5012e-06]])</code></pre>
</div>
</div>
</section>
<section id="텐서-평활화" class="level3">
<h3 class="anchored" data-anchor-id="텐서-평활화">텐서 평활화</h3>
<ul>
<li><p><span class="math inline">\(W^{(1)}\)</span>에 대한 미분 계수를 구할 때 행렬곱에서 알아본 열조합으로 설명되는 행렬곱을 적용</p></li>
<li><p>여기서는 텐서 형태로 구해지는 일반화 야코비안을 행렬 형태로 펼쳐서 계산하는 방법을 실험</p></li>
<li><p>결국은 같은 연산을 하게 되고 <span class="math inline">\(\mathbf{h}^{(1)}\)</span>을 <span class="math inline">\(W^{(1)}\)</span>으로 미분할 때 <span class="math inline">\(W^{(1)}\)</span>을 <span class="math inline">\(\text{vec}\)</span> 연산자로 벡터로 바꾼 다음 미분하는 것과 같은 결과를 얻게 됨</p></li>
<li><p>행렬에 <span class="math inline">\(\text{vec}\)</span> 연산자와 <span class="math inline">\(\text{vec}\)</span> 역연산이 적용되는 규칙은 “벡터, 행렬에 대한 미분”(https://metamath1.github.io/2018/01/02/matrix-derivatives.html)에서 vec과 vec전치 부분 참고</p></li>
<li><p>아래 코드는 (2,2,2)인 텐서를 <code>reshape</code>하여 (4,2)로 만들고 다시 원래 모양으로 되돌리는 실험 코드</p></li>
</ul>
<div id="cell-127" class="cell" data-executioninfo="{&quot;elapsed&quot;:233,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420904,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="f5250333-0557-48e9-cc4a-4032bd018218" data-execution_count="75">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> np.arange(<span class="dv">8</span>).reshape(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>array([[[0, 1],
        [2, 3]],

       [[4, 5],
        [6, 7]]])</code></pre>
</div>
</div>
<div id="cell-128" class="cell" data-executioninfo="{&quot;elapsed&quot;:228,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420905,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="3d62db32-67cf-4930-af2d-2641041a83f4" data-execution_count="76">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>T.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>array([[0, 1],
       [2, 3],
       [4, 5],
       [6, 7]])</code></pre>
</div>
</div>
<div id="cell-129" class="cell" data-executioninfo="{&quot;elapsed&quot;:222,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420907,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="e503d8e8-e3ca-4b9c-998f-278d59db818f" data-execution_count="77">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>T.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>).reshape(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>array([[[0, 1],
        [2, 3]],

       [[4, 5],
        [6, 7]]])</code></pre>
</div>
</div>
<section id="텐서를-평활화해서-경사도벡터와-곱하는-한줄-코드" class="level4">
<h4 class="anchored" data-anchor-id="텐서를-평활화해서-경사도벡터와-곱하는-한줄-코드">텐서를 평활화해서 경사도벡터와 곱하는 한줄 코드</h4>
<ul>
<li>텐서를 전치시키고, 평활화 한 다음 야코비안과 그래디언트를 곱하고 다시 원래 모양으로 돌려놓는 한줄 코드</li>
</ul>
<div id="cell-131" class="cell" data-executioninfo="{&quot;elapsed&quot;:217,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420908,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="b6fc27dd-aa94-48fd-ca24-4d47bdee9df8" data-execution_count="78">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>np.dot(</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    dH1_dW1.transpose(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>).reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>), <span class="co"># Transposing and Flattening Jacobian </span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    dH1 <span class="co"># Mutiply jacobian by gradient</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    ).reshape(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>).squeeze() <span class="co"># reshaping</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>array([[ 7.8203e-03,  1.0054e-02],
       [-1.1676e-06, -1.5012e-06]])</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="데이터가-여러개인-경우" class="level2">
<h2 class="anchored" data-anchor-id="데이터가-여러개인-경우">데이터가 여러개인 경우</h2>
<ul>
<li><p>이제 데이터 여러개가 한꺼번에 입력되는 경우에 대해 생각</p></li>
<li><p>여기서는 확인을 쉽게 하기 위해 데이터 세 개 에 대해서 실험 즉 <span class="math inline">\(N=3\)</span></p></li>
</ul>
<div id="cell-133" class="cell" data-executioninfo="{&quot;elapsed&quot;:214,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420910,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="4f627563-acca-4a37-b8d4-ae04d600c0e3" data-execution_count="79">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span><span class="dv">3</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> samples[[<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">10</span>]]</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>x_torch <span class="op">=</span> torch.tensor(x, dtype<span class="op">=</span>torch.double)<span class="op">;</span> x_torch.requires_grad<span class="op">=</span><span class="va">True</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> target[[<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">10</span>]]</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>print_tensor(x)</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>print_tensor(x_torch)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>print_tensor(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x:(3, 2),float64
[[2.754  3.5407]
 [0.1494 2.2842]
 [1.4176 3.4657]]
-------------------------------------------
x_torch:torch.Size([3, 2]),torch.float64
tensor([[2.7540, 3.5407],
        [0.1494, 2.2842],
        [1.4176, 3.4657]], dtype=torch.float64, requires_grad=True)
-------------------------------------------
t:(3,),float64
[1. 0. 1.]
-------------------------------------------</code></pre>
</div>
</div>
<section id="순전파와-역전파를-동시에-하는-함수" class="level3">
<h3 class="anchored" data-anchor-id="순전파와-역전파를-동시에-하는-함수">순전파와 역전파를 동시에 하는 함수</h3>
<ul>
<li><p>여러 데이터에 대해서 순전파와 역잔파를 동시에 하는 함수 작성</p></li>
<li><p>함수 내부 코드는 지금까지 진행한 단계별 코드를 한군데 모은것</p></li>
</ul>
<div id="cell-135" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_backward(X, W, T):</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="co">    네트워크를 포워드, 백워드 시킨다. numpy 버전</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co">    X : 네트워크의 입력벡터 shape:(N,2)</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="co">    반환 : 목적함수, (W1에 대한 미분계수, b1에 대한 미분계수,</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a><span class="co">                     W2에 대한 미분계수, b2에 대한 미분계수)</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># forward</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X.shape[<span class="dv">0</span>]</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>    H1 <span class="op">=</span> np.dot(W[:<span class="dv">2</span>,<span class="dv">1</span>:], X.T)</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> H1 <span class="op">+</span> W[:<span class="dv">2</span>,<span class="dv">0</span>].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>    A1 <span class="op">=</span> logistic(Z1)</span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    H2 <span class="op">=</span> np.dot(W[<span class="dv">2</span>,<span class="dv">1</span>:], A1)</span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>    Z2 <span class="op">=</span> H2 <span class="op">+</span> W[<span class="dv">2</span>,<span class="dv">0</span>]</span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> logistic(Z2)</span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N)) <span class="op">*</span> ((T<span class="op">-</span>A2)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># backward, dA-&gt;dZ-&gt;db-&gt;dW</span></span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>    dA2 <span class="op">=</span> <span class="op">-</span>(T<span class="op">-</span>A2)<span class="op">/</span>N</span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>    dA2_dZ2 <span class="op">=</span> logistic(Z2)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z2))</span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>    dZ2 <span class="op">=</span> dA2_dZ2 <span class="op">*</span> dA2</span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>    db2 <span class="op">=</span> dZ2</span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>    dW2 <span class="op">=</span> np.dot(dZ2, A1.T)</span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>    dH2_dA1 <span class="op">=</span> W[<span class="dv">2</span>:,<span class="dv">1</span>:]</span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>    dA1 <span class="op">=</span> np.dot(dH2_dA1.T, dZ2.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>    dA1_dZ1 <span class="op">=</span> logistic(Z1)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z1))</span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>    dZ1 <span class="op">=</span> dA1_dZ1 <span class="op">*</span> dA1</span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a>    db1 <span class="op">=</span> dZ1</span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a>    dW1 <span class="op">=</span> np.dot(dZ1, X) <span class="co"># X is A0.T</span></span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> C, (dW1, db1, dW2, db2)</span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="모든-데이터에-대해-각각-역전파한-미분계수를-평균하기" class="level3">
<h3 class="anchored" data-anchor-id="모든-데이터에-대해-각각-역전파한-미분계수를-평균하기">모든 데이터에 대해 각각 역전파한 미분계수를 평균하기</h3>
<ul>
<li><p>목적함수는 항상 데이터에 대해서 합산되는 형태이기 때문에 샘플하나로 순전파 역전파 한 과정을 데이터 개수만큼 반복하고 그 결과를 모두 더해서 평균하면 데이터 여러개에 대한 미분계수를 쉽게 구할 수 있음</p></li>
<li><p>아래 코드로 확인</p></li>
</ul>
<div id="cell-137" class="cell" data-executioninfo="{&quot;elapsed&quot;:211,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420916,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="508e0dfc-b7ca-42ac-b9b7-cf70b32e0258" data-execution_count="81">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>f, dW1, db1, dW2, db2 <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x_, t_ <span class="kw">in</span> <span class="bu">zip</span>(x, t):</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    x_ <span class="op">=</span> np.array([x_])</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    t_ <span class="op">=</span> np.array([t_])</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    fv, derivs <span class="op">=</span> forward_backward(x_, W, t_)</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    f <span class="op">+=</span> fv</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    dW1 <span class="op">+=</span> derivs[<span class="dv">0</span>]</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    db1 <span class="op">+=</span> derivs[<span class="dv">1</span>]</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    dW2 <span class="op">+=</span> derivs[<span class="dv">2</span>]</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    db2 <span class="op">+=</span> derivs[<span class="dv">3</span>]</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>f   <span class="op">/=</span> N</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>dW1 <span class="op">/=</span> N</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>db1 <span class="op">/=</span> N</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>dW2 <span class="op">/=</span> N</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>db2 <span class="op">/=</span> N</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'C:'</span>, f)</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>print_tensor(dW1)</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>print_tensor(db1)</span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>print_tensor(dW2)</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>print_tensor(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>C: 0.12001678911062634
dW1:(2, 2),float64
[[7.9160e-03 1.2443e-02]
 [1.5168e-06 4.1280e-05]]
-------------------------------------------
db1:(2, 1),float64
[[2.8791e-03]
 [1.8509e-05]]
-------------------------------------------
dW2:(2,),float64
[ 0.0061 -0.0499]
-------------------------------------------
db2:(1,),float64
[-0.0497]
-------------------------------------------</code></pre>
</div>
</div>
<ul>
<li><p>이 결과가 맞는지 아래에서 확인할 것임</p></li>
<li><p>이런 방식은 데이터 개수만큼 계속 반복을 하면서 순전파 역전파를 하기 때문에 비효올적</p></li>
<li><p>행렬 연산을 이용하여 한번 순전파와 역전파 만으로 모든 데이터에 대한 연산과 합산을 할 수 있음</p></li>
</ul>
</section>
<section id="역전파-한번으로-미분계수-구하기" class="level3">
<h3 class="anchored" data-anchor-id="역전파-한번으로-미분계수-구하기">역전파 한번으로 미분계수 구하기</h3>
<div id="cell-140" class="cell" data-executioninfo="{&quot;elapsed&quot;:207,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420917,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="763e8730-6c5c-4e2a-ee7f-98d710a883bd" data-execution_count="82">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>array([[2.754 , 3.5407],
       [0.1494, 2.2842],
       [1.4176, 3.4657]])</code></pre>
</div>
</div>
</section>
<section id="순전파" class="level3">
<h3 class="anchored" data-anchor-id="순전파">순전파</h3>
<div id="cell-142" class="cell" data-executioninfo="{&quot;elapsed&quot;:201,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420918,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="0a900237-b63d-4ed7-9ce5-9fab54706013" data-execution_count="83">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>H1, Z1, A1, H2, Z2, A2, C <span class="op">=</span> forward(x, W.reshape(<span class="dv">3</span>,<span class="dv">3</span>), t)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>print_tensor(H1)</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>print_tensor(Z1)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>print_tensor(A1)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>print_tensor(H2)</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>print_tensor(Z2)</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>print_tensor(A2)</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>print_tensor(C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>H1:(2, 3),float64
[[-2.8986  1.148  -0.4669]
 [ 9.5365  4.4643  8.0089]]
-------------------------------------------
Z1:(2, 3),float64
[[-2.6223  1.4243 -0.1907]
 [10.6818  5.6096  9.1542]]
-------------------------------------------
A1:(2, 3),float64
[[0.0677 0.806  0.4525]
 [1.     0.9964 0.9999]]
-------------------------------------------
H2:(3,),float64
[ 0.1242 -0.1437 -0.0152]
-------------------------------------------
Z2:(3,),float64
[ 0.0125 -0.2554 -0.1269]
-------------------------------------------
A2:(3,),float64
[0.5031 0.4365 0.4683]
-------------------------------------------
C:(),float64
0.12001678911062633
-------------------------------------------</code></pre>
</div>
</div>
<div id="cell-143" class="cell" data-executioninfo="{&quot;elapsed&quot;:196,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420920,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="2f97381a-74de-472e-8fc8-02d26f095cd9" data-execution_count="84">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>H1_torch, Z1_torch, A1_torch, H2_torch, Z2_torch, A2_torch, C_torch <span class="op">=</span> forward_torch(x_torch, W_torch, t)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>print_tensor(H1_torch)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>print_tensor(Z1_torch)</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>print_tensor(A1_torch)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>print_tensor(H2_torch)</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>print_tensor(Z2_torch)</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>print_tensor(A2_torch)</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>print_tensor(C_torch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>H1_torch:torch.Size([2, 3]),torch.float64
tensor([[-2.8986,  1.1480, -0.4669],
        [ 9.5365,  4.4643,  8.0089]], dtype=torch.float64,
       grad_fn=&lt;MmBackward0&gt;)
-------------------------------------------
Z1_torch:torch.Size([2, 3]),torch.float64
tensor([[-2.6223,  1.4243, -0.1907],
        [10.6818,  5.6096,  9.1542]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)
-------------------------------------------
A1_torch:torch.Size([2, 3]),torch.float64
tensor([[0.0677, 0.8060, 0.4525],
        [1.0000, 0.9964, 0.9999]], dtype=torch.float64,
       grad_fn=&lt;SigmoidBackward0&gt;)
-------------------------------------------
H2_torch:torch.Size([1, 3]),torch.float64
tensor([[ 0.1242, -0.1437, -0.0152]], dtype=torch.float64,
       grad_fn=&lt;MmBackward0&gt;)
-------------------------------------------
Z2_torch:torch.Size([1, 3]),torch.float64
tensor([[ 0.0125, -0.2554, -0.1269]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)
-------------------------------------------
A2_torch:torch.Size([1, 3]),torch.float64
tensor([[0.5031, 0.4365, 0.4683]], dtype=torch.float64,
       grad_fn=&lt;SigmoidBackward0&gt;)
-------------------------------------------
C_torch:torch.Size([]),torch.float64
tensor(0.1200, dtype=torch.float64, grad_fn=&lt;MulBackward0&gt;)
-------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="단계별-역전파" class="level3">
<h3 class="anchored" data-anchor-id="단계별-역전파">단계별 역전파</h3>
<ul>
<li>데이터가 N개가 되었기 때문에 앞선 단계별 역전파를 하면서 얻어진 결과 행렬들에서 열 개수가 N개로 늘어났을 뿐 계산 과정과 코드는 완전히 동일</li>
</ul>
</section>
<section id="fracpartial-cpartial-mathbfa2-1n" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfa2-1n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(2)}}\)</span>: (1,N)</h3>
<div id="cell-146" class="cell" data-executioninfo="{&quot;elapsed&quot;:191,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420921,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="18e256a8-2de4-4e93-f85d-673cf8403e27" data-execution_count="85">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>dA2 <span class="op">=</span> <span class="op">-</span>(t<span class="op">-</span>A2)<span class="op">/</span>N</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>dA2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>array([-0.1656,  0.1455, -0.1772])</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfz2-1n" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfz2-1n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(2)}}\)</span>: (1,N)</h3>
<div id="cell-148" class="cell" data-executioninfo="{&quot;elapsed&quot;:183,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420922,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="3cb742c9-057d-4a79-f69d-04cd39706756" data-execution_count="86">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>dA2_dZ2 <span class="op">=</span> logistic(Z2)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z2))</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>dZ2 <span class="op">=</span> dA2_dZ2 <span class="op">*</span> dA2</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>dZ2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>array([-0.0414,  0.0358, -0.0441])</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfb2-11-1" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfb2-11-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(2)}}\)</span>: (1,1)</h3>
<ul>
<li><p>앞서 샘플이 하나일 때 <span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(l)}} = \delta^{(l)}\)</span>이었음</p></li>
<li><p>그런데 여기서는 <span class="math inline">\(\delta^{(l)}\)</span>이 데이터 개수만큼 있어서 (1,N) 형태이므로 데이터에 대해서 모두 합산</p></li>
</ul>
<div id="cell-150" class="cell" data-executioninfo="{&quot;elapsed&quot;:170,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420923,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="bf073ec5-1121-4817-97ad-081accd870c5" data-execution_count="87">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>db2 <span class="op">=</span> dZ2.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>dH2 <span class="op">=</span> dZ2</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>db2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>array([-0.0497])</code></pre>
</div>
</div>
<ul>
<li><p>이 결과는 앞서 루프를 사용해서 계산한 <code>db2</code>와 일치해야 함</p></li>
<li><p>여기서 <span class="math inline">\(\mathbf{b}^{(l)}\)</span>에 대한 일반 공식을 얻음</p></li>
</ul>
<p><span class="math display">\[
\frac{\partial C}{\partial \mathbf{b}^{(l)}} = \sum_{j} \boldsymbol{\delta}^{(l)}_{:\, , \, j}
\]</span></p>
<ul>
<li>위 식에서 <span class="math inline">\(\boldsymbol{\delta}^{(l)}_{:\, , \, j}\)</span>는 <span class="math inline">\(\boldsymbol{\delta}^{(l)}\)</span>의 <span class="math inline">\(j\)</span>번째 열을 나타냄</li>
</ul>
</section>
<section id="fracpartial-cpartial-mathbfw2-12-1" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfw2-12-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(2)}}\)</span>: (1,2)</h3>
<div id="cell-153" class="cell" data-executioninfo="{&quot;elapsed&quot;:161,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420924,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="c4e71461-2559-4b31-fda3-2bfc6d2a0e24" data-execution_count="88">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>dH2_dW2 <span class="op">=</span> A1.T</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>dW2 <span class="op">=</span> np.dot(dH2, dH2_dW2) <span class="co"># 정리된 결과로 야코비안 전치 평활화 따위 하지 않고 바로 delta * a.T</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>dW2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>array([ 0.0061, -0.0499])</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfa1-2n" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfa1-2n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{a}^{(1)}}\)</span>: (2,N)</h3>
<div id="cell-155" class="cell" data-executioninfo="{&quot;elapsed&quot;:151,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420925,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="f28da705-2422-46d6-cb7e-eed5b19bb469" data-execution_count="89">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>dH2_dA1 <span class="op">=</span> W[<span class="dv">2</span>:,<span class="dv">1</span>:] <span class="co"># 분자레이아웃 아코비안 W2 (1,2)</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>dA1 <span class="op">=</span> np.dot(dH2_dA1.T, dH2.reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>)) <span class="co"># W.T * delta</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>dA1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>array([[ 0.015 , -0.013 ,  0.016 ],
       [-0.0062,  0.0053, -0.0066]])</code></pre>
</div>
</div>
<ul>
<li>여기서 <span class="math inline">\(\mathbf{a}^{l}\)</span>에 대한 미분의 일반 공식을 얻을 수 있음</li>
</ul>
<p><span class="math display">\[
\frac{\partial C}{\partial \mathbf{a}^{(l)}} =  \frac{\partial \mathbf{z}^{(l+1)}}{\partial \mathbf{a}^{(l)}} \frac{\partial C}{\partial \mathbf{z}^{(l+1)}} ={\mathbf{W}^{(l+1)}}^T \delta^{(l+1)}
\]</span></p>
</section>
<section id="fracpartial-cpartial-mathbfz1-2n" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfz1-2n"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{z}^{(1)}}\)</span>: (2,N)</h3>
<div id="cell-158" class="cell" data-executioninfo="{&quot;elapsed&quot;:143,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420925,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="d137bfcd-39c2-48f7-9cfb-9090be302ad8" data-execution_count="90">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>dA1_dZ1 <span class="op">=</span>  logistic(Z1)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z1))</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>dA1_dZ1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>array([[6.3132e-02, 1.5636e-01, 2.4774e-01],
       [2.2958e-05, 3.6357e-03, 1.0576e-04]])</code></pre>
</div>
</div>
<div id="cell-159" class="cell" data-executioninfo="{&quot;elapsed&quot;:133,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420926,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="28482afa-728e-4d48-bb83-e6404701d120" data-execution_count="91">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>dZ1 <span class="op">=</span> dA1_dZ1 <span class="op">*</span> dA1 <span class="co"># 엘리먼트와이즈 곱</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>dZ1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>array([[ 9.4654e-04, -2.0261e-03,  3.9587e-03],
       [-1.4133e-07,  1.9344e-05, -6.9385e-07]])</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfb1-21-1" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfb1-21-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{b}^{(1)}}\)</span>: (2,1)</h3>
<div id="cell-161" class="cell" data-executioninfo="{&quot;elapsed&quot;:107,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420927,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="53aed48f-e4e4-412c-9b1d-5852bbcfaf61" data-execution_count="92">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>db1 <span class="op">=</span> dZ1.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>db1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>array([[2.8791e-03],
       [1.8509e-05]])</code></pre>
</div>
</div>
</section>
<section id="fracpartial-cpartial-mathbfw1-22-1" class="level3">
<h3 class="anchored" data-anchor-id="fracpartial-cpartial-mathbfw1-22-1"><span class="math inline">\(\frac{\partial C}{\partial \mathbf{W}^{(1)}}\)</span>: (2,2)</h3>
<div id="cell-163" class="cell" data-executioninfo="{&quot;elapsed&quot;:93,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537420927,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="23e6d74c-fcf6-4223-d23d-c000069c0934" data-execution_count="93">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>dW1 <span class="op">=</span> np.dot(dZ1, x) <span class="co"># delta * a.T</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>dW1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>array([[7.9160e-03, 1.2443e-02],
       [1.5168e-06, 4.1280e-05]])</code></pre>
</div>
</div>
<ul>
<li><p><span class="math inline">\(\mathbf{W}^{(1)}\)</span>로 미분하는 경우는 데이터에 대해 모두 합산하는 과정이 없는데 구해진 미분 계수를 보면 앞서 루프를 돌면서 구한 결과와 정확히 일치함</p></li>
<li><p>합산 과정이 없어도 제대로 미분계수가 구해지는 이유는 행렬곱이 되면서 데이터에 대해서 합산되는 과정이 저절로 실행되기 때문</p></li>
<li><p>이 과정을 바로 이해하기 위해서는 행렬곱을 앞에서 곱하는 행렬의 열과 뒤에서 곱하는 행렬의 행으로 외적하여 생기는 행렬들의 합으로 이해하는 시각이 필요</p></li>
<li><p>자세한 그림 표현은 슬라이드 참조</p></li>
</ul>
</section>
<section id="파이토치로-미분하기" class="level3">
<h3 class="anchored" data-anchor-id="파이토치로-미분하기">파이토치로 미분하기</h3>
<ul>
<li>파이토치로 미분해서 위 데이터 세개에 대한 역전파가 정확한지 확인</li>
</ul>
<div id="cell-167" class="cell" data-executioninfo="{&quot;elapsed&quot;:264,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653537447372,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="510fa610-7849-48f2-d003-3f3edc15f785" data-execution_count="94">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              종속변수, 독립변수, 종속변수와 곱해지는 상위 그래디언트 </span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>dW_torch <span class="op">=</span> torch.autograd.grad(C_torch, W_torch, torch.tensor(<span class="dv">1</span>, dtype<span class="op">=</span>torch.double), </span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>                               retain_graph<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>dW_torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>tensor([[ 2.8791e-03,  7.9160e-03,  1.2443e-02],
        [ 1.8509e-05,  1.5168e-06,  4.1280e-05],
        [-4.9747e-02,  6.0737e-03, -4.9872e-02]], dtype=torch.float64)</code></pre>
</div>
</div>
<ul>
<li>파이토치로 미분한 결과와 루프를 돌리면서 구한 결과, 자동미분으로 구한 결과를 모두 비교하면 동일함을 확인할 수 있음</li>
</ul>
</section>
</section>
<section id="자동미분으로-신경망-학습하기" class="level2">
<h2 class="anchored" data-anchor-id="자동미분으로-신경망-학습하기">자동미분으로 신경망 학습하기</h2>
<ul>
<li><p>마지막으로 역전파를 이용해서 미분계수를 구하는 함수를 만들고 이 함수를 <code>scipy.optimize.fmin_cg</code>에 전달하여 수치 미분한 결과와 동일한 결과가 얻어지는지 확인</p></li>
<li><p>샘플 한개에 대해서 순전파, 역전파 하는 함수 <code>forward_backward</code>를 약간 수정하여 <code>foward_backward2</code>로 작성</p></li>
<li><p>매개변수로 <code>W</code>를 행렬형태로 변환하기 위하 행과 열에 해당하는 숫자 <code>k</code>, <code>l</code>을 받는 것만 다르고 나머지 코드는 모두 동일</p></li>
</ul>
<div id="cell-170" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_backward2(W, X, T, k, l):</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="co">    W: 모든 weight, bias를 가지고 있는 1차원 벡터</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="co">    X: 네트워크의 입력벡터 shape:(N,2)</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="co">    T: 네트워크의 정답벡터 shape:(N,)</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="co">    k, l : weight, bias가 들어있는 행렬의 모양</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="co">    반환 : dW</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># forward</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X.shape[<span class="dv">0</span>]</span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> W.reshape(k,l)</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    dW <span class="op">=</span> np.zeros_like(W)</span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>    H1 <span class="op">=</span> np.dot(W[:<span class="dv">2</span>,<span class="dv">1</span>:], X.T)</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> H1 <span class="op">+</span> W[:<span class="dv">2</span>,<span class="dv">0</span>].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>    A1 <span class="op">=</span> logistic(Z1)</span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>    H2 <span class="op">=</span> np.dot(W[<span class="dv">2</span>,<span class="dv">1</span>:], A1)</span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>    Z2 <span class="op">=</span> H2 <span class="op">+</span> W[<span class="dv">2</span>,<span class="dv">0</span>]</span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> logistic(Z2)</span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N)) <span class="op">*</span> ((T<span class="op">-</span>A2)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># backward, dA-&gt;dZ-&gt;db-&gt;dW</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">######################################################################</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># WRITE YOUR CODE HERE</span></span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 위 샘플 3개를 순전파 역전파 하나 코드를 참고하여 데이터 N개 에 대해서</span></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 순전파 역전파되는 코드를 단계별로 완성하세요.</span></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">###########</span></span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dA2 ~ dZ2</span></span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>    dA2 <span class="op">=</span> <span class="op">-</span>(T<span class="op">-</span>A2)<span class="op">/</span>N</span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>    dA2_dZ2 <span class="op">=</span> logistic(Z2)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z2))</span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>    dZ2 <span class="op">=</span> dA2_dZ2 <span class="op">*</span> dA2</span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#############</span></span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># db2 and dW2</span></span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>    db2 <span class="op">=</span> dZ2.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>, keepdims<span class="op">=</span><span class="va">True</span>) <span class="co">#(1,)</span></span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a>    dW2 <span class="op">=</span> np.dot(dZ2, A1.T) <span class="co">#(2,)</span></span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------</span></span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">###########</span></span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dA1 ~ dZ1</span></span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a>    dZ2_dA1 <span class="op">=</span> W[<span class="dv">2</span>:,<span class="dv">1</span>:]</span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a>    dA1 <span class="op">=</span> np.dot(dZ2_dA1.T, dZ2.reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a>    dA1_dZ1 <span class="op">=</span> logistic(Z1)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>logistic(Z1))</span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a>    dZ1 <span class="op">=</span> dA1_dZ1 <span class="op">*</span> dA1</span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-51"><a href="#cb152-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">#############</span></span>
<span id="cb152-52"><a href="#cb152-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># db1 and dW1</span></span>
<span id="cb152-53"><a href="#cb152-53" aria-hidden="true" tabindex="-1"></a>    db1 <span class="op">=</span> dZ1.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>) <span class="co"># (2,1)</span></span>
<span id="cb152-54"><a href="#cb152-54" aria-hidden="true" tabindex="-1"></a>    dW1 <span class="op">=</span> np.dot(dZ1, X) <span class="co"># X is A0.T, (2,2)</span></span>
<span id="cb152-55"><a href="#cb152-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">#####################################################################</span></span>
<span id="cb152-56"><a href="#cb152-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-57"><a href="#cb152-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dW 모양 만들고 벡터로 펴서 리턴</span></span>
<span id="cb152-58"><a href="#cb152-58" aria-hidden="true" tabindex="-1"></a>    dW[:<span class="dv">2</span>,[<span class="dv">0</span>]] <span class="op">=</span> db1</span>
<span id="cb152-59"><a href="#cb152-59" aria-hidden="true" tabindex="-1"></a>    dW[:<span class="dv">2</span>,<span class="dv">1</span>:] <span class="op">=</span> dW1</span>
<span id="cb152-60"><a href="#cb152-60" aria-hidden="true" tabindex="-1"></a>    dW[<span class="dv">2</span>,<span class="dv">0</span>] <span class="op">=</span> db2</span>
<span id="cb152-61"><a href="#cb152-61" aria-hidden="true" tabindex="-1"></a>    dW[<span class="dv">2</span>,<span class="dv">1</span>:] <span class="op">=</span> dW2</span>
<span id="cb152-62"><a href="#cb152-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-63"><a href="#cb152-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dW.reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb152-64"><a href="#cb152-64" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-172" class="cell" data-executioninfo="{&quot;elapsed&quot;:298,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653538339278,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="04f23af6-5bac-4662-8025-c8329b9d5358" data-execution_count="96">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>derivs <span class="op">=</span> forward_backward2(W.reshape(<span class="op">-</span><span class="dv">1</span>), x, t, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>derivs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>array([ 2.8791e-03,  7.9160e-03,  1.2443e-02,  1.8509e-05,  1.5168e-06,  4.1280e-05, -4.9747e-02,  6.0737e-03, -4.9872e-02])</code></pre>
</div>
</div>
<ul>
<li>미분하는 함수 <code>forward_backward2</code>와 호출을 동일하게 할 수 있는 목적함수 <code>J2</code> 작성</li>
</ul>
<div id="cell-174" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fmin_cg에서 최적화 시킬 목적함수 f와 도함수 fprime을 동일하게 호출하므로</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 위 코딩한 forward_bacward2와 헤더를 맞춘 목적함수 J2를 만든다.</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> J2(W, X, T, k, l):</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="co">    W: 함숫값을 결정하는 변수, 가중치 (9,)</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="co">    X: 주어진 점 데이터 X, X: (N,D)</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="co">    T: 데이터에 대한 클래스 T, 0 또는 1, T: (N,)</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="co">    k, l : weight, bias가 들어있는 행렬의 모양</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X.shape[<span class="dv">0</span>]</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> W.reshape(k,l)</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 네트워크를 포워드 시키고 적당한 로스 함수를 계산하여 되돌림</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> network(X, W)</span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N)) <span class="op">*</span> ((T<span class="op">-</span>Y)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>최종적으로 <code>W</code>를 다시 초기화 하고 <code>fmin_cg</code>에 역전파 알고리즘을 사용하는 함수 <code>forward_backward2</code>를 도함수로 제공하여 최적화 수행</li>
</ul>
<div id="cell-176" class="cell" data-executioninfo="{&quot;elapsed&quot;:299,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653538682172,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="6a222e9a-cdc3-4061-bbd0-9629d398438b" data-execution_count="98">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>array([[ 0.2763, -1.8546,  0.6239],
       [ 1.1453,  1.0372,  1.8866],
       [-0.1117, -0.3621,  0.1487]])</code></pre>
</div>
</div>
<div id="cell-177" class="cell" data-executioninfo="{&quot;elapsed&quot;:732,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653538688904,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="4981f4e1-0477-4305-d104-19158d613aac" data-execution_count="99">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>W_star_bp <span class="op">=</span> optimize.fmin_cg(J2, W, fprime<span class="op">=</span>forward_backward2, </span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>                          args<span class="op">=</span>(samples, target, <span class="dv">3</span>, <span class="dv">3</span>),  gtol<span class="op">=</span><span class="fl">1e-06</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully.
         Current function value: 0.000005
         Iterations: 459
         Function evaluations: 1851
         Gradient evaluations: 1851</code></pre>
</div>
</div>
<ul>
<li>결과를 확인해보면 거의 동일하게 학습되는 것을 확인할 수 있음</li>
</ul>
<div id="cell-179" class="cell" data-executioninfo="{&quot;elapsed&quot;:269,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653538755125,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="8565a248-7618-4fb9-a3e8-40f652fa7ab6" data-execution_count="100">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>W_star_bp <span class="op">=</span> W_star_bp.reshape(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>W_star_bp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>array([[ 39.3466,  -8.6752, -12.6186],
       [-26.0899,   9.0534,   3.3043],
       [ 17.6746, -40.7086,  40.2004]])</code></pre>
</div>
</div>
<div id="cell-180" class="cell" data-executioninfo="{&quot;elapsed&quot;:485,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1653538799441,&quot;user&quot;:{&quot;displayName&quot;:&quot;조준우&quot;,&quot;userId&quot;:&quot;07581913480846489655&quot;},&quot;user_tz&quot;:-540}" data-outputid="4a8355d3-7054-4973-f83d-5f4dc7683c4d" data-execution_count="101">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">200</span>)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>X1, X2 <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>dcs_bnd_1_imp_ <span class="op">=</span> <span class="kw">lambda</span> x, y: W_star_bp[<span class="dv">0</span>, <span class="dv">1</span>]<span class="op">*</span>x <span class="op">+</span> W_star_bp[<span class="dv">0</span>, <span class="dv">2</span>]<span class="op">*</span>y <span class="op">+</span> W_star_bp[<span class="dv">0</span>, <span class="dv">0</span>] </span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>dcs_bnd_2_imp_ <span class="op">=</span> <span class="kw">lambda</span> x, y: W_star_bp[<span class="dv">1</span>, <span class="dv">1</span>]<span class="op">*</span>x <span class="op">+</span> W_star_bp[<span class="dv">1</span>, <span class="dv">2</span>]<span class="op">*</span>y <span class="op">+</span> W_star_bp[<span class="dv">1</span>, <span class="dv">0</span>] </span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>a, b, c <span class="op">=</span> W_star_bp[<span class="dv">2</span>, <span class="dv">1</span>], W_star_bp[<span class="dv">2</span>, <span class="dv">2</span>], W_star_bp[<span class="dv">2</span>, <span class="dv">0</span>] </span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>o <span class="op">=</span> <span class="kw">lambda</span> x, y: logistic( a<span class="op">*</span>logistic(dcs_bnd_1_imp_(x, y)) </span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>                         <span class="op">+</span> b<span class="op">*</span>logistic(dcs_bnd_2_imp_(x, y)) </span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>                         <span class="op">+</span> c )</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.axes()</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'$x$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'$y$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> o(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>])</span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>pred_pos <span class="op">=</span> pred <span class="op">&gt;=</span> <span class="fl">0.5</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a>pred_neg <span class="op">=</span> pred <span class="op">&lt;</span> <span class="fl">0.5</span></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>ax.contour(X1, X2, o(X1,X2), cmap<span class="op">=</span><span class="st">'gray'</span>, levels<span class="op">=</span>[<span class="fl">0.5</span>])</span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>ax.contourf(X1, X2, o(X1,X2), cmap<span class="op">=</span>cm2, levels<span class="op">=</span>[<span class="op">-</span><span class="dv">10</span>, <span class="fl">0.5</span>, <span class="dv">10</span>], alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a><span class="co"># for positive samples</span></span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_pos)</span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">1</span>, pred_neg)</span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a><span class="co"># for negative samples</span></span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_neg)</span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> np.logical_and(target<span class="op">==</span><span class="dv">0</span>, pred_pos)</span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a><span class="co"># True Positive and True Negative</span></span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TP,<span class="dv">0</span>], samples[TP,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C1'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[TN,<span class="dv">0</span>], samples[TN,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'C6'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, markersize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb162-40"><a href="#cb162-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-41"><a href="#cb162-41" aria-hidden="true" tabindex="-1"></a><span class="co"># False Positive and False Negative</span></span>
<span id="cb162-42"><a href="#cb162-42" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FN,<span class="dv">0</span>], samples[FN,<span class="dv">1</span>], <span class="st">'o'</span>, </span>
<span id="cb162-43"><a href="#cb162-43" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, </span>
<span id="cb162-44"><a href="#cb162-44" aria-hidden="true" tabindex="-1"></a>        markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb162-45"><a href="#cb162-45" aria-hidden="true" tabindex="-1"></a>ax.plot(samples[FP,<span class="dv">0</span>], samples[FP,<span class="dv">1</span>], <span class="st">'^'</span>, </span>
<span id="cb162-46"><a href="#cb162-46" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span><span class="st">'white'</span>, markeredgecolor<span class="op">=</span><span class="st">'k'</span>, </span>
<span id="cb162-47"><a href="#cb162-47" aria-hidden="true" tabindex="-1"></a>        markeredgewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb162-48"><a href="#cb162-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-49"><a href="#cb162-49" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb162-50"><a href="#cb162-50" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb162-51"><a href="#cb162-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-52"><a href="#cb162-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08-neuralnet_autobp_files/figure-html/cell-94-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>